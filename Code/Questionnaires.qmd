---
title: "Questionnaires"
author: "Malte Lund Adamsen"
format: html
editor: visual
---

## Questionnaires

## Packages and options

```{r}
library(renv)
library(readxl)
library(dplyr)
library(here)
library(snakecase)
library(ggplot2)
library(stringr)
library(writexl)
library(LMMstar)
library(plotly)
#install.packages("targets")
#library(targets)
#use_targets()
set.seed(42069)
```

## Choose mITT or PP (or ITT by leaving both F)

```{r}
mITT = T
PP = F
```

## Load data

```{r}
questionnaires.combined.data<-read_excel(path = here("Output",paste0(
                       "Questionnaires_combined.xlsx")))|>
  mutate(
  timepoint = 
    factor(x= timepoint, levels = c("baseline", 
                                   "followup",
                                   "1 month after followup", 
                                   "2 months after followup",
                                   "3 months after followup")))

PP_list <- read_excel(
    path=here("Output","Compliance.xlsx")
  )

questionnaires.combined.data2<-
  questionnaires.combined.data|>
  left_join(PP_list)

linear.mixed.model.list<-
  readRDS(
    file = here(
      "Output",
            paste0(
              "LMM_List", 
              ifelse(PP, "PP", "mITT"),
                ".rds"
        )
      )
    )

questionnaires.combined.data <- questionnaires.combined.data2 |>filter(
  timepoint == "baseline" | timepoint == "followup")|> 
  mutate(
  timepoint = 
    factor(x= timepoint, levels = c("baseline", 
                                   "followup")))
  

questionnaires.combined.data.with.post.followup <- questionnaires.combined.data2|>
#  filter(!is.na(fatigue.mean)) |>
  relocate(id, timepoint, treat)|>arrange(id)
```

## Main Model Fatigue

```{r}
model25.main.fatigue_as_FSS.lmm<-lmm(
  formula = fatigue.mean ~ timepoint+treat:timepoint+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data
)
summary(model25.main.fatigue_as_FSS.lmm, level = 0.975)
plot(model25.main.fatigue_as_FSS.lmm, type=c("qqplot"))
plot(model25.main.fatigue_as_FSS.lmm, type=c("scatterplot"))
linear.mixed.model.list$model25.main.fatigue_as_FSS.lmm<-
  model.tables(model25.main.fatigue_as_FSS.lmm, level =0.975)

if(PP){
  questionnaires.combined.data.PP<-questionnaires.combined.data|>filter(PP)
  
  
  model26.main_PP.fatigue_as_FSS.lmm<-lmm(
  formula = fatigue.mean ~ timepoint+treat:timepoint+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data.PP
)
summary(model26.main_PP.fatigue_as_FSS.lmm)
plot(model26.main_PP.fatigue_as_FSS.lmm, type=c("qqplot"))
plot(model26.main_PP.fatigue_as_FSS.lmm, type=c("scatterplot"))
linear.mixed.model.list$model26.main_PP.fatigue_as_FSS.lmm<-
  model.tables(model26.main_PP.fatigue_as_FSS.lmm, level =0.975)

}


questionnaires.data.no.outlier<-
  questionnaires.combined.data%>%filter(id!="lup_001")

model27.main_no_outlier.fatigue_as_FSS.lmm<-lmm(
  formula = fatigue.mean ~ timepoint+treat:timepoint+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.data.no.outlier
)
summary(model27.main_no_outlier.fatigue_as_FSS.lmm, level = 0.975)

linear.mixed.model.list$model27.main_no_outlier.fatigue_as_FSS.lmm<-
  model.tables(model27.main_no_outlier.fatigue_as_FSS.lmm, level =0.975)

#----------------------------------
#  Interaction Models:
#----------------------------------

model28.interaction_m_1_2.fatigue_as_FSS.lmm<-lmm(
  formula = 
    fatigue.mean ~ timepoint+treat+treat:timepoint+ m_1_2+treat:timepoint:m_1_2+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data
)

summary(model28.interaction_m_1_2.fatigue_as_FSS.lmm, level = 0.975)


model28a.interaction_m_1_2.fatigue_as_FSS.lmm<-lmm(
  formula = 
    fatigue.mean ~ timepoint+treat:timepoint+ m_1_2+treat:m_1_2+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data
)

summary(model28.interaction_m_1_2.fatigue_as_FSS.lmm, level = 0.975)


if(PP){
 model29.interaction_m_1_2_PP.fatigue_as_FSS.lmm<-lmm(
  formula = fatigue.mean ~ timepoint+treat+treat:timepoint+ m_1_2+treat:timepoint:m_1_2+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data.PP
)

summary(model29.interaction_m_1_2_PP.fatigue_as_FSS.lmm, level = 0.975)

linear.mixed.model.list$model29.interaction_m_1_2_PP.fatigue_as_FSS.lmm<-
  model.tables(model29.interaction_m_1_2_PP.fatigue_as_FSS.lmm, level =0.975)

}

model30.interaction_m_1_2_no_outlier.fatigue_as_FSS.lmm<-lmm(
  formula = fatigue.mean ~ timepoint+treat+treat:timepoint+ m_1_2+treat:timepoint:m_1_2+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.data.no.outlier
)

summary(model30.interaction_m_1_2_no_outlier.fatigue_as_FSS.lmm, level = 0.975)

linear.mixed.model.list$model30.interaction_m_1_2_no_outlier.fatigue_as_FSS.lmm<-
  model.tables(model30.interaction_m_1_2_no_outlier.fatigue_as_FSS.lmm, level =0.975)


#----------------------------
#    IFN-El Sherbiny
#----------------------------

model31.interaction_el_sherbiny_IFN1.fatigue_as_FSS.lmm<-lmm(
  formula = fatigue.mean ~ timepoint+treat+treat:timepoint+ ifn_1_el_sherb+treat:timepoint:ifn_1_el_sherb+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data
)

summary(model31.interaction_el_sherbiny_IFN1.fatigue_as_FSS.lmm, level = 0.975)

linear.mixed.model.list$model31.interaction_el_sherbiny_IFN1.fatigue_as_FSS.lmm<-
  model.tables(model31.interaction_el_sherbiny_IFN1.fatigue_as_FSS.lmm, level =0.975)

if(PP){
 model32.interaction_el_sherbiny_IFN1_PP.fatigue_as_FSS.lmm<-lmm(
  formula = fatigue.mean ~ timepoint+treat+treat:timepoint+ ifn_1_el_sherb+treat:timepoint:ifn_1_el_sherb+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data.PP
)

summary(model32.interaction_el_sherbiny_IFN1_PP.fatigue_as_FSS.lmm, level =0.975)

linear.mixed.model.list$model32.interaction_el_sherbiny_IFN1_PP.fatigue_as_FSS.lmm<-
  model.tables(model32.interaction_el_sherbiny_IFN1_PP.fatigue_as_FSS.lmm, level =0.975)


}


#library(lme4)
#lmmodel1 <- lmer(
#  kondital ~ timepoint+treat+treat:timepoint+sex + (1|id),
#                 data=vo2max.data, 
#  REML=T)
#summary(lmmodel1)
#plot(lmmodel1)
#Anova(lmmodel1, type=3)

#lmmodel2 <- lmer(
#  kondital ~ timepoint+treat:timepoint+ m_1_2+treat:timepoint:m_1_2+sex + (1|id),
#                 data=vo2max.data, 
#  REML=T)
#plot(lmmodel2)
#summary(lmmodel2)
#Anova(lmmodel2, type =3)

```

These Models, above, are actually quite interesting, due to the hierarchy we established, that we first wanted to see an effect of exercise, and then wanted to explore whether that effect was caused by a difference in IFN-Genesignature (such as M_1_2). We end up having no significant effect. This is because the group, as a whole gains little improvement, or only a tendency towards lower fatigue with exercise. While there seems to be a benefit in those with a lower m_1_2 z-score than those with high m_1_2 z-score. This is, however, largely driven by a single outlier.

##Let's use a for loop to look at the other IFN-signatures

```{r}
#this checks the other interferon signatures, tnf signature and IL-6 signature, which must be seen as exploratory models.
list_of_scores_to_see_differences_over <- c(
  "m_1_2", 
  "m_1_2_geomean",
  "m_3_4", 
  "m_3_4_geomean",
  "m_5_12", 
  "m_5_12_geomean",
  "ifn_1_el_sherb", 
  "ifn_1_el_sherb_geomean",
  "ifn_2_el_sherb", 
  "ifn_2_el_sherb_geomean",
  "tnf_related", 
  "tnf_related_geomean",
  "il_6_related", 
  "il_6_related_geomean",
  "ifn_alpha_siddiqi",
  "ifn_alpha_siddiqi_geomean",
  "ifn_beta_siddiqi",
  "ifn_beta_siddiqi_geomean",
  "ifn_gamma_siddiqi",
  "ifn_gamma_siddiqi_geomean"   )

list_of_fatigue_ifn_scores<-list()

for (IFNsig in list_of_scores_to_see_differences_over){
  i<-as.character(32+which(list_of_scores_to_see_differences_over==IFNsig))
  model_name <- paste0("model",
                       i,
                       ".interaction_",
                       IFNsig,
                       ".Fatigue.lmm")
  
model2.interaction.fatigue.lmm<-lmm(
  formula = reformulate(paste0("timepoint+treat+treat:timepoint+",IFNsig,"+treat:timepoint:",IFNsig,"+sex"),
                        response="fatigue.mean"),
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data
)

summary(model2.interaction.fatigue.lmm)
plot(model2.interaction.fatigue.lmm, type=c("qqplot"))
plot(model2.interaction.fatigue.lmm, type=c("scatterplot"))

list_of_fatigue_ifn_scores[[model_name]] <- model.tables(model2.interaction.fatigue.lmm, level = 0.975)

}
linear.mixed.model.list$ifn_score_interactions_fatigue<-list_of_fatigue_ifn_scores

if(PP){
for (IFNsig in list_of_scores_to_see_differences_over){
  i<-as.character(51+which(list_of_scores_to_see_differences_over==IFNsig))
  model_name <- paste0("model",
                       i,
                       ".interaction_",
                       IFNsig,
                       ".Fatigue.lmm")
model2.interaction.fatigue.lmm<-lmm(
  formula = reformulate(paste0("timepoint+treat+treat:timepoint+",IFNsig,"+treat:timepoint:",IFNsig,"+sex"),
                        response="fatigue.mean"),
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data.PP
)

summary(model2.interaction.fatigue.lmm)
plot(model2.interaction.fatigue.lmm, type=c("qqplot"))
plot(model2.interaction.fatigue.lmm, type=c("scatterplot"))

list_of_fatigue_ifn_scores_PP[[model_name]] <- model.tables(model2.interaction.fatigue.lmm, level = 0.975)


}
  
  linear.mixed.model.list$list_of_fatigue_ifn_scores_PP<- list_of_fatigue_ifn_scores_PP
}
  
```

## graphics

```{r}

fatigue_m12_quants.plot<-
  plot(model28.interaction_m_1_2.fatigue_as_FSS.lmm, 
     type = "fit", color = "treatment", obs.alpha = 0.5, ci = F,
     time.var = "timepoint", facet = ~ cut_interval(m_1_2, 3))

saveRDS(
  object = fatigue_m12_quants.plot,
  file = here("output","graphics","fatigue_m12_quants.plot.rds")
)

ggsave(
  plot = fatigue_m12_quants.plot$plot,
  filename = here("output","graphics","fatigue_m12_quants.plot.jpg"),
  width = 12
)

## Graphics on change scores:
library(tidyr)
fatigue.data.wide<-questionnaires.combined.data %>% select(id, treatment, timepoint,
                                         fatigue.mean, sex, m_1_2, m_1_2_geomean, m_3_4, m_3_4_geomean, m_5_12, m_5_12_geomean, ifn_1_el_sherb, ifn_1_el_sherb_geomean, ifn_2_el_sherb, ifn_2_el_sherb_geomean, ifn_2_siddiqi, ifn_2_siddiqi_geomean)%>% pivot_wider(
  names_from = "timepoint",
  id_cols = c("id", "treatment", "sex", "m_1_2", "m_1_2_geomean", "m_3_4", "m_3_4_geomean", "m_5_12", "m_5_12_geomean", "ifn_1_el_sherb", "ifn_1_el_sherb_geomean", "ifn_2_el_sherb", "ifn_2_el_sherb_geomean", "ifn_2_siddiqi", "ifn_2_siddiqi_geomean"),
  values_from = c("fatigue.mean")
)%>%mutate(
  delta_fatigue = followup-baseline)

fatigue_by_m.1.2 <- ggplot(fatigue.data.wide, 
                           aes(x = m_1_2, y = delta_fatigue, colour = treatment)) +
  geom_point() +  
  geom_smooth(method="lm", se=T, level = 0.975) + 
        theme_bw() +
  labs(title = "Change in Fatigue by treatment and IFN-\u03B1 score",
       x = "IFN-\u03B1 score",
       y = "\u0394 FSS",
       colour = "Intervention Group")

fatigue_by_m.1.2
ggsave(filename=here("Output","Graphics","fatigue_by_m_1_2.jpg"),
  plot=fatigue_by_m.1.2)

model.delta.fatigue<-lm(delta_fatigue ~ sex + m_1_2 * treatment, data = fatigue.data.wide)
plot(model.delta.fatigue)
summary(model.delta.fatigue)

fatigue.data.wide.no.outlier <- fatigue.data.wide%>%filter(id!="lup_001") #lup001 did probably not understand the questionnaire
fatigue_by_m.1.2_no_outlier <- ggplot(fatigue.data.wide.no.outlier, aes(x = m_1_2, y = delta_fatigue, colour = treatment)) +
  geom_point() +  geom_smooth(method="lm", se=T, level = 0.975) + 
        theme_bw()
fatigue_by_m.1.2_no_outlier
#ggplotly(fatigue_by_m.1.2)

model.delta.fatigue.no.outlier<-lm(delta_fatigue ~ sex + m_1_2 * treatment, data = fatigue.data.wide.no.outlier)
plot(model.delta.fatigue.no.outlier)
summary(model.delta.fatigue.no.outlier)
```

## SF-36 aggregate score models

```{r}
model71.main_effect.SF36Physical.lmm<-lmm(
  formula = physical.component.score ~ timepoint+treat:timepoint+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data
)

plot(model71.main_effect.SF36Physical.lmm, type=c("qqplot"))
plot(model71.main_effect.SF36Physical.lmm, type=c("scatterplot"))
summary(model71.main_effect.SF36Physical.lmm)
#linear.mixed.model.list$model71.main_effect.SF36Physical.lmm <-
 # model.tables(model71.main_effect.SF36Physical.lmm)



model72.interaction.SF36Physical.lmm<-lmm(
  formula = physical.component.score ~ timepoint+treat+treat:timepoint+ m_1_2+treat:timepoint:m_1_2+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data
)

plot(model72.interaction.SF36Physical.lmm, type=c("qqplot"))
plot(model72.interaction.SF36Physical.lmm, type=c("scatterplot"))
summary(model72.interaction.SF36Physical.lmm)
#linear.mixed.model.list$model72.interaction.SF36Physical.lmm <-
 # model.tables(model72.interaction.SF36Physical.lmm)

#effects(model2.interaction.SF36Physical.lmm, variable = "treat") #@Julie: I can't get the effects.lmm to show anything useful, is there a problem in the package or am I just doing silly things with it? I assume it should behave like an EMMEANS object?

model73.main_effect.SF36Mental.lmm<-lmm(
  formula = mental.component.score ~ timepoint+treat:timepoint+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data
)

plot(model73.main_effect.SF36Mental.lmm, type=c("qqplot"))
plot(model73.main_effect.SF36Mental.lmm, type=c("scatterplot"))
summary(model73.main_effect.SF36Mental.lmm)
#linear.mixed.model.list$model73.main_effect.SF36Mental.lmm <-
 # model.tables(model73.main_effect.SF36Mental.lmm)



model74.interaction_effect.SF36Mental.lmm<-lmm(
  formula = mental.component.score ~ timepoint+treat+treat:timepoint+ m_1_2+treat:timepoint:m_1_2+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data
)

plot(model74.interaction_effect.SF36Mental.lmm, type=c("qqplot"))
plot(model74.interaction_effect.SF36Mental.lmm, type=c("scatterplot"))
summary(model74.interaction_effect.SF36Mental.lmm)
#linear.mixed.model.list$model74.interaction_effect.SF36Mental.lmm <-
 # model.tables(model74.interaction_effect.SF36Mental.lmm)
#Minor but statistically significant difference in mental well being based on m_1_2 scores

if(PP){
  model75.interaction_PP.SF36Physical.lmm<-lmm(
  formula = physical.component.score ~ timepoint+treat+treat:timepoint+ m_1_2+treat:timepoint:m_1_2+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data.PP
)
summary(model75.interaction_effect_PP.SF36Mental.lmm)

  model76.interaction_effect_PP.SF36Mental.lmm<-lmm(
  formula = mental.component.score ~ timepoint+treat+treat:timepoint+ m_1_2+treat:timepoint:m_1_2+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data.PP
)
summary(model76.interaction_effect_PP.SF36Mental.lmm)


}
```

##SF-36 loop of exploratory Cytokine transcriptomic Scores. I'm unsure on how I should interpret these results, the difference Z-scores all seem to correlate in some way with the SF_36_Output, but it should definitely be FDR corrected.

```{r}
for (IFNsig in list_of_scores_to_see_differences_over){
model2.interaction.physical.lmm<-lmm(
  formula = reformulate(paste0("timepoint+treat+treat:timepoint+",IFNsig,"+treat:timepoint:",IFNsig,"+sex"),
                        response="physical.component.score"),
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data
)

summary(model2.interaction.physical.lmm)
plot(model2.interaction.physical.lmm, type=c("qqplot"))
plot(model2.interaction.physical.lmm, type=c("scatterplot"))

model2.interaction.mental.lmm<-lmm(
  formula = reformulate(paste0("timepoint+treat+treat:timepoint+",IFNsig,"+treat:timepoint:",IFNsig,"+sex"),
                        response="mental.component.score"),
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data
)

summary(model2.interaction.mental.lmm)
plot(model2.interaction.mental.lmm, type=c("qqplot"))
plot(model2.interaction.mental.lmm, type=c("scatterplot"))

}
```

## Q-Slaq scores

```{r}
model74.main_effect.Qslaq.lmm<-lmm(
  formula = qslaq_score ~ timepoint+treat:timepoint+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data
)

plot(model74.main_effect.Qslaq.lmm, type=c("qqplot"))
plot(model74.main_effect.Qslaq.lmm, type=c("scatterplot"))
summary(model74.main_effect.Qslaq.lmm)
linear.mixed.model.list$model74.main_effect.Qslaq.lmm <-
  model.tables(model74.main_effect.Qslaq.lmm)



model75.interaction_effect.Qslaq.lmm<-lmm(
  formula = qslaq_score ~ timepoint+treat:timepoint+ m_1_2+treat:timepoint:m_1_2+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data
)

plot(model75.interaction_effect.Qslaq.lmm, type=c("qqplot"))
plot(model75.interaction_effect.Qslaq.lmm, type=c("scatterplot"))
summary(model75.interaction_effect.Qslaq.lmm)
linear.mixed.model.list$model75.interaction_effect.Qslaq.lmm <-
  model.tables(model75.interaction_effect.Qslaq.lmm)

model76.main_effect.Qslaq_symptom.lmm<-lmm(
  formula = qslaq_symptom_score ~ timepoint+treat:timepoint+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data
)

plot(model76.main_effect.Qslaq_symptom.lmm, type=c("qqplot"))
plot(model76.main_effect.Qslaq_symptom.lmm, type=c("scatterplot"))
summary(model76.main_effect.Qslaq_symptom.lmm)
linear.mixed.model.list$model76.main_effect.Qslaq_symptom.lmm <-
  model.tables(model76.main_effect.Qslaq_symptom.lmm)



model77.interaction_effect.Qslaq_symptom.lmm<-lmm(
  formula = qslaq_symptom_score ~ timepoint+treat+treat:timepoint+ m_1_2+treat:timepoint:m_1_2+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data
)

plot(model77.interaction_effect.Qslaq_symptom.lmm, type=c("qqplot"))
plot(model77.interaction_effect.Qslaq_symptom.lmm, type=c("scatterplot"))
summary(model77.interaction_effect.Qslaq_symptom.lmm)
#Minor but statistically significant difference in mental well being based on m_1_2 scores

model79.main_effect.slaq_vas.lmm<-lmm(
  formula = sla_qvas ~ timepoint+treat+treat:timepoint+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data
)

plot(model79.main_effect.slaq_vas.lmm, type=c("qqplot"))
plot(model79.main_effect.slaq_vas.lmm, type=c("scatterplot"))
summary(model79.main_effect.slaq_vas.lmm)

model80.interaction_effect.slaq_vas.lmm<-lmm(
  formula = sla_qvas ~ timepoint+treat+treat:timepoint+ m_1_2+treat:timepoint:m_1_2+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data
)

plot(model80.interaction_effect.slaq_vas.lmm, type=c("qqplot"))
plot(model80.interaction_effect.slaq_vas.lmm, type=c("scatterplot"))
summary(model80.interaction_effect.slaq_vas.lmm)
#Minor but statistically significant difference in mental well being based on m_1_2 scores
```

## Exploratory Models

```{r}


model101.main_post_exercise_included.fatigue_as_FSS.lmm<-lmm(
  formula = fatigue.mean ~ timepoint+treat:timepoint+sex,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data.with.post.followup
)
summary(model101.main_post_exercise_included.fatigue_as_FSS.lmm, level = 0.975)
plot(model101.main_post_exercise_included.fatigue_as_FSS.lmm, type=c("qqplot"))
plot(model101.main_post_exercise_included.fatigue_as_FSS.lmm, type=c("scatterplot"))
fatigue_post_plot<-
  plot(model101.main_post_exercise_included.fatigue_as_FSS.lmm, 
     type="fit", obs.alpha=0.25, color = "treatment", ci=F, 
     size.text = 12, at = data.frame(sex="F"))
effects(model101.main_post_exercise_included.fatigue_as_FSS.lmm, 
        type ="identity", variable = "timepoint", conditional = "treat")
effects(model101.main_post_exercise_included.fatigue_as_FSS.lmm, 
        type ="difference", variable = "timepoint",conditional = "treat")

Fatigue_Exploratory_Score_after_Followup<-
  fatigue_post_plot$plot+
  guides(color=guide_legend(title="Treatment Group"))+
  labs(x="timepoint",
       y="FSS",
       title = "Fatigue after followup",
       subtitle = "Exploratory Linear Mixed Model")

ggsave(
  filename= here("Output","Graphics","Fatigue_Exploratory_Score_after_Followup.jpg"),
  plot =Fatigue_Exploratory_Score_after_Followup,
  width = 12
)
#linear.mixed.model.list$model101.main_post_exercise_included.fatigue_as_FSS.lmm<-
 # model.tables(model101.main_post_exercise_included.fatigue_as_FSS.lmm, level =0.975)

model102.post_exercise_interaction_m_1_2.fatigue_as_FSS.lmm<-lmm(
  formula = 
    fatigue.mean ~ timepoint+
                             treat:timepoint:m_1_2,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data.with.post.followup
)

summary(model102.post_exercise_interaction_m_1_2.fatigue_as_FSS.lmm, level = 0.975)
plot(model102.post_exercise_interaction_m_1_2.fatigue_as_FSS.lmm, 
     type="fit", obs.alpha=0.25, color = "m_1_2")
###TODO FIGURE OUT THE CONVERGENCE ISSUE!! Atm we are just trying to use the solution below

library(lme4)

lmer_version<-lmer(
  formula = 
    fatigue.mean ~ timepoint+treat:timepoint+ m_1_2+treat:timepoint:m_1_2+sex+(1|id),
    data = questionnaires.combined.data.with.post.followup
)

library(car)

An_lmer_version<-Anova(lmer_version, type = 3)

summary(lmer_version)


View(questionnaires.combined.data.with.post.followup)

model102.post_exercise_interaction_m_1_2.fatigue_as_FSS.lmm<-lmm(
  formula = 
    fatigue.mean ~ timepoint+
                             treat:timepoint:m_1_2,
  repetition = ~timepoint|id,
  structure = "UN",
  data = questionnaires.combined.data.with.post.followup
)

questionnaires.combined.data<-questionnaires.combined.data|>mutate(
  VAS_fatigue=visuel_analog_træthedsskala_vats_målt_i_mm
)

model.Vas_fatigue_main.lmm<-
  lmm(
    formula = 
      VAS_fatigue ~ timepoint + treat:timepoint+ sex,
    repetition = ~timepoint|id,
    structure = "UN",
    data = questionnaires.combined.data
  )

summary(model.Vas_fatigue_main.lmm)
plot(model.Vas_fatigue_main.lmm, type=c("qqplot"))
plot(model.Vas_fatigue_main.lmm, type=c("scatterplot"))

model.Vas_fatigue_interaction_m12.lmm<-
  lmm(
    formula = 
      VAS_fatigue ~ timepoint + treat:timepoint+m_1_2+treat:timepoint:m_1_2+ sex,
    repetition = ~timepoint|id,
    structure = "UN",
    data = questionnaires.combined.data
  )

summary(model.Vas_fatigue_interaction_m12.lmm)
plot(model.Vas_fatigue_interaction_m12.lmm, type=c("qqplot"))
plot(model.Vas_fatigue_interaction_m12.lmm, type=c("scatterplot"))

model.Vas_pain_main.lmm<-
  lmm(
    formula = 
      pain ~ timepoint + treat:timepoint+ sex,
    repetition = ~timepoint|id,
    structure = "UN",
    data = questionnaires.combined.data
  )

summary(model.Vas_pain_main.lmm)
plot(model.Vas_pain_main.lmm, type=c("qqplot"))
plot(model.Vas_pain_main.lmm, type=c("scatterplot"))

model.Vas_pain_interaction_m12.lmm<-
  lmm(
    formula = 
      pain ~ timepoint + treat:timepoint+m_1_2+treat:timepoint:m_1_2+ sex,
    repetition = ~timepoint|id,
    structure = "UN",
    data = questionnaires.combined.data
  )

summary(model.Vas_pain_interaction_m12.lmm)
plot(model.Vas_pain_interaction_m12.lmm, type=c("qqplot"))
plot(model.Vas_pain_interaction_m12.lmm, type=c("scatterplot"))


```

### Save Modeltabels for aggregation in other file

```{r}
saveRDS(object=linear.mixed.model.list,
    file = here(
      "Output",
            paste0(
              "LMM_List", 
              ifelse(PP, "PP", "mITT"),
                ".rds"
        )
      )
    )

  fatigue_lmm_list <- list(
                          FSS_main = 
                            model.tables(model25.main.fatigue_as_FSS.lmm, level =0.975),
                          FSS_interaction = 
                            model.tables(model28.interaction_m_1_2.fatigue_as_FSS.lmm, level =0.975))
  
  SF36_lmm_list <- list(main_sf36_physical = model.tables(model71.main_effect.SF36Physical.lmm),
                        interaction_sf36_physical = model.tables(model72.interaction.SF36Physical.lmm),
                        main_sf36_mental = model.tables(model73.main_effect.SF36Mental.lmm),
                        interaction_sf36_mental = model.tables(model74.interaction_effect.SF36Mental.lmm))
  
  Qslaq_lmm_list <- list(main_qslaq = model.tables(model74.main_effect.Qslaq.lmm),
                         interaction_qslaq = model.tables(model75.interaction_effect.Qslaq.lmm),
                         main_qslaq.symptom = model.tables(model76.main_effect.Qslaq_symptom.lmm),
                         interaction_qslaq.symptom = model.tables(model77.interaction_effect.Qslaq_symptom.lmm))
  
  PROM_lmm_list <- list(
    VAS_fatigue_main = 
      model.tables(model.Vas_fatigue_main.lmm),
    VAS_fatigue_interaction =
      model.tables(model.Vas_fatigue_interaction_m12.lmm),
    VAS_pain_main = 
      model.tables(model.Vas_pain_main.lmm),
    VAS_pain_interaction =
      model.tables(model.Vas_pain_interaction_m12.lmm)
  )
  


if(PP){
  fatigue_lmm_list_PP <- list(
  FSS_main = model.tables(model26.main_PP.fatigue_as_FSS.lmm, level =0.975),
  FSS_interaction = model.tables(model29.interaction_m_1_2_PP.fatigue_as_FSS.lmm, level =0.975))
  
  SF36_lmm_list_PP <- list(interaction_sf36_physical_PP = model.tables(model75.interaction_PP.SF36Physical.lmm),
                        interaction_sf36_mental_PP = model.tables(model76.interaction_effect_PP.SF36Mental.lmm))
  
  saveRDS(object = fatigue_lmm_list_PP,
           file = here("Output","LMMlists","Fatigue_LMM_List_PP.rds"))
  
  saveRDS(object = SF36_lmm_list_PP,
           file = here("Output","LMMlists","SF36_lmm_list_PP.rds"))
  
}
  
saveRDS(object = fatigue_lmm_list,
           file = here("Output","LMMlists","Fatigue_LMM_List.rds"))
  
saveRDS(object = SF36_lmm_list,
           file = here("Output","LMMlists","SF36_lmm_list.rds"))

saveRDS(object = Qslaq_lmm_list,
           file = here("Output","LMMlists","Qslaq_lmm_list.rds"))

PROM_lmm_list|>saveRDS(
  file = here("Output","LMMlists","prom_lmm_list.rds"))

```

## The End

```{r}
print("This is the end of Questionnaires.qmd")
```
