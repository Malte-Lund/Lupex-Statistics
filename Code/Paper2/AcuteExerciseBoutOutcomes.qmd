---
title: "AcuteExerciseBoutOutcomes"
format: html
editor: visual
---

# Acute Exercise Bout analysis

## Loading packages - Setting options

```{r}
options(scipen = 10)
#library(renv)
#renv::init()
#install.packages("readxl")
#install.packages("beepr")
library(beepr)
library(lme4)
library(car)
library(lmerTest)
library("readxl")
library(dplyr)
library(tidyr)
library(here)
library(snakecase)
library(ggplot2)
library(stringr)
library(writexl)
#renv::install("table1")
library(table1)
#renv::install("flextable")
#renv::install("officer")
library(flextable)
library(butils)
#install.packages("targets")
#library(targets)
#use_targets()
set.seed(42069)
#renv::install("DescTools")
library(DescTools)
library(LMMstar)
library(plotly)
library(multcomp)
library(beepr)
library(officer)
library(table1)

#set_here(path="C:/Users/mada0011/Desktop/Offline Statistics/Lupex-Statistics")
here::i_am("Code/Paper2/AcuteExerciseBoutOutcomes.qmd")


##We need this function, a silly way of writing 2^X, when we start messing with transforming back and forth between logarithmic variables for the blood sample measurements.

back2 <- function(x){
  2^x
}
```

## Choose mITT, PP or ITT (by leaving both F)

```{r}
mITT = T
PP = F

#IF you have full access to the data set this to true, if you do not have full access and this is not set to false, the code will not work
fullaccess = T

```

## Import Data

```{r}
Bloodsample.wide<-read_excel(path = here("Data",
                       "Bloodsamples.data.wide.xlsx"))%>%
  mutate(
  timepoint_during_day = case_when(
    grepl("acute bout",timepoint) ~ "Acute Bout",
    T ~
      case_when(
      time_from_t0 <  10 ~ "t0",
      time_from_t0 <  25 ~ "t1",
      time_from_t0 <  55 ~ "t2",
      time_from_t0 <  85 ~ "t3",
      time_from_t0 < 105 ~ "t4",
      time_from_t0 < 150 ~ "t5",
      T ~ NA_character_
    )
  )
)

View(Bloodsample.wide)

Bloodsamples_Lene_IFNa_IL6r <-
  read_excel(
    path = here("data","Fra Lene","Reduced_Info_Results_IFNa_IL-6R.xlsx")
  )|>
  separate_wider_delim(
    col=Rækkemærkater,
    names=c("IDNO","TimepointAB","TimeWithinDay"),
    delim = "_")|>
  mutate(
    id = paste0("lup_",IDNO),
    timepoint = case_when(
      TimepointAB == "A" ~ 
        case_when(
          TimeWithinDay == "Base" ~"baseline",
                                 T~"baseline - acute bout"),
      TimepointAB == "B" ~ 
        case_when(
          TimeWithinDay == "Base" ~"followup",
                                 T~"followup - acute bout"),
      T~NA_character_
    ),
    time_within_day = case_when(
      TimeWithinDay == "Base" ~ "0",
      T~as.character(as.numeric(TimeWithinDay))
  ), .keep = "unused")|>
  relocate(id,timepoint,time_within_day)

Bloodsamples_Lene_IFNg_Proinfpanel <-
  read_excel(
    path = here("data","Fra Lene","Reduced_Info_Results_IFN_Gamma_Pro_Inf.xlsx")
  )|>
  separate_wider_delim(
    col=Rækkemærkater,
    names=c("IDNO","TimepointAB","TimeWithinDay"),
    delim = "_")|>
  mutate(
    id = paste0("lup_",IDNO),
    timepoint = case_when(
      TimepointAB == "A" ~ 
        case_when(
          TimeWithinDay == "Base" ~"baseline",
                                 T~"baseline - acute bout"),
      TimepointAB == "B" ~ 
        case_when(
          TimeWithinDay == "Base" ~"followup",
                                 T~"followup - acute bout"),
      T~NA_character_
    ),
    time_within_day = case_when(
      TimeWithinDay == "Base" ~ "0",
      T~as.character(as.numeric(TimeWithinDay))
  ), .keep = "unused")|>
  relocate(id,timepoint,time_within_day)

group_cytokine <- 
  read_excel(path = here("Data","grouping_cytokine.xlsx"))

sex.data <- 
  read_excel(path =  here("Data","vo2max.xlsx"))|>
  dplyr::filter(timepoint == "baseline")|>
  dplyr::select(id, sex)

df_acute_bout_pulse<-
  read_excel(path = (here("Data", "Acute Bout", "Acute_bout_data.xlsx")))
  
                          
```

## Data Wrangling

```{r}

not_all_na <- 
  function(x) any(!is.na(x))

Bloodsample.acute.bout<-
  Bloodsample.wide|>
  dplyr::filter(timepoint_during_day == "Acute Bout")|>
  dplyr::select(where(not_all_na))|>
  group_by(id,timepoint)|>
  mutate(
    order_within_day = 
      case_when(  id=="lup_017" & 
                  timepoint == "baseline - acute bout" ~ 
                    order_within_day-1,
                  T~order_within_day),
    time_within_day = 
      case_when(
        order_within_day == 1  ~ "-5",
        order_within_day == 2  ~ "0",
        order_within_day == 3  ~ "10",
        order_within_day == 4  ~ "14",
        order_within_day == 5  ~ "35",
        order_within_day == 6  ~ "45",
        order_within_day == 7  ~ "60",
        order_within_day == 8  ~ "90",
        order_within_day == 9  ~ "105",
        order_within_day == 10 ~ NA_character_,
        T  ~ NA_character_
      ))|>
  rename(
     Hemoglobin   = `Hæmoglobin;B`,
     Leukocytes   = `Leukocytter;B`,
     Thrombocytes = `Trombocytter;B`,
     Erythrocytes = `Erytrocytter;B`,
     Erythrocyte_volume_frequency = `Erytrocytter, vol.fr.;B`,
     Mean_Erythrocyte_Volume_MCV = `Erytrocytvolumen (middel) [MCV];B`,
     Hemoglobin_Content_MCH = `Hæmoglobinindhold [MCH];Erc(B)`,
     Hemoglobin_Mean_contenct_MCH=`Hæmoglobin [MCHC];Erc(B)`,
     Basophilocytes = `Basofilocytter;B`,
     Eosinophilocytes = `Eosinofilocytter;B`,
     Lymphocytes = `Lymfocytter;B`,
     Metamyelo_Myelo_promyelocytes = `Metamyelo.+Myelo.+Promyelocytter;B`,
     Monocytes = `Monocytter;B`,
     Neutrophilocytes=`Neutrofilocytter;B`,
     Ferritin = `Ferritin;P`,
     Potassium = `Kalium;P`,
     Sodium = `Natrium;P`,
     Creatinine = `Kreatinin;P`,
     eGFR = `eGFR / 1,73m² (CKD-EPI)`,
     Albumin = `Albumin;P`,
     INR = `Koagulationsfaktor II+VII+X [INR];P`,
     Coagulationfactor_II_VII_X =`Koagulationsfaktor II+VII+X;P`,
     ALAT = `Alanintransaminase [ALAT];P`,
     Alkalic_Phosphatase = `Basisk fosfatase;P`,
     Bilirubin =`Bilirubiner;P`,
     Creatine_Kinase = `Kreatinkinase;P`,
     proBNP = `Pro-brain natriuretisk pept. [proBNP];P`,
     Myoglobin = `Myoglobin;P`,
     Hemoglobin_a1c = `Hæmoglobin A1c (IFCC);Hb(B)`,
     Glucose_Mean_from_HBA1C = `Glukose, middel (fra HbA1c);P`,
     Total_Cholesterol = `Kolesterol;P`,
     HDL_Cholesterol = `Kolesterol HDL;P`,
     LDL_Cholesterol = `Kolesterol LDL;P`,
     VLDL_Cholesterol = `Kolesterol VLDL;P`,
     HS_CRP = `C-reaktivt protein [HSCRP];P`,
     Beta2Mikroglobuline = `beta-2-Mikroglobulin;P`,
     Complement_C3 = `Complement C3;P`,
     Complement_C4 = `Complement C4;P`,
     DsDNA = `DNA (dobbeltstrenget)-IgG;P`,
     Cardiolipin_IgG = `Cardiolipin-IgG;P`,
     Cardiolipin_IgM = `Cardiolipin-IgM;P`,
     CRP = `C-reaktivt protein [CRP];P`,
     T_Lymphocytes = `T-lymphocytter;B`,
     T_Lymphocytes_Helper = `T-lymphocytter (helper);B`,
     T_Lymphocytes_Cytotoxic = `T-lymphocytter (cytotox.);B`,
     T_Lymphocytes_Helper_Slash_Cytotoxic = `T-lymphocyt (helper/cytotox);Lymc(B)`,
     B_Lymphocytes = `B-lymphocytter;B`,
     NK_Lymphocytes = `NK-Lymfocytter;B`,
     B_Lymphocytes_Mature = `B-lymphocytter (mature);B`,
     Basephilocytes_Microscopic_review = `Basofilocytter (mikr.);B`,
     BlastCells = `Blastceller (uspec.);B`,
     Eosinophils_Microscopic_review = `Eosinofilocytter (mikr.);B`,
     Leukocytes_Unspecified= `Leukocytter (uspec.);B`,
     Lymphocytes_Microscopic_review = `Lymfocytter (mikr.);B`,
     Metamyelocytes_Microscopic_review = `Metamyelocytter;B`,
     Monocytes_Microscopic_review = `Monocytter (mikr.);B`,
     Myelocytes_Microscopic_review = `Myelocytter;B`,
     Neutophilocytes_Microscopic_review = `Neutrofilocytter (mikr.);B`,
     Smudge_cells_Microscopic_review = `Smudge celler;B`,
     Plasmocytes_Microscopic_review = `Plasmocytter;B`,
     Promyelocytes_Microscopic_review = `Promyelocytter;B`,
     T_lymphocytes_cd4_Microscopic_review = `T-lymfocytter(CD4+);B`,
     T_lymphocytes_Cytotoxic_Microscopic_review = `T-lymfocytter(cytotox.);B`,
     T_lymphocytes_help_slash_cytotoxic_Microscopic_review = `T-lymfocyt(helper/cytotox);Lymc(B)`,
     Albumin_Creatinine_Ratio_Urine = `Albumin / Kreatinin-ratio;U`,
     Albumin_urine=`Albumin;U`,
     Urine_Collection_Time = `Urinopsamlingstid;Pt`,
     Volume_Urine = `Volumen;Pt(U)`,
     Reticulocytes_Microscopic_review = `Reticulocytter;B`,
     Reticulocytes = `Reticulocytter;Erc(B)`,
     Iron_Plasma = `Jern;P`,
     Transferrin = `Transferrin;P`,
     Transferrin_saturation = `Transferrin-mætning;P`,
     Vitamin_B12 = `Vitamin B12;P`,
     Folic_Acid = `Folat;P`,
     Lupus_Anti_Coagulant = `Lupus antikoagulans;P`,
     Amylase = `Amylase, pancreastype;P`,
     Protein_Creatinine_Ratio_Urine =  `Protein / Kreatinin-ratio;U`,
     Protein_Urine = `Protein;U`,
     Beta_2_Glycoprotein = `beta-2-Glykoprotein 1-IgG;P`)|>
  relocate(
    id, timepoint, time_within_day, time_from_t0, Hemoglobin, Leukocytes, Erythrocytes)|>
  rowwise()|>
  mutate(
    T_Lymphocytes_Cytotoxic = case_when(is.na(T_Lymphocytes_Cytotoxic)~T_lymphocytes_Cytotoxic_Microscopic_review,
                                  is.na(T_lymphocytes_Cytotoxic_Microscopic_review)~T_Lymphocytes_Cytotoxic,
                                  T~(T_Lymphocytes_Cytotoxic+T_lymphocytes_Cytotoxic_Microscopic_review)/2))

```

## Joined data set

```{r}
Bloodsample_Joined<-
  Bloodsample.acute.bout|>
  left_join(
    Bloodsamples_Lene_IFNa_IL6r,
    by = join_by(id, timepoint, time_within_day)
  )|>
  left_join(
    Bloodsamples_Lene_IFNg_Proinfpanel,
    by = join_by(id, timepoint, time_within_day)
  )|>
  dplyr::filter(
    !is.na(
      time_within_day
    )
  )|>
  left_join(group_cytokine)|>
  mutate(
    treat = case_when(
      grepl("baseline",timepoint) ~ "control",
      T ~ treatment
    )
  )|>
  left_join(
    sex.data
  )


Acute_Bout_Data <-
  Bloodsample_Joined|>
  dplyr::filter(
      timepoint =="baseline - acute bout" | 
      timepoint =="followup - acute bout" 
  )|>
  mutate(
    `CRP Calc. Conc. Mean (pg/mL)` = case_when(
      is.na(`CRP % CV`)~NA_real_,
      `CRP % CV`>20~NA_real_,
      T~`CRP Calc. Conc. Mean (pg/mL)`),
    `IFN-a Calc. Conc. Mean (pg/mL)` = case_when(
      is.na(`IFN-a %CV`)~NA_real_,
      `IFN-a %CV`>20~NA_real_,
      T~`IFN-a Calc. Conc. Mean (pg/mL)`),
    `IL-6R Calc. Conc. Mean (pg/mL)` = case_when(
      is.na(`IL-6R %CV`)~NA_real_,
      `IL-6R %CV`>20~NA_real_,
      T~`IL-6R Calc. Conc. Mean (pg/mL)`),
    `IFN-gamma Calc. Conc. Mean (pg/mL)` = case_when(
      is.na(`IFN-Gamma % CV`)~NA_real_,
      `IFN-Gamma % CV`>20~NA_real_,
      T~`IFN-gamma Calc. Conc. Mean (pg/mL)`),
    `IL-10 Calc. Conc. Mean (pg/mL)` = case_when(
      is.na(`IL-10 % CV`)~NA_real_,
      `IL-10 % CV`>20~NA_real_,
      T~`IL-10 Calc. Conc. Mean (pg/mL)`),
    `IL-1a Calc. Conc. Mean (pg/mL)` = case_when(
      is.na(`IL1a - % CV`)~NA_real_,
      `IL1a - % CV`>20~NA_real_,
      T~`IL-1a Calc. Conc. Mean (pg/mL)`),
    `IL-1RA Calc. Conc. Mean (pg/mL)` = case_when(
      is.na(`IL-1RA % CV`)~NA_real_,
      `IL-1RA % CV`>20~NA_real_,
      T~`IL-1RA Calc. Conc. Mean (pg/mL)`),
    `IL-2 Calc. Conc. Mean (pg/mL)` = case_when(
      is.na(`IL-2 % CV`)~NA_real_,
      `IL-2 % CV`>20~NA_real_,
      T~`IL-2 Calc. Conc. Mean (pg/mL)`),
    `IL-6 Calc. Conc. Mean (pg/mL)` = case_when(
      is.na(`IL-6 % CV`)~NA_real_,
      `IL-6 % CV`>20~NA_real_,
      T~`IL-6 Calc. Conc. Mean (pg/mL)`),
    `TNF Calc. Conc. Mean (pg/mL)` = case_when(
      is.na(`TNF % CV`)~NA_real_,
      `TNF % CV`>20~NA_real_,
      T~`TNF Calc. Conc. Mean (pg/mL)`),
    log2CRP = log(`CRP Calc. Conc. Mean (pg/mL)`, base = 2),
    crp_mg_ml = `CRP Calc. Conc. Mean (pg/mL)`/1000000,
    time_within_day = factor(time_within_day,
      levels = c("-5","0","10","14","35","45","60","90","105")
    ),
    continous_time_within_day = time_within_day|>as.character()|>as.numeric(),
    timepoint_time_within_day = paste0(timepoint, "_", time_within_day)
  )

snake_case_Acute_Bout_Data <-
    Acute_Bout_Data
  
  colnames(snake_case_Acute_Bout_Data)<-
    to_snake_case(colnames(Acute_Bout_Data))
  
  snake_case_Acute_Bout_Data<-
    snake_case_Acute_Bout_Data %>%
    mutate(treat2 =factor(
      case_when(
      grepl("baseline",x=timepoint)~"baseline",
      T~treat), levels = c("baseline", "control","exercise")))
  
  snake_case_Acute_Bout_Data%>%
    group_by(id, treat2)%>%
    slice(1)%>%
    ggplot(aes(x=ifn_1_netto, fill = treat2))+
    geom_histogram()
  
  snake_case_Acute_Bout_Data%>%
    group_by(id)%>%
    slice(1)%>%
    ggplot(aes(x=ifn_1_netto, fill = treatment))+
    geom_histogram()
```

## Table 1

```{r}
t1<-
  snake_case_Acute_Bout_Data%>%
  dplyr::filter(
    treat2 = "baseline"
  )
  group_by(id, timepoint)%>%
  slice(1)%>%
  table1::table1(
    x  = 
      ~ sex | treatment 
    data = .
  )
```

## Graphical Rendition of Interesting Data

```{r}
CRP_3011vsLene<-
  Acute_Bout_Data|>
  ggplot(
  aes(
    x=crp_mg_ml,
    y=HS_CRP))+
  geom_point()

CRP_3011vsLene
model_crp_diff <-
  lm(
    crp_mg_ml~HS_CRP,
    data = Acute_Bout_Data
  )
plot(model_crp_diff)
summary(model_crp_diff)

CRP_during_ex_graph<-
  Acute_Bout_Data|>
  ggplot(
  aes(
    x = time_within_day,
    y = crp_mg_ml,
    label = id,
    color = treat
    )
  )+
  geom_point()+
  facet_wrap(
    ~timepoint
  )

ggplotly(CRP_during_ex_graph)

Thromb_during_ex_time_cont_graph<-
  Acute_Bout_Data|>
  ggplot(
  aes(
    x = continous_time_within_day,
    y = Thrombocytes,
    group = id,
    label = id,
    color = treat
    )
  )+
  geom_point(position = "dodge")+
  geom_line()+
  facet_wrap(
    ~timepoint
  )


ggplotly(Thromb_during_ex_time_cont_graph)

Thromb_during_ex_graph<-
  Acute_Bout_Data|>
  ggplot(
  aes(
    x = time_within_day,
    y = Thrombocytes,
    group = id,
    label = id,
    color = treat
    )
  )+
  geom_point(position = "dodge")+
  geom_line()+
  facet_wrap(
    ~timepoint
  )

  Acute_Bout_Data|>
  group_by(timepoint, time_within_day, treat)


  cont_IL6_plot<-
  snake_case_Acute_Bout_Data %>%
  mutate(treat_time =
           case_when(
             grepl("baseline",timepoint) ~ "baseline",
             grepl( "followup",timepoint) ~ paste0("followup", treatment),
             T~NA_character_
           ),
         id_time = paste0(id,"_",timepoint))%>%
  ggplot(aes(x = continous_time_within_day, 
             y = il_6_calc_conc_mean_pg_m_l, 
              
             col = treat_time))+
  geom_point()+
   # geom_line(aes(group = id_time))+
  stat_smooth(mapping = aes(x=continous_time_within_day, 
                                            y = il_6_calc_conc_mean_pg_m_l, 
                                            col = treat_time))+  
    theme_bw()
  
  cont_IL6_plot
  
```

## Calculate Summary Statistics

```{r}
variables_to_summarize<-c("hemoglobin", "leukocytes","erythrocytes","thrombocytes","erythrocyte_volume_frequency",
                          "mean_erythrocyte_volume_mcv", "hemoglobin_content_mch", "hemoglobin_mean_contenct_mch",
                          "basophilocytes","eosinophilocytes", "lymphocytes", "metamyelo_myelo_promyelocytes",
                          "monocytes", "neutrophilocytes", "ferritin" , "potassium" ,"sodium", "creatinine" , "e_gfr",
                          "albumin", "inr", "coagulationfactor_ii_vii_x" , "alat", "alkalic_phosphatase", "bilirubin",
                          "creatine_kinase", "pro_bnp", "myoglobin" , "hemoglobin_a_1_c", "glucose_mean_from_hba_1_c" ,
                          "total_cholesterol","hdl_cholesterol","ldl_cholesterol", "vldl_cholesterol" , "hs_crp",
                          "complement_c_3", "complement_c_4", "ds_dna" , "cardiolipin_ig_g", "cardiolipin_ig_m" ,"crp",
                          "t_lymphocytes", "t_lymphocytes_helper", "t_lymphocytes_cytotoxic",
                          "t_lymphocytes_helper_slash_cytotoxic" , "b_lymphocytes", "nk_lymphocytes" ,
                          "b_lymphocytes_mature", "basephilocytes_microscopic_review", "blast_cells" ,
                          "eosinophils_microscopic_review", "leukocytes_unspecified", "lymphocytes_microscopic_review",
                          "metamyelocytes_microscopic_review", "monocytes_microscopic_review",
                          "myelocytes_microscopic_review", "neutophilocytes_microscopic_review",
                          "smudge_cells_microscopic_review", "plasmocytes_microscopic_review" ,
                          "promyelocytes_microscopic_review","t_lymphocytes_cd_4_microscopic_review",
                          "t_lymphocytes_cytotoxic_microscopic_review",
                          "t_lymphocytes_help_slash_cytotoxic_microscopic_review", 
                          "reticulocytes_microscopic_review" , "reticulocytes" ,"iron_plasma", "transferrin",
                          "transferrin_saturation", "vitamin_b_12", "folic_acid",
                          "amylase", "beta_2_glycoprotein", "ifn_a_calc_conc_mean_pg_m_l", "il_6_r_calc_conc_mean_pg_m_l",
                          "crp_calc_conc_mean_pg_m_l", "ifn_gamma_calc_conc_mean_pg_m_l" ,"il_10_calc_conc_mean_pg_m_l",
                          "il_1_a_calc_conc_mean_pg_m_l", "il_1_ra_calc_conc_mean_pg_m_l" , "il_2_calc_conc_mean_pg_m_l",
                          "il_6_calc_conc_mean_pg_m_l", "tnf_calc_conc_mean_pg_m_l","beta_2_mikroglobuline","crp_mg_ml")

log2_snake_case_Acute_Bout_Data<-
  snake_case_Acute_Bout_Data|>
  mutate(
    across(
      variables_to_summarize, log2
    )
  )
  


sum_stat_loop_init <-
  LMMstar::summarize(  formula=
                                    reformulate(termlabels = "timepoint + treat + time_within_day", 
                                                response = paste0(variables_to_summarize[1],"+",variables_to_summarize[2]), 
                                                intercept = TRUE, env = parent.frame()),
                                   data = snake_case_Acute_Bout_Data, na.rm=T)

sum_stat_loop<-
  sum_stat_loop_init

sum_stat_loop_wide<-
  sum_stat_loop_init%>%
  mutate(mean_sd = paste0(round(mean,1), "\u00B1",round(sd,1)),
         median_q1q3 = paste0(round(median,1), "[",round(q1,1),";",round(q3,1),"]"))%>%
  pivot_wider(
    id_cols = c(outcome, timepoint, treat),
    names_from = time_within_day,
    values_from= c(observed : median_q1q3)
  )
for(variable in variables_to_summarize[-c(1:2)]  ){
  sum_sub <- LMMstar::summarize(  formula=
                                    reformulate(termlabels = "timepoint + treat + time_within_day", 
                                                response = variable, intercept = TRUE, env = parent.frame()),
                                   data = snake_case_Acute_Bout_Data, na.rm=T)
  
  sum_stat_loop<-
    rbind(sum_stat_loop,
        sum_sub)
  
  sum_sub_wide <-
    sum_sub%>%
  mutate(mean_sd = paste0(round(mean,1), "\u00B1",round(sd,1)),
         median_q1q3 = paste0(round(median,1), "[",round(q1,1),";",round(q3,1),"]"))%>%
  pivot_wider(
    id_cols = c(outcome, timepoint, treat),
    names_from = time_within_day,
    values_from= c(observed : median_q1q3)
  )
  
  sum_stat_loop_wide<-
    sum_stat_loop_wide%>%
      rbind(sum_sub_wide)
}
sum_stat_wide_baseline<-
  sum_stat_loop_wide%>%
  dplyr::filter(
    timepoint=="baseline - acute bout")

sum_stat_wide_baseline%>%
  write_xlsx(
    path = here(
      "output", "acute bout", "blood samples baseline wide.xlsx"
    )
  )
```

##Log 2 conversion, scaling, backconversion Scaling doesn't seem to work, I should probably have done it before log-transformation.

```{r eval = F}
#And if we scale we can get the plots on the same levels.
log2_scaly_snake_case_Acute_Bout_Data<-
  log2_snake_case_Acute_Bout_Data|>
  mutate(
    across(
      variables_to_summarize, scale
    )
  )


log2_scale_sum_stat_loop_init <-
  LMMstar::summarize(  formula=
                                    reformulate(termlabels = "timepoint + treat + time_within_day", 
                                                response = paste0(variables_to_summarize[1],"+",variables_to_summarize[2]),
                                                intercept = TRUE, env = parent.frame()),
                                   data = log2_scaly_snake_case_Acute_Bout_Data, na.rm=T)

log2_scale_sum_stat_loop<-
  log2_scale_sum_stat_loop_init

for(variable in variables_to_summarize[-c(1:2)]  ){
  sum_sub <- LMMstar::summarize(  formula=
                                    reformulate(termlabels = "timepoint + treat + time_within_day", 
                                                response = variable, intercept = TRUE, env = parent.frame()),
                                   data = log2_scaly_snake_case_Acute_Bout_Data, na.rm=T)
  
  log2_scale_sum_stat_loop<-
    rbind(log2_scale_sum_stat_loop,
        sum_sub)
}

back_convert_log2_scale_sum_stat_loop<-
  log2_scale_sum_stat_loop|>
  rowwise()|>
  mutate(
    across( c(mean:max), ~ 2^.x))

back_convert_log2_scale_sum_stat_loop|>
  dplyr::filter(
    outcome == "hs_crp" | outcome=="il_6_calc_conc_mean_pg_m_l"
  )|>
  ggplot(
  aes(
    x = time_within_day,
    y = mean,
    group = treat,
    color = treat,
    shape = outcome
    )
  )+
    ylab("crp")+
  geom_point(position = position_dodge(0.05))+
  geom_line(position = position_dodge(0.05))+
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd, width=.2),
                 position=position_dodge(0.05))+
  facet_wrap(
    ~timepoint
  )
  
```

```{r}
Thromb_during_ex_graph_sum_stat<-
  sum_stat_loop|>
  dplyr::filter(
    outcome == "thrombocytes"
  )|>
  ggplot(
  aes(
    x = time_within_day,
    y = mean,
    group = treat,
    color = treat
    )
  )+
  geom_point(position = "dodge")+
  geom_line()+
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), 
                width=.2,
                 position="identity")+
  facet_wrap(
    ~timepoint
  )
Thromb_during_ex_graph_sum_stat


#


IL6r.plot<-
  Acute_Bout_Data|>
  ggplot(
    aes(
      x = time_within_day,
      y = `IL-6R Calc. Conc. Mean (pg/mL)`,
      color = treat,
      group = id
    ))+
  facet_wrap(
    facets = ~timepoint)+
  geom_point()+
  geom_line()

IL6r.plot|>
  ggplotly()

```

## Models on acute bout outcomes

## Combined Models

```{r}

log2_snake_case_Acute_Bout_Data_combined<-
  log2_snake_case_Acute_Bout_Data%>%
  mutate(
    id_timepoint = case_when(
      grepl("baseline",x=timepoint)~paste0(id, "_baseline"),
      grepl("follow",x=timepoint)~paste0(id, "_followup"),
      T ~ NA_character_),
    treat2 =factor(
      case_when(
      grepl("baseline",x=timepoint)~"baseline",
      T~treat), levels = c("baseline", "control","exercise")),
    time_wd_glht= as.factor(case_when(time_within_day=="-5" ~ "min5",
                                    T ~ time_within_day)#,
                        #levels = c("min5,0,10,14,35,45,60,90,105")
    )
  )
```

```{r il6 eval = F}

combined_lmm_list <- list()
log2_IL_6_Acute_bout_main<-
lmm(
  formula = 
    il_6_calc_conc_mean_pg_m_l ~ 
    sex+
    time_wd_glht+
    treat2+
    treat2:time_wd_glht,
    #timepoint_time_wd_glht+
    #timepoint_time_wd_glht:treat,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_IL_6_Acute_bout_main)
  plot(log2_IL_6_Acute_bout_main, type = "qqplot")
  plot(log2_IL_6_Acute_bout_main, type = "scatterplot")
  log2_IL_6_Acute_bout_main_plot<-
    plot(log2_IL_6_Acute_bout_main, type = "fit",
       obs.alpha = 0.25, color = "treat2", ci = F, at = data.frame(sex = "F"))
  
  pretty_plot_log2_il6<-
    log2_IL_6_Acute_bout_main_plot$plot+
    labs(
      y = "log2 (IL-6 pg/ml)",
      x = "time during bout"
    )
  
    ggsave(
      filename =here("output","graphics","acute bout data","log_IL_6_lmm_plot.jpg"),
      plot = pretty_plot_log2_il6
    )
    
    ##Test:
    log2_snake_case_Acute_Bout_Data_combined<-
      log2_snake_case_Acute_Bout_Data_combined %>%mutate(
        time_wd_id = factor(paste0(time_wd_glht, id))
      )
    log2_IL_6_Acute_bout_test<-
lmm(
  formula = 
    il_6_calc_conc_mean_pg_m_l ~ 
    sex+
    time_wd_glht+
    treat+
    timepoint+
    treat:time_wd_glht+
    treat:timepoint+
    treat:timepoint:time_wd_glht,
    #timepoint_time_wd_glht+
    #timepoint_time_wd_glht:treat,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_IL_6_Acute_bout_test)
    
combined_lmm_list[[1]]<-
  log2_IL_6_Acute_bout_main 

    log2_IL_6_Acute_bout_interaction<-
lmm(
  formula = 
    il_6_calc_conc_mean_pg_m_l ~ 
    sex+
    ifn_1_netto+
    time_wd_glht+
    time_wd_glht:ifn_1_netto+
    treat2+
    treat2:time_wd_glht+
    treat2:time_wd_glht:ifn_1_netto,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_IL_6_Acute_bout_interaction)
  plot(log2_IL_6_Acute_bout_interaction, type = "qqplot")
  plot(log2_IL_6_Acute_bout_interaction, type = "scatterplot")
 # log2_IL_6_Acute_bout_interaction_plot<-
  #  plot(log2_IL_6_Acute_bout_main, type = "fit",
   #    obs.alpha = 0.25, color = "ifn_1_netto", ci = F, at = data.frame(sex = "F"))

  combined_lmm_list[[2]]<-
  log2_IL_6_Acute_bout_interaction
```

```{r eval =F}
log2_IL_6_r_Acute_bout_main<-
lmm(
  formula = 
    il_6_r_calc_conc_mean_pg_m_l ~ 
    sex+
    time_wd_glht+
    treat2+
    treat2:time_wd_glht,
    #timepoint_time_wd_glht+
    #timepoint_time_wd_glht:treat,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_IL_6_r_Acute_bout_main)
  plot(log2_IL_6_r_Acute_bout_main, type = "qqplot")
  plot(log2_IL_6_r_Acute_bout_main, type = "scatterplot")
  log2_IL_6_r_Acute_bout_main_plot<-
    plot(log2_IL_6_r_Acute_bout_main, type = "fit",
       obs.alpha = 0.25, color = "treat2", ci = F, at = data.frame(sex = "F"))    

 combined_lmm_list[[3]]<-
  log2_IL_6_r_Acute_bout_main 
      
    
  log2_IL_6r_Acute_bout_interaction<-
lmm(
  formula = 
    il_6_r_calc_conc_mean_pg_m_l ~ 
    sex+
    ifn_1_netto+
    time_wd_glht+
    time_wd_glht:ifn_1_netto+
    treat2+
    treat2:time_wd_glht+
    treat2:time_wd_glht:ifn_1_netto,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_IL_6r_Acute_bout_interaction)
  plot(log2_IL_6r_Acute_bout_interaction, type = "qqplot")
  plot(log2_IL_6r_Acute_bout_interaction, type = "scatterplot")
  #log2_IL_6r_Acute_bout_interaction_plot<-
   # plot(log2_IL_6r_Acute_bout_interaction, type = "fit",
    #   obs.alpha = 0.25, color = "ifn_1_netto", ci = F, at = data.frame(sex = "F"))

 combined_lmm_list[[4]]<-
  log2_IL_6r_Acute_bout_interaction

      
    
  log2_IL_6r_Acute_bout_interaction_reduced<-
lmm(
  formula = 
    il_6_r_calc_conc_mean_pg_m_l ~ 
    sex+
    ifn_1_netto+
    time_wd_glht+
    time_wd_glht:ifn_1_netto+
    treat2+
    treat2:time_wd_glht,
    #treat2:time_wd_glht:ifn_1_netto,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_IL_6r_Acute_bout_interaction_reduced)
  plot(log2_IL_6r_Acute_bout_interaction_reduced, type = "qqplot")
  plot(log2_IL_6r_Acute_bout_interaction_reduced, type = "scatterplot")
  #log2_IL_6r_Acute_bout_interaction_reduced_plot<-
   # plot(log2_IL_6r_Acute_bout_interaction_reduced, type = "fit",
    #   obs.alpha = 0.25, color = "treat2", ci = F, at = data.frame(sex = "F"))
  
     
log2_crp_Acute_bout_main<-
lmm(
  formula = 
    crp_mg_ml ~ 
    sex+
    time_wd_glht+
    treat2+
    treat2:time_wd_glht,
    #timepoint_time_wd_glht+
    #timepoint_time_wd_glht:treat,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_crp_Acute_bout_main)
  plot(log2_crp_Acute_bout_main, type = "qqplot")
  plot(log2_crp_Acute_bout_main, type = "scatterplot")
  

 combined_lmm_list[[5]]<-
  log2_crp_Acute_bout_main
 
    log2_crp_Acute_bout_interaction<-
lmm(
  formula = 
    crp_mg_ml ~ 
    sex+
    ifn_1_netto+
    time_wd_glht+
    time_wd_glht:ifn_1_netto+
    treat2+
    #treat2:ifn_1_netto+
    treat2:time_wd_glht+
    treat2:time_wd_glht:ifn_1_netto,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_crp_Acute_bout_interaction)
  plot(log2_crp_Acute_bout_interaction, type = "qqplot")
  plot(log2_IL_6_Acute_bout_interaction, type = "scatterplot")


 combined_lmm_list[[6]]<-
  log2_crp_Acute_bout_interaction
```

```{r eval =F}
log2_ifnG_Acute_bout_main<-
lmm(
  formula = 
    ifn_gamma_calc_conc_mean_pg_m_l ~ 
    sex+
    time_wd_glht+
    treat2+
    treat2:time_wd_glht,
    #timepoint_time_wd_glht+
    #timepoint_time_wd_glht:treat,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_ifnG_Acute_bout_main)
  plot(log2_ifnG_Acute_bout_main, type = "qqplot")
  plot(log2_ifnG_Acute_bout_main, type = "scatterplot")


 combined_lmm_list[[7]]<-
  log2_ifnG_Acute_bout_main 
  
    
    log2_ifnG_Acute_bout_interaction<-
lmm(
  formula = 
    ifn_gamma_calc_conc_mean_pg_m_l ~ 
    sex+
    ifn_1_netto+
    time_wd_glht+
    time_wd_glht:ifn_1_netto+
    treat2+
    treat2:time_wd_glht+
    treat2:time_wd_glht:ifn_1_netto,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_ifnG_Acute_bout_interaction)
  plot(log2_ifnG_Acute_bout_interaction, type = "qqplot")
  plot(log2_ifnG_Acute_bout_interaction, type = "scatterplot")
                


 combined_lmm_list[[8]]<-
  log2_ifnG_Acute_bout_interaction 
  
log2_il10_Acute_bout_main<-
lmm(
  formula = 
    il_10_calc_conc_mean_pg_m_l ~ 
    sex+
    time_wd_glht+
    treat2+
    treat2:time_wd_glht,
    #timepoint_time_wd_glht+
    #timepoint_time_wd_glht:treat,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_il10_Acute_bout_main)
  plot(log2_il10_Acute_bout_main, type = "qqplot")
  plot(log2_il10_Acute_bout_main, type = "scatterplot")


 combined_lmm_list[[9]]<-
  log2_il10_Acute_bout_main 
  
    
    log2_il10_Acute_bout_interaction<-
lmm(
  formula = 
    il_10_calc_conc_mean_pg_m_l ~ 
    sex+
    ifn_1_netto+
    time_wd_glht+
    time_wd_glht:ifn_1_netto+
    treat2+
    treat2:time_wd_glht+
    treat2:time_wd_glht:ifn_1_netto,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_il10_Acute_bout_interaction)
  plot(log2_il10_Acute_bout_interaction, type = "qqplot")
  plot(log2_il10_Acute_bout_interaction, type = "scatterplot")
                             

 combined_lmm_list[[10]]<-
log2_il10_Acute_bout_interaction
    
  
log2_il1a_Acute_bout_main<-
lmm(
  formula = 
    il_1_a_calc_conc_mean_pg_m_l ~ 
    sex+
    time_wd_glht+
    treat2+
    treat2:time_wd_glht,
    #timepoint_time_wd_glht+
    #timepoint_time_wd_glht:treat,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_il1a_Acute_bout_main)
  plot(log2_il1a_Acute_bout_main, type = "qqplot")
  plot(log2_il1a_Acute_bout_main, type = "scatterplot")
  
           

 combined_lmm_list[[11]]<-
log2_il1a_Acute_bout_main
    
 
    log2_il1a_Acute_bout_interaction<-
lmm(
  formula = 
    il_1_a_calc_conc_mean_pg_m_l ~ 
    sex+
    ifn_1_netto+
    time_wd_glht+
    time_wd_glht:ifn_1_netto+
    treat2+
    treat2:time_wd_glht+
    treat2:time_wd_glht:ifn_1_netto,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_il1a_Acute_bout_interaction)
  plot(log2_il1a_Acute_bout_interaction, type = "qqplot")
  plot(log2_il1a_Acute_bout_interaction, type = "scatterplot")
 combined_lmm_list[[12]]<-
log2_il1a_Acute_bout_interaction
 
log2_il1ra_Acute_bout_main<-
lmm(
  formula = 
    il_1_ra_calc_conc_mean_pg_m_l ~ 
    sex+
    time_wd_glht+
    treat2+
    treat2:time_wd_glht,
    #timepoint_time_wd_glht+
    #timepoint_time_wd_glht:treat,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_il1ra_Acute_bout_main)
  plot(log2_il1ra_Acute_bout_main, type = "qqplot")
  plot(log2_il1ra_Acute_bout_main, type = "scatterplot")

 combined_lmm_list[[13]]<-
log2_il1ra_Acute_bout_main
  
   
    log2_il1ra_Acute_bout_interaction<-
lmm(
  formula = 
    il_1_ra_calc_conc_mean_pg_m_l ~ 
    sex+
    ifn_1_netto+
    time_wd_glht+
    time_wd_glht:ifn_1_netto+
    treat2+
    treat2:time_wd_glht+
    treat2:time_wd_glht:ifn_1_netto,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_il1ra_Acute_bout_interaction)
  plot(log2_il1ra_Acute_bout_interaction, type = "qqplot")
  plot(log2_il1ra_Acute_bout_interaction, type = "scatterplot")

 
combined_lmm_list[[14]]<-
log2_il1ra_Acute_bout_interaction
  
                             
  
log2_il2_Acute_bout_main<-
lmm(
  formula = 
    il_2_calc_conc_mean_pg_m_l ~ 
    sex+
    time_wd_glht+
    treat2+
    treat2:time_wd_glht,
    #timepoint_time_wd_glht+
    #timepoint_time_wd_glht:treat,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_il2_Acute_bout_main)
  plot(log2_il2_Acute_bout_main, type = "qqplot")
  plot(log2_il2_Acute_bout_main, type = "scatterplot")
  
combined_lmm_list[[15]]<-
log2_il2_Acute_bout_main
  
                    
  
    log2_il2_Acute_bout_interaction<-
lmm(
  formula = 
    il_2_calc_conc_mean_pg_m_l ~ 
    sex+
    ifn_1_netto+
    time_wd_glht+
    time_wd_glht:ifn_1_netto+
    treat2+
    treat2:time_wd_glht+
    treat2:time_wd_glht:ifn_1_netto,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_il2_Acute_bout_interaction)
  plot(log2_il2_Acute_bout_interaction, type = "qqplot")
  plot(log2_il2_Acute_bout_interaction, type = "scatterplot") 
  

combined_lmm_list[[16]]<-
log2_il2_Acute_bout_interaction
  
log2_tnf_Acute_bout_main<-
lmm(
  formula = 
    tnf_calc_conc_mean_pg_m_l ~ 
    sex+
    time_wd_glht+
    treat2+
    treat2:time_wd_glht,
    #timepoint_time_wd_glht+
    #timepoint_time_wd_glht:treat,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_tnf_Acute_bout_main)
  plot(log2_tnf_Acute_bout_main, type = "qqplot")
  plot(log2_tnf_Acute_bout_main, type = "scatterplot")
combined_lmm_list[[17]]<-
log2_tnf_Acute_bout_main
  
    log2_tnf_Acute_bout_interaction<-
lmm(
  formula = 
    tnf_calc_conc_mean_pg_m_l ~ 
    sex+
    ifn_1_netto+
    time_wd_glht+
    time_wd_glht:ifn_1_netto+
    treat2+
    treat2:time_wd_glht+
    treat2:time_wd_glht:ifn_1_netto,
  repetition = ~ time_wd_glht|id_timepoint,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_combined
)
  summary(log2_tnf_Acute_bout_interaction)
  plot(log2_tnf_Acute_bout_interaction, type = "qqplot")
  plot(log2_tnf_Acute_bout_interaction, type = "scatterplot")

  combined_lmm_list[[18]]<-
log2_tnf_Acute_bout_interaction

  
  saveRDS(combined_lmm_list, 
          file = here("output", "acute bout", "RDS_models", "combined_lmm_list.rds"))      
  
```

##Read combined_lmm_list if it hasn't been created

```{r}
if (!exists("combined_lmm_list")) {
  # Initialize 
  combined_lmm_list <- readRDS(file = here("output", "acute bout", "RDS_models", "combined_lmm_list.rds")) 
  print("combined_lmm_list has been initialized.")
  beepr::beep("coin")
} else {
  print("combined_lmm_list already exists.")
  beepr::beep("sword")
}
```

## Use Multcomp2Table to get contrasts 
(it's from the butils package)

```{r}
il_6_multcomp_table_emmeans<-
  butils::multcomp2table(log2_IL_6_Acute_bout_main,
               transform = back2,
               method = "glht",
               method.multcomp="none",
               link=c( "(Intercept)=0",#T-5
                       "(Intercept)+time_wd_glht0=0",
                       "(Intercept)+time_wd_glht10=0",
                       "(Intercept)+time_wd_glht14=0",
                       "(Intercept)+time_wd_glht35=0",
                       "(Intercept)+time_wd_glht45=0",
                       "(Intercept)+time_wd_glht60=0",
                       "(Intercept)+time_wd_glht90=0",
                       "(Intercept)+time_wd_glht105=0",
                       "(Intercept) + treat2control=0",#T-5
                       "(Intercept)+time_wd_glht0 + treat2control + time_wd_glht0:treat2control=0",
                       "(Intercept)+time_wd_glht10 + treat2control + time_wd_glht10:treat2control=0",
                       "(Intercept)+time_wd_glht14 + treat2control + time_wd_glht14:treat2control=0",
                       "(Intercept)+time_wd_glht35 + treat2control + time_wd_glht35:treat2control=0",
                       "(Intercept)+time_wd_glht45 + treat2control + time_wd_glht45:treat2control=0",
                       "(Intercept)+time_wd_glht60 + treat2control + time_wd_glht60:treat2control=0",
                       "(Intercept)+time_wd_glht90 + treat2control + time_wd_glht90:treat2control=0",
                       "(Intercept)+time_wd_glht105 + treat2control + time_wd_glht105:treat2control=0",
                       "(Intercept)+treat2exercise=0",#T-5
                       "(Intercept)+time_wd_glht0 + treat2exercise + time_wd_glht0:treat2exercise=0",
                       "(Intercept)+time_wd_glht10 + treat2exercise + time_wd_glht10:treat2exercise=0",
                       "(Intercept)+time_wd_glht14 + treat2exercise + time_wd_glht14:treat2exercise=0",
                       "(Intercept)+time_wd_glht35 + treat2exercise + time_wd_glht35:treat2exercise=0",
                       "(Intercept)+time_wd_glht45 + treat2exercise + time_wd_glht45:treat2exercise=0",
                       "(Intercept)+time_wd_glht60 + treat2exercise + time_wd_glht60:treat2exercise=0",
                       "(Intercept)+time_wd_glht90 + treat2exercise + time_wd_glht90:treat2exercise=0",
                       "(Intercept)+time_wd_glht105 + treat2exercise + time_wd_glht105:treat2exercise=0"
                      )
               )

il_6_multcomp_table_emmeans

il_6_multcomp_table_contrasts_ratios<-
  multcomp2table(log2_IL_6_Acute_bout_main,
               transform = back2,
               method = "glht",
               method.multcomp="none",
               link=c( 
              "treat2exercise - treat2control = 0",
              "treat2exercise + time_wd_glht0:treat2exercise - treat2control - time_wd_glht0:treat2control = 0",
              "treat2exercise + time_wd_glht10:treat2exercise - treat2control - time_wd_glht10:treat2control = 0",
              "treat2exercise + time_wd_glht14:treat2exercise - treat2control - time_wd_glht14:treat2control = 0",
              "treat2exercise + time_wd_glht35:treat2exercise - treat2control - time_wd_glht35:treat2control = 0",
              "treat2exercise + time_wd_glht45:treat2exercise - treat2control - time_wd_glht45:treat2control = 0",
              "treat2exercise + time_wd_glht60:treat2exercise - treat2control - time_wd_glht60:treat2control = 0",
              "treat2exercise + time_wd_glht90:treat2exercise - treat2control - time_wd_glht90:treat2control = 0",
              "treat2exercise + time_wd_glht105:treat2exercise - treat2control - time_wd_glht105:treat2control = 0"
                      )
               )%>%
  mutate(
    time_within_day = factor(x=c("-5","0","10","14","35","45","60","90","105"),
                               levels = c("-5","0","10","14","35","45","60","90","105"))
  )



il_6_multcomp_table_contrasts_ratios$p.value

il_6_multcomp_table_emmeans<-
  il_6_multcomp_table_emmeans%>%
    mutate(
      time_within_day = rep(factor(x=c("-5","0","10","14","35","45","60","90","105"),
                               levels = c("-5","0","10","14","35","45","60","90","105")),3),
      treat2 = c(rep("baseline",9),rep("control",9),rep("exercise",9)),
      IL6 = Estimate
    )

snake_case_Acute_Bout_Data<-
  snake_case_Acute_Bout_Data%>%
  mutate(treat2 = case_when(
    grepl("baseline",timepoint) ~ "baseline",
    T ~ treat
  ))

il_6_multcomp_table_emmeans%>%
  ggplot(aes(y = IL6, ymin = Lower, ymax = Upper, 
             color = treat2, 
             x = as.numeric(as.character(time_within_day)), 
             group = treat2))+
  geom_line()+
  geom_errorbar(position = position_dodge(5))+
  labs(y = "IL-6 (pg/ml)",
       x = "time during bout (min)",
       legend = "Treatment")+
  geom_point(
    inherit.aes = F,
    data = snake_case_Acute_Bout_Data,
    aes(x = continous_time_within_day, y = il_6_calc_conc_mean_pg_m_l, color = treat2),
    position=position_jitter(3),
    alpha = 0.2)+
  guides(
    color = guide_legend(title = "Treatment")
  )+
  geom_text(
    inherit.aes = F,
    data = il_6_multcomp_table_contrasts_ratios,
    aes(
      x = as.numeric(as.character(time_within_day)),
      y = c(3,3.66,4,3.33,3,3.66,4,3.33,3),
      label = paste0("p = ", p.value)
      
    ),
    position = position_dodge(2)
  )
```

###Functions that can create plots from LMM objects

```{r}

main_model_mult_comp2_table_emmeans<-function(x){
  multcomp2table(x,
               transform = back2,
               method = "glht",
               method.multcomp="none",
               link=c( "(Intercept)=0", #T-5
                       "(Intercept)+time_wd_glht0=0",
                       "(Intercept)+time_wd_glht10=0",
                       "(Intercept)+time_wd_glht14=0",
                       "(Intercept)+time_wd_glht35=0",
                       "(Intercept)+time_wd_glht45=0",
                       "(Intercept)+time_wd_glht60=0",
                       "(Intercept)+time_wd_glht90=0",
                       "(Intercept)+time_wd_glht105=0",
                       "(Intercept) + treat2control=0",#T-5
                       "(Intercept)+time_wd_glht0 + treat2control + time_wd_glht0:treat2control=0",
                       "(Intercept)+time_wd_glht10 + treat2control + time_wd_glht10:treat2control=0",
                       "(Intercept)+time_wd_glht14 + treat2control + time_wd_glht14:treat2control=0",
                       "(Intercept)+time_wd_glht35 + treat2control + time_wd_glht35:treat2control=0",
                       "(Intercept)+time_wd_glht45 + treat2control + time_wd_glht45:treat2control=0",
                       "(Intercept)+time_wd_glht60 + treat2control + time_wd_glht60:treat2control=0",
                       "(Intercept)+time_wd_glht90 + treat2control + time_wd_glht90:treat2control=0",
                       "(Intercept)+time_wd_glht105 + treat2control + time_wd_glht105:treat2control=0",
                       "(Intercept)+treat2exercise=0",#T-5
                       "(Intercept)+time_wd_glht0 + treat2exercise + time_wd_glht0:treat2exercise=0",
                       "(Intercept)+time_wd_glht10 + treat2exercise + time_wd_glht10:treat2exercise=0",
                       "(Intercept)+time_wd_glht14 + treat2exercise + time_wd_glht14:treat2exercise=0",
                       "(Intercept)+time_wd_glht35 + treat2exercise + time_wd_glht35:treat2exercise=0",
                       "(Intercept)+time_wd_glht45 + treat2exercise + time_wd_glht45:treat2exercise=0",
                       "(Intercept)+time_wd_glht60 + treat2exercise + time_wd_glht60:treat2exercise=0",
                       "(Intercept)+time_wd_glht90 + treat2exercise + time_wd_glht90:treat2exercise=0",
                       "(Intercept)+time_wd_glht105 + treat2exercise + time_wd_glht105:treat2exercise=0"
                      )
  )%>%
  mutate(
    time_within_day = rep(factor(x=c("-5","0","10","14","35","45","60","90","105"),
                               levels = c("-5","0","10","14","35","45","60","90","105")),3),
      treat2 = c(rep("baseline",9),rep("control",9),rep("exercise",9)))
}

main_model_multcomp_table_contrasts<-
  function(x){
    
  multcomp2table(x,
               transform = back2,
               method = "glht",
               method.multcomp="none",
               link=c( 
              "treat2exercise - treat2control = 0",
              "treat2exercise + time_wd_glht0:treat2exercise - treat2control - time_wd_glht0:treat2control = 0",
              "treat2exercise + time_wd_glht10:treat2exercise - treat2control - time_wd_glht10:treat2control = 0",
              "treat2exercise + time_wd_glht14:treat2exercise - treat2control - time_wd_glht14:treat2control = 0",
              "treat2exercise + time_wd_glht35:treat2exercise - treat2control - time_wd_glht35:treat2control = 0",
              "treat2exercise + time_wd_glht45:treat2exercise - treat2control - time_wd_glht45:treat2control = 0",
              "treat2exercise + time_wd_glht60:treat2exercise - treat2control - time_wd_glht60:treat2control = 0",
              "treat2exercise + time_wd_glht90:treat2exercise - treat2control - time_wd_glht90:treat2control = 0",
              "treat2exercise + time_wd_glht105:treat2exercise - treat2control - time_wd_glht105:treat2control = 0"
                      )
               )%>%
  mutate(
    time_within_day = factor(x=c("-5","0","10","14","35","45","60","90","105"),
                               levels = c("-5","0","10","14","35","45","60","90","105"))
  )
  }
### FUNCTION MAIN TO PLOT

model_main_to_plot <- 
  function(x, 
           type = "plot",
           bar = "crossbar",
           p_positions = c(3,3.66,4,3.33,3,3.66,4,3.33,3),
           rawdata = snake_case_Acute_Bout_Data){
        emmeans<-main_model_mult_comp2_table_emmeans(x)
    if (type == "emmeans"){
      return(emmeans)
      break
    }
    contrasts<-main_model_multcomp_table_contrasts(x)
    if(type == "contrast"){
      return(contrasts)
      break
    }
    
   plot<-  emmeans%>%
  ggplot(aes(y = Estimate, 
             ymin = Lower, 
             ymax = Upper, 
             color = treat2, 
             x = as.numeric(as.character(time_within_day)), 
             group = treat2))+
  geom_line()+
  labs(y = x$outcome$var,
       x = "time during bout (min)",
       legend = "Treatment")+
  guides(
    color = guide_legend(title = "Treatment"))+
     theme_bw()
    if(all(!is.na(p_positions))){
    if(
      length(p_positions) < 9){
        warning("p_positions less than 9, repeating to 9")
        if(length(p_positions) < 1){
          warning("p_positions less than 1, BREAK")
          break
        }
      p_positions <- rep(p_positions, 9/length(p_positions))[1:9]
    }
    if(
      length(p_positions) > 9){
        warning("p_positions more than 9, using 9 first values")
              p_positions <- p_positions[1:9]
      }
   plot<-plot+
  geom_text(
    inherit.aes = F,
    data = contrasts,
    aes(
      x = as.numeric(as.character(time_within_day)),
      y = p_positions,
      label = paste0("p = ", p.value)
      
    ),
    position = position_dodge(2)
  )}
   
   if (bar == "errorbar"){
     plot <- 
       plot+
  geom_errorbar(position = position_dodge(5))
   }
   if (bar == "crossbar"){
     plot <- 
       plot+
  geom_crossbar(position = position_dodge(5))
   }
   
   if(type == "plot"){
     return(plot)
   } 
   
   if(type == "point_plot"){
     return(
       plot +
  geom_point(
    data = rawdata,
    inherit.aes = F,
    aes_string(
        x = "continous_time_within_day", 
        y = x$outcome$var, 
        color = "treat2"),
    position=position_jitter(3),
    alpha = 0.2)
     )
   }
   {return(list(plot=plot, emmeans=emmeans, contrasts=contrasts))}
  }
```

##Functions that can create plots, emmeans and contrasts from interaction lmms

```{r}
log2_IL_6_Acute_bout_interaction%>%model.tables()%>%rownames()


terts<-function(x = 
           log2_IL_6_Acute_bout_interaction,
           var = "ifn_1_netto"){
  if (class(x) != "lmm"){
    warning("class must be lmm")
    break
  }
low_ifn_1<-
  quantile(x$data[var], na.rm = T, 
         probs = c(1/6,1/3+1/6,2/3+1/6))[1]
mid_ifn_1<-
  quantile(x$data[var], na.rm = T, 
         probs = c(1/6,1/3+1/6,2/3+1/6))[2]
high_ifn_1<-
  quantile(x$data[var], na.rm = T, 
         probs = c(1/6,1/3+1/6,2/3+1/6))[3]

out_data = 
  data.frame(
)
return(c(low_ifn_1, mid_ifn_1, high_ifn_1))
}


K<-model.tables(log2_IL_6_Acute_bout_interaction)%>%rownames()


smart_contrasts_interaction <-
  data.frame(
    name = K
  )

    emmeans_interaction <-
      function(x){
        tertials<-terts(x)
      emmeans<-
        multcomp2table(x,
               transform = back2,
               method = "glht",
               method.multcomp="none",
               link=c(  #BASELINE
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[1]),"= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[2]),"= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[3]),"= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[1]),
                               "+time_wd_glht0+",as.character(tertials[1]),
                               "*ifn_1_netto:time_wd_glht0", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[2]),
                               "+time_wd_glht0+",as.character(tertials[2]),
                               "*ifn_1_netto:time_wd_glht0", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[3]),
                               "+time_wd_glht0+",as.character(tertials[3]),
                               "*ifn_1_netto:time_wd_glht0", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[1]),
                               "+time_wd_glht10+",as.character(tertials[1]),
                               "*ifn_1_netto:time_wd_glht10", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[2]),
                               "+time_wd_glht10+",as.character(tertials[2]),
                               "*ifn_1_netto:time_wd_glht10", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[3]),
                               "+time_wd_glht10+",as.character(tertials[3]),
                               "*ifn_1_netto:time_wd_glht10", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[1]),
                               "+time_wd_glht14+",as.character(tertials[1]),
                               "*ifn_1_netto:time_wd_glht14", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[2]),
                               "+time_wd_glht14+",as.character(tertials[2]),
                               "*ifn_1_netto:time_wd_glht14", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[3]),
                               "+time_wd_glht14+",as.character(tertials[3]),
                               "*ifn_1_netto:time_wd_glht14", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[1]),
                               "+time_wd_glht35+",as.character(tertials[1]),
                               "*ifn_1_netto:time_wd_glht35", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[2]),
                               "+time_wd_glht35+",as.character(tertials[2]),
                               "*ifn_1_netto:time_wd_glht35", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[3]),
                               "+time_wd_glht35+",as.character(tertials[3]),
                               "*ifn_1_netto:time_wd_glht35", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[1]),
                               "+time_wd_glht45+",as.character(tertials[1]),
                               "*ifn_1_netto:time_wd_glht45", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[2]),
                               "+time_wd_glht45+",as.character(tertials[2]),
                               "*ifn_1_netto:time_wd_glht45", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[3]),
                               "+time_wd_glht45+",as.character(tertials[3]),
                               "*ifn_1_netto:time_wd_glht45", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[1]),
                               "+time_wd_glht60+",as.character(tertials[1]),
                               "*ifn_1_netto:time_wd_glht60", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[2]),
                               "+time_wd_glht60+",as.character(tertials[2]),
                               "*ifn_1_netto:time_wd_glht60", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[3]),
                               "+time_wd_glht60+",as.character(tertials[3]),
                               "*ifn_1_netto:time_wd_glht60", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[1]),
                               "+time_wd_glht90+",as.character(tertials[1]),
                               "*ifn_1_netto:time_wd_glht90", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[2]),
                               "+time_wd_glht90+",as.character(tertials[2]),
                               "*ifn_1_netto:time_wd_glht90", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[3]),
                               "+time_wd_glht90+",as.character(tertials[3]),
                               "*ifn_1_netto:time_wd_glht90", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[1]),
                               "+time_wd_glht105+",as.character(tertials[1]),
                               "*ifn_1_netto:time_wd_glht105", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[2]),
                               "+time_wd_glht105+",as.character(tertials[2]),
                               "*ifn_1_netto:time_wd_glht105", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[3]),
                               "+time_wd_glht105+",as.character(tertials[3]),
                               "*ifn_1_netto:time_wd_glht105", "= 0"),
                        #CONTROL
                        paste0("(Intercept)+treat2control+ifn_1_netto*",as.character(tertials[1]),
                                "+ifn_1_netto:time_wd_glhtmin5:treat2control*",as.character(tertials[1]),
                               "= 0"),
                        paste0("(Intercept)+treat2control+ifn_1_netto*",as.character(tertials[2]),
                                "+ifn_1_netto:time_wd_glhtmin5:treat2control*",as.character(tertials[2]),
                               "= 0"),
                        paste0("(Intercept)+treat2control+ifn_1_netto*",as.character(tertials[3]),
                                "+ifn_1_netto:time_wd_glhtmin5:treat2control*",as.character(tertials[3]),
                               "= 0"),
                        #control t = 0
                        paste0("(Intercept)+time_wd_glht0+treat2control+ifn_1_netto*",as.character(tertials[1]),
                                "+ifn_1_netto:time_wd_glht0:treat2control*",as.character(tertials[1]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht0+treat2control+ifn_1_netto*",as.character(tertials[2]),
                                "+ifn_1_netto:time_wd_glht0:treat2control*",as.character(tertials[2]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht0+treat2control+ifn_1_netto*",as.character(tertials[3]),
                                "+ifn_1_netto:time_wd_glht0:treat2control*",as.character(tertials[3]),
                               "= 0"),
                        #control t = 10
                        paste0("(Intercept)+time_wd_glht10+treat2control+ifn_1_netto*",as.character(tertials[1]),
                                "+ifn_1_netto:time_wd_glht10:treat2control*",as.character(tertials[1]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht10+treat2control+ifn_1_netto*",as.character(tertials[2]),
                                "+ifn_1_netto:time_wd_glht10:treat2control*",as.character(tertials[2]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht10+treat2control+ifn_1_netto*",as.character(tertials[3]),
                                "+ifn_1_netto:time_wd_glht10:treat2control*",as.character(tertials[3]),
                               "= 0"),
                        #control t = 14
                        paste0("(Intercept)+time_wd_glht14+treat2control+ifn_1_netto*",as.character(tertials[1]),
                                "+ifn_1_netto:time_wd_glht14:treat2control*",as.character(tertials[1]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht14+treat2control+ifn_1_netto*",as.character(tertials[2]),
                                "+ifn_1_netto:time_wd_glht14:treat2control*",as.character(tertials[2]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht14+treat2control+ifn_1_netto*",as.character(tertials[3]),
                                "+ifn_1_netto:time_wd_glht14:treat2control*",as.character(tertials[3]),
                               "= 0"),
                        #control t = 35
                        paste0("(Intercept)+time_wd_glht35+treat2control+ifn_1_netto*",as.character(tertials[1]),
                                "+ifn_1_netto:time_wd_glht35:treat2control*",as.character(tertials[1]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht35+treat2control+ifn_1_netto*",as.character(tertials[2]),
                                "+ifn_1_netto:time_wd_glht35:treat2control*",as.character(tertials[2]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht35+treat2control+ifn_1_netto*",as.character(tertials[3]),
                                "+ifn_1_netto:time_wd_glht35:treat2control*",as.character(tertials[3]),
                               "= 0"),
                        #control t = 45
                        paste0("(Intercept)+time_wd_glht45+treat2control+ifn_1_netto*",as.character(tertials[1]),
                                "+ifn_1_netto:time_wd_glht45:treat2control*",as.character(tertials[1]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht45+treat2control+ifn_1_netto*",as.character(tertials[2]),
                                "+ifn_1_netto:time_wd_glht45:treat2control*",as.character(tertials[2]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht45+treat2control+ifn_1_netto*",as.character(tertials[3]),
                                "+ifn_1_netto:time_wd_glht45:treat2control*",as.character(tertials[3]),
                               "= 0"),
                        #control t = 60
                        paste0("(Intercept)+time_wd_glht60+treat2control+ifn_1_netto*",as.character(tertials[1]),
                                "+ifn_1_netto:time_wd_glht60:treat2control*",as.character(tertials[1]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht60+treat2control+ifn_1_netto*",as.character(tertials[2]),
                                "+ifn_1_netto:time_wd_glht60:treat2control*",as.character(tertials[2]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht60+treat2control+ifn_1_netto*",as.character(tertials[3]),
                                "+ifn_1_netto:time_wd_glht60:treat2control*",as.character(tertials[3]),
                               "= 0"),
                        #control t = 90
                        paste0("(Intercept)+time_wd_glht90+treat2control+ifn_1_netto*",as.character(tertials[1]),
                                "+ifn_1_netto:time_wd_glht90:treat2control*",as.character(tertials[1]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht90+treat2control+ifn_1_netto*",as.character(tertials[2]),
                                "+ifn_1_netto:time_wd_glht90:treat2control*",as.character(tertials[2]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht90+treat2control+ifn_1_netto*",as.character(tertials[3]),
                                "+ifn_1_netto:time_wd_glht90:treat2control*",as.character(tertials[3]),
                               "= 0"),
                        #control t = 105
                        paste0("(Intercept)+time_wd_glht105+treat2control+ifn_1_netto*",as.character(tertials[1]),
                                "+ifn_1_netto:time_wd_glht105:treat2control*",as.character(tertials[1]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht105+treat2control+ifn_1_netto*",as.character(tertials[2]),
                                "+ifn_1_netto:time_wd_glht105:treat2control*",as.character(tertials[2]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht105+treat2control+ifn_1_netto*",as.character(tertials[3]),
                                "+ifn_1_netto:time_wd_glht105:treat2control*",as.character(tertials[3]),
                               "= 0"),
                        #exercise
                        paste0("(Intercept)+treat2exercise+ifn_1_netto*",as.character(tertials[1]),
                                "+ifn_1_netto:time_wd_glhtmin5:treat2exercise*",as.character(tertials[1]),
                               "= 0"),
                        paste0("(Intercept)+treat2exercise+ifn_1_netto*",as.character(tertials[2]),
                                "+ifn_1_netto:time_wd_glhtmin5:treat2exercise*",as.character(tertials[2]),
                               "= 0"),
                        paste0("(Intercept)+treat2exercise+ifn_1_netto*",as.character(tertials[3]),
                                "+ifn_1_netto:time_wd_glhtmin5:treat2exercise*",as.character(tertials[3]),
                               "= 0"),
                        #exercise t = 0
                        paste0("(Intercept)+time_wd_glht0+treat2exercise+ifn_1_netto*",as.character(tertials[1]),
                                "+ifn_1_netto:time_wd_glht0:treat2exercise*",as.character(tertials[1]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht0+treat2exercise+ifn_1_netto*",as.character(tertials[2]),
                                "+ifn_1_netto:time_wd_glht0:treat2exercise*",as.character(tertials[2]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht0+treat2exercise+ifn_1_netto*",as.character(tertials[3]),
                                "+ifn_1_netto:time_wd_glht0:treat2exercise*",as.character(tertials[3]),
                               "= 0"),
                        #exercise t = 10
                        paste0("(Intercept)+time_wd_glht10+treat2exercise+ifn_1_netto*",as.character(tertials[1]),
                                "+ifn_1_netto:time_wd_glht10:treat2exercise*",as.character(tertials[1]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht10+treat2exercise+ifn_1_netto*",as.character(tertials[2]),
                                "+ifn_1_netto:time_wd_glht10:treat2exercise*",as.character(tertials[2]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht10+treat2exercise+ifn_1_netto*",as.character(tertials[3]),
                                "+ifn_1_netto:time_wd_glht10:treat2exercise*",as.character(tertials[3]),
                               "= 0"),
                        #exercise t = 14
                        paste0("(Intercept)+time_wd_glht14+treat2exercise+ifn_1_netto*",as.character(tertials[1]),
                                "+ifn_1_netto:time_wd_glht14:treat2exercise*",as.character(tertials[1]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht14+treat2exercise+ifn_1_netto*",as.character(tertials[2]),
                                "+ifn_1_netto:time_wd_glht14:treat2exercise*",as.character(tertials[2]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht14+treat2exercise+ifn_1_netto*",as.character(tertials[3]),
                                "+ifn_1_netto:time_wd_glht14:treat2exercise*",as.character(tertials[3]),
                               "= 0"),
                        #exercise t = 35
                        paste0("(Intercept)+time_wd_glht35+treat2exercise+ifn_1_netto*",as.character(tertials[1]),
                                "+ifn_1_netto:time_wd_glht35:treat2exercise*",as.character(tertials[1]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht35+treat2exercise+ifn_1_netto*",as.character(tertials[2]),
                                "+ifn_1_netto:time_wd_glht35:treat2exercise*",as.character(tertials[2]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht35+treat2exercise+ifn_1_netto*",as.character(tertials[3]),
                                "+ifn_1_netto:time_wd_glht35:treat2exercise*",as.character(tertials[3]),
                               "= 0"),
                        #exercise t = 45
                        paste0("(Intercept)+time_wd_glht45+treat2exercise+ifn_1_netto*",as.character(tertials[1]),
                                "+ifn_1_netto:time_wd_glht45:treat2exercise*",as.character(tertials[1]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht45+treat2exercise+ifn_1_netto*",as.character(tertials[2]),
                                "+ifn_1_netto:time_wd_glht45:treat2exercise*",as.character(tertials[2]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht45+treat2exercise+ifn_1_netto*",as.character(tertials[3]),
                                "+ifn_1_netto:time_wd_glht45:treat2exercise*",as.character(tertials[3]),
                               "= 0"),
                        #exercise t = 60
                        paste0("(Intercept)+time_wd_glht60+treat2exercise+ifn_1_netto*",as.character(tertials[1]),
                                "+ifn_1_netto:time_wd_glht60:treat2exercise*",as.character(tertials[1]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht60+treat2exercise+ifn_1_netto*",as.character(tertials[2]),
                                "+ifn_1_netto:time_wd_glht60:treat2exercise*",as.character(tertials[2]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht60+treat2exercise+ifn_1_netto*",as.character(tertials[3]),
                                "+ifn_1_netto:time_wd_glht60:treat2exercise*",as.character(tertials[3]),
                               "= 0"),
                        #exercise t = 90
                        paste0("(Intercept)+time_wd_glht90+treat2exercise+ifn_1_netto*",as.character(tertials[1]),
                                "+ifn_1_netto:time_wd_glht90:treat2exercise*",as.character(tertials[1]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht90+treat2exercise+ifn_1_netto*",as.character(tertials[2]),
                                "+ifn_1_netto:time_wd_glht90:treat2exercise*",as.character(tertials[2]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht90+treat2exercise+ifn_1_netto*",as.character(tertials[3]),
                                "+ifn_1_netto:time_wd_glht90:treat2exercise*",as.character(tertials[3]),
                               "= 0"),
                        #exercise t = 105
                        paste0("(Intercept)+time_wd_glht105+treat2exercise+ifn_1_netto*",as.character(tertials[1]),
                                "+ifn_1_netto:time_wd_glht105:treat2exercise*",as.character(tertials[1]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht105+treat2exercise+ifn_1_netto*",as.character(tertials[2]),
                                "+ifn_1_netto:time_wd_glht105:treat2exercise*",as.character(tertials[2]),
                               "= 0"),
                        paste0("(Intercept)+time_wd_glht105+treat2exercise+ifn_1_netto*",as.character(tertials[3]),
                                "+ifn_1_netto:time_wd_glht105:treat2exercise*",as.character(tertials[3]),
                               "= 0")
                        ))
    emmeans<-
      emmeans%>%
      mutate(
      tert = rep(factor(c("0-33%","33-66%","66-100%"), 
                        levels = c("0-33%","33-66%","66-100%")), length(rownames(emmeans))/3),
      timepoint = factor(c(rep("baseline",27),rep("followup",54)
                           ), levels=c("baseline","followup") ),
      treat2 = factor(c(rep("baseline",27), rep("control",27), rep("exercise",27)
                        ), levels=c("baseline","control","exercise") ),
      
    time_within_day = rep(factor(x=sort(rep(c(-5,0,10,14,35,45,60,90,105),3)),
                               levels = c("-5","0","10","14","35","45","60","90","105")),3)
    )
    return(emmeans)
      }

contrasts_interaction<-
  function(x){
    
  multcomp2table(x,
               transform = back2,
               method = "glht",
               method.multcomp="none",
               link=c( 
              "treat2exercise + ifn_1_netto:time_wd_glhtmin5:treat2exercise - treat2control - ifn_1_netto:time_wd_glhtmin5:treat2control = 0",
              "treat2exercise + time_wd_glht0:treat2exercise +ifn_1_netto:time_wd_glht0:treat2exercise - treat2control - time_wd_glht0:treat2control = 0",
              "treat2exercise + time_wd_glht10:treat2exercise + ifn_1_netto:time_wd_glht10:treat2exercise - treat2control - time_wd_glht10:treat2control - ifn_1_netto:time_wd_glht10:treat2control = 0",
              
              "treat2exercise + time_wd_glht14:treat2exercise - treat2control - time_wd_glht14:treat2control - ifn_1_netto:time_wd_glht14:treat2control + ifn_1_netto:time_wd_glht14:treat2exercise= 0",
              
              "treat2exercise + ifn_1_netto:time_wd_glht35:treat2exercise - treat2control - time_wd_glht35:treat2control - ifn_1_netto:time_wd_glht35:treat2control + time_wd_glht35:treat2exercise= 0",
              "treat2exercise + ifn_1_netto:time_wd_glht45:treat2exercise - treat2control - time_wd_glht45:treat2control - ifn_1_netto:time_wd_glht45:treat2control + time_wd_glht45:treat2exercise= 0",
              "treat2exercise + ifn_1_netto:time_wd_glht60:treat2exercise - treat2control - time_wd_glht60:treat2control - ifn_1_netto:time_wd_glht60:treat2control + time_wd_glht60:treat2exercise= 0",
              "treat2exercise + ifn_1_netto:time_wd_glht90:treat2exercise - treat2control - time_wd_glht90:treat2control - ifn_1_netto:time_wd_glht90:treat2control + time_wd_glht90:treat2exercise= 0",
              "treat2exercise + time_wd_glht105:treat2exercise - treat2control - time_wd_glht105:treat2control - ifn_1_netto:time_wd_glht105:treat2control + ifn_1_netto:time_wd_glht105:treat2exercise= 0"
                      )
               )%>%
  mutate(
    time_within_day = factor(x=c("-5","0","10","14","35","45","60","90","105"),
                               levels = c("-5","0","10","14","35","45","60","90","105"))
  )
  }


emmeans_il6r_interact<-
  emmeans_interaction(combined_lmm_list[[4]])

contrast_il6r_interact <-
  contrasts_interaction(combined_lmm_list[[4]])
```

##Function to go from interaction model to graph

```{r}

model_interaction_to_plot <-  function(x, 
           type = "plot",
           p_positions = rep(c(2,3,4),9),
           bar = "crossbar",
           rawdata = snake_case_Acute_Bout_Data) {
        emmeans<-emmeans_interaction(x)
    if (type == "emmeans"){
      return(emmeans)
      break
    }
        
    plot<-
  emmeans%>%
  ggplot(aes(y = Estimate, 
             ymin = Lower, 
             ymax = Upper, 
             color = treat2, 
             x = as.numeric(as.character(time_within_day)), 
             group = treat2))+
  geom_line()+
  labs(y = x$outcome$var,
       x = "time during bout (min)",
       legend = "Treatment")+
  guides(
    color = guide_legend(title = "Treatment"))+
  theme_bw()+
  facet_wrap(~tert)
    
    if (bar == "errorbar"){
      plot<-plot+
      geom_errorbar(position = position_dodge(5))
}  
    if (bar == "crossbar"){
      plot<-plot+
      geom_crossbar(position = position_dodge(5))
}  
        
    contrasts<-contrasts_interaction(x)
    if(type == "contrast"){
      return(contrasts)
      break
    }
    
    if(any(!is.na(p_positions)) ){
    if(
      length(p_positions) < 27){
        warning("p_positions less than 27, repeating to 27")
          if(length(p_positions) < 1){
            warning("p_positions less than 1, BREAK") 
            break
          }
      p_positions <- rep(p_positions, 27/length(p_positions))[1:27]
    }
    if(
      length(p_positions) > 27){
        warning("p_positions more than 9, using 9 first values")
              p_positions <- p_positions[1:27]
    } 
plot<-
  plot+
  geom_text(
    inherit.aes = F,
    data = contrasts,
    aes(
      x = as.numeric(as.character(time_within_day)),
      y = p_positions,
      label = paste0("p = ", p.value)
    ),
    position = position_dodge(2))}

   if(type == "plot"){
     return(plot)
   } else if(type == "point_plot"){
     return(
       plot +
  geom_point(
    data = rawdata,
    inherit.aes = F,
    aes_string(
        x = "continous_time_within_day", 
        y = x$outcome$var, 
        color = "treat2"),
    position=position_jitter(3),
    alpha = 0.2)
     )
   } else
   {return(list(plot=plot, emmeans=emmeans, contrasts=contrasts))}
}
```

##Use functions #Plot Main effects

```{r}
#Check Ændringer i IFN stratificering.

IL_6_main_emmeans <- combined_lmm_list[[1]]%>%
  model_main_to_plot(x=., type = "emmeans", p_positions = NA)
IL_6_main_contrasts <- combined_lmm_list[[1]]%>%
  model_main_to_plot(x=., type = "contrast", p_positions = NA)
IL_6_main_plot<- combined_lmm_list[[1]]%>%
  model_main_to_plot(x=., type = "plot", p_positions =NA)
IL_6_main_point_plot<-
  combined_lmm_list[[1]]%>%
  model_main_to_plot(x=., type = "point_plot", p_positions = NA)
IL_6_main_emmeans
IL_6_main_contrasts
ggsave(
  filename= here("output", "Acute Bout", "graphics", "il6_main_plot.jpg"),
  plot = IL_6_main_plot +
    labs(
      title = "IL-6 Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-6 (pg/ml)"
    ))

ggsave(
  filename= here("output", "Acute Bout", "graphics", "il6_main_point_plot.jpg"), 
  plot=
    IL_6_main_point_plot  +
    labs(
      title = "IL-6 Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-6 (pg/ml)"
    )  )

IL_6r_main_emmeans <- combined_lmm_list[[3]]%>%
  model_main_to_plot(x=., type = "emmeans", p_positions = NA)
IL_6r_main_contrasts <- combined_lmm_list[[3]]%>%
  model_main_to_plot(x=., type = "contrast", p_positions = NA)
IL_6r_main_plot<- combined_lmm_list[[3]]%>%
  model_main_to_plot(x=., type = "plot", p_positions = NA)
IL_6r_main_point_plot<-
  combined_lmm_list[[3]]%>%
  model_main_to_plot(x=., type = "point_plot", p_positions = NA)
IL_6r_main_emmeans
IL_6r_main_contrasts
ggsave(
  filename= here("output", "Acute Bout", "graphics", "il6r_main_plot.jpg"), plot = 
    IL_6r_main_plot  +
    labs(
      title = "IL-6r Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-6r (pg/ml)"
    ))

ggsave(
  filename= here("output", "Acute Bout", "graphics", "il6r_main_point_plot.jpg"),
  IL_6r_main_point_plot  +
    labs(
      title = "IL-6r Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-6r (pg/ml)"))


crp_main_emmeans <- combined_lmm_list[[5]]%>%
  model_main_to_plot(x=., type = "emmeans", p_positions = NA)
crp_main_contrasts <- combined_lmm_list[[5]]%>%
  model_main_to_plot(x=., type = "contrast", p_positions = NA)
crp_main_plot<- combined_lmm_list[[5]]%>%
  model_main_to_plot(x=., type = "plot", p_positions = NA)
crp_main_point_plot<-
  combined_lmm_list[[5]]%>%
  model_main_to_plot(x=., type = "point_plot", p_positions = NA)
crp_main_emmeans
crp_main_contrasts

ggsave(
  filename= here("output", "Acute Bout", "graphics", "crp_main_plot.jpg"),
  plot=crp_main_plot  +
    labs(
      title = "CRP Concentration during acute bout",
      x = "Time during bout (min)",
      y = "crp (mg/ml)"
    ))


ggsave(
  filename= here("output", "Acute Bout", "graphics", "crp_main_point_plot.jpg"),  
  crp_main_point_plot +
    labs(
      title = "CRP Concentration during acute bout",
      x = "Time during bout (min)",
      y = "crp (mg/ml)"
    ))


ifng_main_emmeans <- combined_lmm_list[[7]]%>%
  model_main_to_plot(x=., type = "emmeans", p_positions = NA)
ifng_main_contrasts <- combined_lmm_list[[7]]%>%
  model_main_to_plot(x=., type = "contrast", p_positions = NA)
ifng_main_plot<- combined_lmm_list[[7]]%>%
  model_main_to_plot(x=., type = "plot", p_positions = NA)
ifng_main_point_plot<-
  combined_lmm_list[[7]]%>%
  model_main_to_plot(x=., type = "point_plot", p_positions = NA)
ifng_main_emmeans
ifng_main_contrasts

ggsave(
  filename= here("output", "Acute Bout", "graphics", "ifng_main_plot.jpg"),
  plot = ifng_main_plot +
    labs(
      title = "IFN-\u03b3 Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IFN-\u03b3 (pg/ml)"
    ))

ggsave(
  filename= here("output", "Acute Bout", "graphics", "ifng_main_point_plot.jpg"),
  plot = ifng_main_point_plot +
    labs(
      title = "IFN-\u03b3 Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IFN-\u03b3 (pg/ml)"
    ))

il10_main_emmeans <- combined_lmm_list[[9]]%>%
  model_main_to_plot(x=., type = "emmeans", p_positions =NA)
il10_main_contrasts <- combined_lmm_list[[9]]%>%
  model_main_to_plot(x=., type = "contrast", p_positions = NA)
il10_main_plot<- combined_lmm_list[[9]]%>%
  model_main_to_plot(x=., type = "plot", p_positions = NA)
il10_main_point_plot<-
  combined_lmm_list[[9]]%>%
  model_main_to_plot(x=., type = "point_plot", p_positions = NA)
il10_main_emmeans
il10_main_contrasts

ggsave(
  filename= here("output", "Acute Bout", "graphics", "il10_main_plot.jpg"),
  plot = il10_main_plot +
    labs(
      title = "IL-10 Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-10 (pg/ml)"
    ) )

ggsave(
  filename= here("output", "Acute Bout", "graphics", "il10_main_point_plot.jpg"),
  plot = il10_main_point_plot +
    labs(
      title = "IL-10 Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-10 (pg/ml)"
    ))


il1a_main_emmeans <- combined_lmm_list[[11]]%>%
  model_main_to_plot(x=., type = "emmeans", p_positions = NA)
il1a_main_contrasts <- combined_lmm_list[[11]]%>%
  model_main_to_plot(x=., type = "contrast", p_positions = NA)
il1a_main_plot<- combined_lmm_list[[11]]%>%
  model_main_to_plot(x=., type = "plot", p_positions = NA)
il1a_main_point_plot<-
  combined_lmm_list[[11]]%>%
  model_main_to_plot(x=., type = "point_plot", p_positions =NA)
il1a_main_emmeans
il1a_main_contrasts

ggsave(
  filename= here("output", "Acute Bout", "graphics", "il1a_main_plot.jpg"),
  plot =
    il1a_main_plot +
    labs(
      title = "IL-1a Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-1a (pg/ml)"
    )  )
ggsave(
  filename= here("output", "Acute Bout", "graphics", "il1a_main_point_plot.jpg"),
  plot = il1a_main_point_plot +
    labs(
      title = "IL-1a Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-1a (pg/ml)"
    ))


il1_ra_main_emmeans <- combined_lmm_list[[13]]%>%
  model_main_to_plot(x=., type = "emmeans", p_positions = NA)
il1_ra_main_contrasts <- combined_lmm_list[[13]]%>%
  model_main_to_plot(x=., type = "contrast", p_positions = NA)
il1_ra_main_plot<- combined_lmm_list[[13]]%>%
  model_main_to_plot(x=., type = "plot", p_positions = NA)
il1_ra_main_point_plot<-
  combined_lmm_list[[13]]%>%
  model_main_to_plot(x=., type = "point_plot", p_positions = NA)
il1_ra_main_emmeans
il1_ra_main_contrasts

ggsave(
  filename= here("output", "Acute Bout", "graphics", "il1ra_main_plot.jpg"),
  plot = il1_ra_main_plot +
    labs(
      title = "IL-1ra Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-1ra (pg/ml)"
    )  )
ggsave(
  filename= here("output", "Acute Bout", "graphics", "il1ra_main_point_plot.jpg"),
  plot = il1_ra_main_point_plot  +
    labs(
      title = "IL-1ra Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-1ra (pg/ml)"
    ))

il2_main_emmeans <- combined_lmm_list[[15]]%>%
  model_main_to_plot(x=., type = "emmeans", p_positions =NA)
il2_main_contrasts <- combined_lmm_list[[15]]%>%
  model_main_to_plot(x=., type = "contrast", p_positions = NA)
il2_main_plot<- combined_lmm_list[[15]]%>%
  model_main_to_plot(x=., type = "plot", p_positions = NA)
il2_main_point_plot<-
  combined_lmm_list[[15]]%>%
  model_main_to_plot(x=., type = "point_plot", p_positions =NA)
il2_main_emmeans
il2_main_contrasts

ggsave(
  filename= here("output", "Acute Bout", "graphics", "il2_main_plot.jpg"),
  plot = il2_main_plot +
    labs(
      title = "IL-2 Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-2 (pg/ml)"
    )  )

ggsave(
  filename= here("output", "Acute Bout", "graphics", "il2_main_point_plot.jpg"),
  plot =
    il2_main_point_plot  +
    labs(
      title = "IL-2 Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-2 (pg/ml)"
    )  )


tnf_main_emmeans <- combined_lmm_list[[17]]%>%
  model_main_to_plot(x=., type = "emmeans", p_positions = NA)
tnf_main_contrasts <- combined_lmm_list[[17]]%>%
  model_main_to_plot(x=., type = "contrast", p_positions = NA)
tnf_main_plot<- combined_lmm_list[[17]]%>%
  model_main_to_plot(x=., type = "plot", p_positions = NA)
tnf_main_point_plot<-
  combined_lmm_list[[17]]%>%
  model_main_to_plot(x=., type = "point_plot", p_positions = NA)
tnf_main_emmeans
tnf_main_contrasts

ggsave(
  filename= here("output", "Acute Bout", "graphics", "tnf_main_plot.jpg"),
  plot = 
    tnf_main_plot +
    labs(
      title = "TNF Concentration during acute bout",
      x = "Time during bout (min)",
      y = "TNF (pg/ml)"
    ))

ggsave(
  filename= here("output", "Acute Bout", "graphics", "tnf_main_point_plot.jpg"),
  plot =
    tnf_main_point_plot +
    labs(
      title = "TNFConcentration during acute bout",
      x = "Time during bout (min)",
      y = "TNF (pg/ml)"
    )  )


```

#Plot interaction effects

```{r}

IL_6_interaction_emmeans <- combined_lmm_list[[2]]%>%
  model_interaction_to_plot(x=., type = "emmeans", p_positions = NA)
IL_6_interaction_contrasts <- combined_lmm_list[[2]]%>%
  model_interaction_to_plot(x=., type = "contrast", p_positions = NA)
IL_6_interaction_plot<- combined_lmm_list[[2]]%>%
  model_interaction_to_plot(x=., type = "plot", p_positions =NA)
IL_6_interaction_point_plot<-
  combined_lmm_list[[2]]%>%
  model_interaction_to_plot(x=., type = "point_plot", p_positions = NA)
IL_6_interaction_emmeans
IL_6_interaction_contrasts
ggsave(
  filename= here("output", "Acute Bout", "graphics", "il6_interaction_plot.jpg"),
  plot = IL_6_interaction_plot +
    labs(
      title = "IL-6 Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-6 (pg/ml)"
    ))

ggsave(
  filename= here("output", "Acute Bout", "graphics", "il6_interaction_point_plot.jpg"), 
  plot=
    IL_6_interaction_point_plot  +
    labs(
      title = "IL-6 Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-6 (pg/ml)"
    )  )

IL_6r_interaction_emmeans <- combined_lmm_list[[4]]%>%
  model_interaction_to_plot(x=., type = "emmeans", p_positions = NA)
IL_6r_interaction_contrasts <- combined_lmm_list[[4]]%>%
  model_interaction_to_plot(x=., type = "contrast", p_positions = NA)
IL_6r_interaction_plot<- combined_lmm_list[[4]]%>%
  model_interaction_to_plot(x=., type = "plot", p_positions = NA)
IL_6r_interaction_point_plot<-
  combined_lmm_list[[4]]%>%
  model_interaction_to_plot(x=., type = "point_plot", p_positions = NA)
IL_6r_interaction_emmeans
IL_6r_interaction_contrasts
ggsave(
  filename= here("output", "Acute Bout", "graphics", "il6r_interaction_plot.jpg"), plot = 
    IL_6r_interaction_plot  +
    labs(
      title = "IL-6r Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-6r (pg/ml)"
    ))

ggsave(
  filename= here("output", "Acute Bout", "graphics", "il6r_interaction_point_plot.jpg"),
  IL_6r_interaction_point_plot  +
    labs(
      title = "IL-6r Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-6r (pg/ml)"))


crp_interaction_emmeans <- combined_lmm_list[[6]]%>%
  model_interaction_to_plot(x=., type = "emmeans", p_positions = NA)
crp_interaction_contrasts <- combined_lmm_list[[6]]%>%
  model_interaction_to_plot(x=., type = "contrast", p_positions = NA)
crp_interaction_plot<- combined_lmm_list[[6]]%>%
  model_interaction_to_plot(x=., type = "plot", p_positions = NA)
crp_interaction_point_plot<-
  combined_lmm_list[[6]]%>%
  model_interaction_to_plot(x=., type = "point_plot", p_positions = NA)
crp_interaction_emmeans
crp_interaction_contrasts

ggsave(
  filename= here("output", "Acute Bout", "graphics", "crp_interaction_plot.jpg"),
  plot=crp_interaction_plot  +
    labs(
      title = "CRP Concentration during acute bout",
      x = "Time during bout (min)",
      y = "crp (mg/ml)"
    ))


ggsave(
  filename= here("output", "Acute Bout", "graphics", "crp_interaction_point_plot.jpg"),  
  crp_interaction_point_plot +
    labs(
      title = "CRP Concentration during acute bout",
      x = "Time during bout (min)",
      y = "crp (mg/ml)"
    ))


ifng_interaction_emmeans <- combined_lmm_list[[8]]%>%
  model_interaction_to_plot(x=., type = "emmeans", p_positions = NA)
ifng_interaction_contrasts <- combined_lmm_list[[8]]%>%
  model_interaction_to_plot(x=., type = "contrast", p_positions = NA)
ifng_interaction_plot<- combined_lmm_list[[8]]%>%
  model_interaction_to_plot(x=., type = "plot", p_positions = NA)
ifng_interaction_point_plot<-
  combined_lmm_list[[8]]%>%
  model_interaction_to_plot(x=., type = "point_plot", p_positions = NA)
ifng_interaction_emmeans
ifng_interaction_contrasts

ggsave(
  filename= here("output", "Acute Bout", "graphics", "ifng_interaction_plot.jpg"),
  plot = ifng_interaction_plot +
    labs(
      title = "IFN-\u03b3 Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IFN-\u03b3 (pg/ml)"
    ))

ggsave(
  filename= here("output", "Acute Bout", "graphics", "ifng_interaction_point_plot.jpg"),
  plot = ifng_interaction_point_plot +
    labs(
      title = "IFN-\u03b3 Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IFN-\u03b3 (pg/ml)"
    ))

il10_interaction_emmeans <- combined_lmm_list[[10]]%>%
  model_interaction_to_plot(x=., type = "emmeans", p_positions =NA)
il10_interaction_contrasts <- combined_lmm_list[[10]]%>%
  model_interaction_to_plot(x=., type = "contrast", p_positions = NA)
il10_interaction_plot<- combined_lmm_list[[10]]%>%
  model_interaction_to_plot(x=., type = "plot", p_positions = NA)
il10_interaction_point_plot<-
  combined_lmm_list[[10]]%>%
  model_interaction_to_plot(x=., type = "point_plot", p_positions = NA)
il10_interaction_emmeans
il10_interaction_contrasts

ggsave(
  filename= here("output", "Acute Bout", "graphics", "il10_interaction_plot.jpg"),
  plot = il10_interaction_plot +
    labs(
      title = "IL-10 Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-10 (pg/ml)"
    ) )

ggsave(
  filename= here("output", "Acute Bout", "graphics", "il10_interaction_point_plot.jpg"),
  plot = il10_interaction_point_plot +
    labs(
      title = "IL-10 Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-10 (pg/ml)"
    ))


il1a_interaction_emmeans <- combined_lmm_list[[12]]%>%
  model_interaction_to_plot(x=., type = "emmeans", p_positions = NA)
il1a_interaction_contrasts <- combined_lmm_list[[12]]%>%
  model_interaction_to_plot(x=., type = "contrast", p_positions = NA)
il1a_interaction_plot<- combined_lmm_list[[12]]%>%
  model_interaction_to_plot(x=., type = "plot", p_positions = NA)
il1a_interaction_point_plot<-
  combined_lmm_list[[12]]%>%
  model_interaction_to_plot(x=., type = "point_plot", p_positions =NA)
il1a_interaction_emmeans
il1a_interaction_contrasts

ggsave(
  filename= here("output", "Acute Bout", "graphics", "il1a_interaction_plot.jpg"),
  plot =
    il1a_interaction_plot +
    labs(
      title = "IL-1a Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-1a (pg/ml)"
    )  )
ggsave(
  filename= here("output", "Acute Bout", "graphics", "il1a_interaction_point_plot.jpg"),
  plot = il1a_interaction_point_plot +
    labs(
      title = "IL-1a Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-1a (pg/ml)"
    ))


il1_ra_interaction_emmeans <- combined_lmm_list[[14]]%>%
  model_interaction_to_plot(x=., type = "emmeans", p_positions = NA)
il1_ra_interaction_contrasts <- combined_lmm_list[[14]]%>%
  model_interaction_to_plot(x=., type = "contrast", p_positions = NA)
il1_ra_interaction_plot<- combined_lmm_list[[14]]%>%
  model_interaction_to_plot(x=., type = "plot", p_positions = NA)
il1_ra_interaction_point_plot<-
  combined_lmm_list[[14]]%>%
  model_interaction_to_plot(x=., type = "point_plot", p_positions = NA)
il1_ra_interaction_emmeans
il1_ra_interaction_contrasts

ggsave(
  filename= here("output", "Acute Bout", "graphics", "il1ra_interaction_plot.jpg"),
  plot = il1_ra_interaction_plot +
    labs(
      title = "IL-1ra Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-1ra (pg/ml)"
    )  )
ggsave(
  filename= here("output", "Acute Bout", "graphics", "il1ra_interaction_point_plot.jpg"),
  plot = il1_ra_interaction_point_plot  +
    labs(
      title = "IL-1ra Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-1ra (pg/ml)"
    ))

il2_interaction_emmeans <- combined_lmm_list[[16]]%>%
  model_interaction_to_plot(x=., type = "emmeans", p_positions =NA)
il2_interaction_contrasts <- combined_lmm_list[[16]]%>%
  model_interaction_to_plot(x=., type = "contrast", p_positions = NA)
il2_interaction_plot<- combined_lmm_list[[16]]%>%
  model_interaction_to_plot(x=., type = "plot", p_positions = NA)
il2_interaction_point_plot<-
  combined_lmm_list[[16]]%>%
  model_interaction_to_plot(x=., type = "point_plot", p_positions =NA)
il2_interaction_emmeans
il2_interaction_contrasts

ggsave(
  filename= here("output", "Acute Bout", "graphics", "il2_interaction_plot.jpg"),
  plot = il2_interaction_plot +
    labs(
      title = "IL-2 Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-2 (pg/ml)"
    )  )

ggsave(
  filename= here("output", "Acute Bout", "graphics", "il2_interaction_point_plot.jpg"),
  plot =
    il2_interaction_point_plot  +
    labs(
      title = "IL-2 Concentration during acute bout",
      x = "Time during bout (min)",
      y = "IL-2 (pg/ml)"
    )  )


tnf_interaction_emmeans <- combined_lmm_list[[18]]%>%
  model_interaction_to_plot(x=., type = "emmeans", p_positions = NA)
tnf_interaction_contrasts <- combined_lmm_list[[18]]%>%
  model_interaction_to_plot(x=., type = "contrast", p_positions = NA)
tnf_interaction_plot<- combined_lmm_list[[18]]%>%
  model_interaction_to_plot(x=., type = "plot", p_positions = NA)
tnf_interaction_point_plot<-
  combined_lmm_list[[18]]%>%
  model_interaction_to_plot(x=., type = "point_plot", p_positions = NA)
tnf_interaction_emmeans
tnf_interaction_contrasts

ggsave(
  filename= here("output", "Acute Bout", "graphics", "tnf_interaction_plot.jpg"),
  plot = 
    tnf_interaction_plot +
    labs(
      title = "TNF Concentration during acute bout",
      x = "Time during bout (min)",
      y = "TNF (pg/ml)"
    ))

ggsave(
  filename= here("output", "Acute Bout", "graphics", "tnf_interaction_point_plot.jpg"),
  plot =
    tnf_interaction_point_plot +
    labs(
      title = "TNFConcentration during acute bout",
      x = "Time during bout (min)",
      y = "TNF (pg/ml)"
    )  )



```

##Adding Zones (doesn't really work, is it required?)

```{r}
zone_data <-
  data.frame(
    lower = -Inf,
    upper = Inf,
    start_min = c(0, 10, 14, 17, 21, 24, 28, 31, 35, 45),
    end_min = c(10, 14, 17, 21, 24, 28, 31, 35, 45, 105),
    position = 1:10,
    text = c("Warmup", "High Intensity Interval", "Active Rest", 
                       "High Intensity Interval", "Active Rest", 
                       "High Intensity Interval", "Active Rest", 
                       "High Intensity Interval", 
             "Cooldown", "Rest"),
    color = c("lightgreen", "red", "lightblue",
                          "red", "lightblue",
                          "red", "lightblue",
                          "red", 
            "lightgreen", "white")
  )

  


```

```{r eval=F}
for(ter in tertials){
out[which(tertials == ter)]$tertial<-ter  
out[which(tertials == ter)]<-
  multcomp2table(log2_IL_6_Acute_bout_interaction,
               transform = back2,
               method = "glht",
               method.multcomp="none",
               link=c(  paste0("(Intercept)+ifn_1_netto", "*",as.character(ter),"= 0")))}

out

 multcomp2table(log2_IL_6r_Acute_bout_interaction,
               transform = back2,
               method = "glht",
               method.multcomp="none",
               link=c(  paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[1]),"= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[2]),"= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[3]),"= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[1]),
                               "+time_wd_glht0+",as.character(tertials[1]),
                               "*ifn_1_netto:time_wd_glht0", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[2]),
                               "+time_wd_glht0+",as.character(tertials[2]),
                               "*ifn_1_netto:time_wd_glht0", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[3]),
                               "+time_wd_glht0+",as.character(tertials[3]),
                               "*ifn_1_netto:time_wd_glht0", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[1]),
                               "+time_wd_glht10+",as.character(tertials[1]),
                               "*ifn_1_netto:time_wd_glht10", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[2]),
                               "+time_wd_glht10+",as.character(tertials[2]),
                               "*ifn_1_netto:time_wd_glht10", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[3]),
                               "+time_wd_glht10+",as.character(tertials[3]),
                               "*ifn_1_netto:time_wd_glht10", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[1]),
                               "+time_wd_glht14+",as.character(tertials[1]),
                               "*ifn_1_netto:time_wd_glht14", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[2]),
                               "+time_wd_glht14+",as.character(tertials[2]),
                               "*ifn_1_netto:time_wd_glht14", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[3]),
                               "+time_wd_glht14+",as.character(tertials[3]),
                               "*ifn_1_netto:time_wd_glht14", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[1]),
                               "+time_wd_glht35+",as.character(tertials[1]),
                               "*ifn_1_netto:time_wd_glht35", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[2]),
                               "+time_wd_glht35+",as.character(tertials[2]),
                               "*ifn_1_netto:time_wd_glht35", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[3]),
                               "+time_wd_glht35+",as.character(tertials[3]),
                               "*ifn_1_netto:time_wd_glht35", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[1]),
                               "+time_wd_glht45+",as.character(tertials[1]),
                               "*ifn_1_netto:time_wd_glht45", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[2]),
                               "+time_wd_glht45+",as.character(tertials[2]),
                               "*ifn_1_netto:time_wd_glht45", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[3]),
                               "+time_wd_glht45+",as.character(tertials[3]),
                               "*ifn_1_netto:time_wd_glht45", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[1]),
                               "+time_wd_glht60+",as.character(tertials[1]),
                               "*ifn_1_netto:time_wd_glht60", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[2]),
                               "+time_wd_glht60+",as.character(tertials[2]),
                               "*ifn_1_netto:time_wd_glht60", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[3]),
                               "+time_wd_glht60+",as.character(tertials[3]),
                               "*ifn_1_netto:time_wd_glht60", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[1]),
                               "+time_wd_glht90+",as.character(tertials[1]),
                               "*ifn_1_netto:time_wd_glht90", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[2]),
                               "+time_wd_glht90+",as.character(tertials[2]),
                               "*ifn_1_netto:time_wd_glht90", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[3]),
                               "+time_wd_glht90+",as.character(tertials[3]),
                               "*ifn_1_netto:time_wd_glht90", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[1]),
                               "+time_wd_glht105+",as.character(tertials[1]),
                               "*ifn_1_netto:time_wd_glht105", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[2]),
                               "+time_wd_glht105+",as.character(tertials[2]),
                               "*ifn_1_netto:time_wd_glht105", "= 0"),
                        paste0("(Intercept)+ifn_1_netto", "*",as.character(tertials[3]),
                               "+time_wd_glht105+",as.character(tertials[3]),
                               "*ifn_1_netto:time_wd_glht105", "= 0")
                        ))%>%
      mutate(
      tert = rep(factor(c("0-33%","33-66%","66-100%"), 
                        levels = c("0-33%","33-66%","66-100%")), length(rownames(emmeans))/3),
      timepoint = factor(c(rep("baseline",27)
                           ), levels=c("baseline","followup") ),
      treat2 = factor(c(rep("baseline",27)
                        ), levels=c("baseline","control","exercise") )
    )
```

### GLHT Contrasts

```{r eval =  F}

Cont_vec_baseline <- #is it really contrasts though?
  rbind(
    c( #at t-5
      1, #"(Intercept)"        
      0, #"time_wd_glht0"   
      0, #"time_within_day10"  
      0, #"time_within_day14"
      0, #"time_within_day35" 
      0, #"time_within_day45" 
      0, #"time_within_day60" 
      0, #"time_within_day90" 
      0), #"time_within_day105"Intercept)
    c( #at t0
      1, #"(Intercept)"        
      1, #"time_within_day0"   
      0, #"time_within_day10"  
      0, #"time_within_day14"
      0, #"time_within_day35" 
      0, #"time_within_day45" 
      0, #"time_within_day60" 
      0, #"time_within_day90" 
      0), #"time_within_day105"Intercept)
    c( #at t10
      1, #"(Intercept)"        
      0, #"time_within_day0"   
      1, #"time_within_day10"  
      0, #"time_within_day14"
      0, #"time_within_day35" 
      0, #"time_within_day45" 
      0, #"time_within_day60" 
      0, #"time_within_day90" 
      0), #"time_within_day105"Intercept)
    c( #at t-5
      1, #"(Intercept)"        
      0, #"time_within_day0"   
      0, #"time_within_day10"  
      1, #"time_within_day14"
      0, #"time_within_day35" 
      0, #"time_within_day45" 
      0, #"time_within_day60" 
      0, #"time_within_day90" 
      0), #"time_within_day105"Intercept)
    c( #at t0
      1, #"(Intercept)"        
      0, #"time_within_day0"   
      0, #"time_within_day10"  
      0, #"time_within_day14"
      1, #"time_within_day35" 
      0, #"time_within_day45" 
      0, #"time_within_day60" 
      0, #"time_within_day90" 
      0), #"time_within_day105"Intercept)
    c( #at t10
      1, #"(Intercept)"        
      0, #"time_within_day0"   
      0, #"time_within_day10"  
      0, #"time_within_day14"
      0, #"time_within_day35" 
      1, #"time_within_day45" 
      0, #"time_within_day60" 
      0, #"time_within_day90" 
      0), #"time_within_day105"Intercept)
    c( #at t-5
      1, #"(Intercept)"        
      0, #"time_within_day0"   
      0, #"time_within_day10"  
      0, #"time_within_day14"
      0, #"time_within_day35" 
      0, #"time_within_day45" 
      1, #"time_within_day60" 
      0, #"time_within_day90" 
      0), #"time_within_day105"Intercept)
    c( #at t0
      1, #"(Intercept)"        
      0, #"time_within_day0"   
      0, #"time_within_day10"  
      0, #"time_within_day14"
      0, #"time_within_day35" 
      0, #"time_within_day45" 
      0, #"time_within_day60" 
      1, #"time_within_day90" 
      0), #"time_within_day105"Intercept)
    c( #at t10
      1, #"(Intercept)"        
      0, #"time_within_day0"   
      0, #"time_within_day10"  
      0, #"time_within_day14"
      0, #"time_within_day35" 
      0, #"time_within_day45" 
      0, #"time_within_day60" 
      0, #"time_within_day90" 
      1) #"time_within_day105"
  )
	
rownames(Cont_vec_baseline) <- c("-5",
                            "0",
                            "10",
                            "14",
                            "35",
                            "45",
                            "60",
                            "90",
                            "105")
```

### Baseline

```{r eval =T}
snake_case_Acute_Bout_Data_baseline<-
  snake_case_Acute_Bout_Data%>%
  dplyr::filter(
    grepl("baseline", timepoint)
  )

log2_snake_case_Acute_Bout_Data_baseline<-
  log2_snake_case_Acute_Bout_Data%>%
    dplyr::filter(
      grepl("baseline", timepoint))
```

```{r eval =F}
#Models only done on log-transformed data to preserve normality
log2_IL_6_Acute_bout_main_baseline<-
lmm(
  formula = 
    il_6_calc_conc_mean_pg_m_l ~ 
    #sex+
    #treat+
    time_within_day,
    #timepoint_time_within_day+
    #timepoint_time_within_day:treat,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_baseline
)
plot(log2_IL_6_Acute_bout_main_baseline, type = "qqplot")
plot(log2_IL_6_Acute_bout_main_baseline, type = "scatterplot")
plot(log2_IL_6_Acute_bout_main_baseline, type = "scatterplot2")
summary(log2_IL_6_Acute_bout_main_baseline)
mt_log2_il_6<-model.tables(log2_IL_6_Acute_bout_main_baseline)
mt_log2_il_6$time_within_day<-
                  factor(c("-5",
                            "0",
                            "10",
                            "14",
                            "35",
                            "45",
                            "60",
                            "90",
                            "105"),
                         levels = 
                           c("-5",
                            "0",
                            "10",
                            "14",
                            "35",
                            "45",
                            "60",
                            "90",
                            "105"))

generalized_lin_log2_IL_6_baseline<-
  glht(log2_IL_6_Acute_bout_main_baseline, linfct=Cont_vec_baseline)
summary(generalized_lin_log2_IL_6_baseline, test=adjusted("none"))

CI_generalized_lin_log2_IL_6_baseline<-
  confint(generalized_lin_log2_IL_6_baseline, test=adjusted("none"), level = 0.95)

CI_backtransform_il6<-
  round(2^as_tibble(CI_generalized_lin_log2_IL_6_baseline$confint),2)
CI_backtransform_il6$time_within_day<-
                  factor(c("-5",
                            "0",
                            "10",
                            "14",
                            "35",
                            "45",
                            "60",
                            "90",
                            "105"),
                         levels = 
                           c("-5",
                            "0",
                            "10",
                            "14",
                            "35",
                            "45",
                            "60",
                            "90",
                            "105"))


mt_log2_il_6_no_init <- 
  mt_log2_il_6|>
  mutate(unlog_estimate = CI_backtransform_il6$Estimate,
         p_lab = case_when(p.value >0.9999 ~ "p > 0.9999",
                           p.value <0.0001 ~ "p < 0.0001*",
                           T~ paste0("p = ",round(p.value, 4), ifelse(p.value<0.05, "*",""))
                           ))|>
  dplyr::filter(time_within_day != "-5")
CI_backtransform_il6|>left_join(mt_log2_il_6)

IL6_plot<-
  snake_case_Acute_Bout_Data_baseline %>%
  ggplot(aes(x = time_within_day, y = il_6_calc_conc_mean_pg_m_l))+
  geom_point(position = position_jitter(width = 0.2))+
  #geom_point(data=CI_backtransform_il6, aes(x=time_within_day, y = Estimate, col = "hotpink"), inherit.aes = F)+
  geom_crossbar(
    data = CI_backtransform_il6, 
    aes(ymin = lwr, ymax = upr, y = Estimate, x = time_within_day, col = "hotpink"), 
    inherit.aes = F)+
  labs(
  title = "IL-6 at baseline bout",
  x = "Time During Bout (mins)",
  y = "IL-6 pg/ml")+
  theme_bw()+
  theme(legend.position='none')+
  geom_text(data = mt_log2_il_6_no_init, 
            inherit.aes = F, 
            aes( x = time_within_day, y =0 , label = p_lab),
            size = 3,
            position_dodge=0.2)
IL6_plot

##Baseline Models in a for loop:
```

### Baseline \_Interaction Model

```{r eval =F}
log2_IL_6_Acute_bout_interaction_baseline<-
lmm(
  formula = 
    il_6_calc_conc_mean_pg_m_l ~ 
    #sex+
    #treat+
    time_within_day+
    ifn_1_netto+
    time_within_day:ifn_1_netto,
    #timepoint_time_within_day+
    #timepoint_time_within_day:treat,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_baseline
)
plot(log2_IL_6_Acute_bout_interaction_baseline, type = "qqplot")
plot(log2_IL_6_Acute_bout_interaction_baseline, type = "scatterplot")
plot(log2_IL_6_Acute_bout_interaction_baseline, type = "scatterplot2")
summary(log2_IL_6_Acute_bout_interaction_baseline)

#TODO read up on 3d plots
#plot_ly(x=log2_snake_case_Acute_Bout_Data_baseline$time_within_day, 
 #       y=log2_snake_case_Acute_Bout_Data_baseline$il_6_calc_conc_mean_pg_m_l, 
  #      z=log2_snake_case_Acute_Bout_Data_baseline$ifn_1_netto, 
   #     type="scatter3d", 
    #    mode="markers", 
     #   color=log2_snake_case_Acute_Bout_Data_baseline$ifn_1_netto)

log2_snake_case_Acute_Bout_Data_baseline%>%
  ggplot(aes(x = time_within_day, y = il_6_calc_conc_mean_pg_m_l, color = ifn_1_netto,group = id))+
  geom_point()+
  geom_line()
```

#### For Loop - Baseline Models in a for loop

```{r eval = F}
outcomes <- c("il_6_calc_conc_mean_pg_m_l","il_6_r_calc_conc_mean_pg_m_l", "crp_mg_ml","beta_2_mikroglobuline",
              "hemoglobin", "leukocytes", "thrombocytes", "ifn_gamma_calc_conc_mean_pg_m_l",
              #"il_1_a_calc_conc_mean_pg_m_l",
              "il_1_ra_calc_conc_mean_pg_m_l", "il_10_calc_conc_mean_pg_m_l","il_2_calc_conc_mean_pg_m_l","tnf_calc_conc_mean_pg_m_l"             )
r_pvalues = 4
models.baseline.df<-
  data.frame(
    outcome =double(),
    time_within_day=factor(),
    Estimate=double(),
    lwr = double(),
    upr = double(),
    p.value= double(),
    unlog_estimate = double(),
    p_lab = character(),
    stringsAsFactors=FALSE
  )
  

for(outcome in outcomes){
  
  model<-
lmm(
  formula = reformulate(
    termlabels = "time_within_day",
    response = outcome
  ),
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_baseline
)
  
  generalized<-
  glht(model, 
       linfct=Cont_vec_baseline)
  
    CI_glht <-
  confint(generalized, 
          #test=adjusted("none"), 
          level = 0.95) 

  CI_backtransform<-
  round(2^as_tibble(CI_glht$confint),2)
  
  CI_backtransform$time_within_day<-
                  factor(
                    c(  "-5",
                         "0",
                        "10",
                        "14",
                        "35",
                        "45",
                        "60",
                        "90",
                        "105"),
                         levels = 
                        c("-5",
                           "0",
                          "10",
                          "14",
                          "35",
                          "45",
                          "60",
                          "90",
                          "105"))

  
  mt <- model.tables(model)
  mt$time_within_day<-
                  factor(c("-5",
                            "0",
                            "10",
                            "14",
                            "35",
                            "45",
                            "60",
                            "90",
                            "105"),
                         levels = 
                           c("-5",
                            "0",
                            "10",
                            "14",
                            "35",
                            "45",
                            "60",
                            "90",
                            "105"))
  
  mt_p_values <- 
    mt|>
      mutate(
        unlog_estimate = CI_backtransform$Estimate,
         p_lab = case_when(p.value >0.9999 ~ "p > 0.9999",
                           p.value <0.0001 ~ "p < 0.0001*",
                           T~ paste0("p = ",round(p.value, r_pvalues), 
                                     ifelse(p.value<0.05, "*",""))
                           ))|>
    dplyr::select(
      time_within_day,
      p.value,
      unlog_estimate,
      p_lab
    )
  
  out_model<-
    CI_backtransform%>%
      left_join(mt_p_values, by=join_by(time_within_day))|>
        mutate(
          outcome = outcome
              )|>
    relocate(
      outcome, time_within_day
    )
  
  assign(
    x = paste0("lmm_log_",outcome,"table_for_plot"),
    value = out_model
  )
  
  models.baseline.df<-
    models.baseline.df|>
    rbind(out_model)
}

saveRDS(models.baseline.df,
        file = here(
          "Output",
          "Acute Bout",
          "RDS_Models",
          "models_baseline_df.rds"
        ))
```

##Graphics Baseline models

```{r eval = F}

models.baseline.df<-
  readRDS(file = here(
          "Output",
          "Acute Bout",
          "RDS_Models",
          "models_baseline_df.rds"
        ))

mark_time_zones<-
  annotate("rect", xmin = 0, xmax = 10, ymin = -10^99, ymax = 10^99, col = "lightblue",  alpha = .2, inherit.aes=F)

IL6_plot<-
  snake_case_Acute_Bout_Data_baseline %>%
  ggplot(aes(x = time_within_day, y = il_6_calc_conc_mean_pg_m_l, group = id))+
  geom_point(position = position_jitter(width = 0.2))+
  geom_line(position = position_jitter(width = 0.2))+
  #geom_point(data=CI_backtransform_il6, aes(x=time_within_day, y = Estimate, col = "hotpink"), inherit.aes = F)+
  geom_crossbar(
    data = models.baseline.df %>%
      dplyr::filter(
        outcome == "il_6_calc_conc_mean_pg_m_l"
      ), 
    aes(ymin = lwr, ymax = upr, y = Estimate, x = time_within_day, col = "hotpink"), 
    inherit.aes = F)+
  labs(
    title = "IL-6 at baseline bout",
    x = "Time During Bout (mins)",
    y = "IL-6 pg/ml")+
  theme_bw()+
  theme(legend.position='none')+
  geom_text(data = models.baseline.df %>%
      dplyr::filter(
        outcome == "il_6_calc_conc_mean_pg_m_l"
      )%>%
      dplyr::filter(
        time_within_day != "-5"
      ), 
            inherit.aes = F, 
            aes( x = time_within_day, y =0 , label = p_lab),
            size = 3,
            position = position_dodge(0.2))
IL6_plot


IL6r_plot<-
  snake_case_Acute_Bout_Data_baseline %>%
  ggplot(aes(x = as.numeric(as.character(time_within_day)), y = il_6_r_calc_conc_mean_pg_m_l, group = id))+
  geom_point(position = position_jitter(width = 0.2))+
  #geom_line(position = position_jitter(width = 0.2))+
  #geom_point(data=CI_backtransform_il6, aes(x=time_within_day, y = Estimate, col = "hotpink"), inherit.aes = F)+
  geom_crossbar(
    data = models.baseline.df %>%
      dplyr::filter(
        outcome == "il_6_r_calc_conc_mean_pg_m_l"
      ), 
    aes(ymin = lwr, ymax = upr, y = Estimate, x = as.numeric(as.character(time_within_day)), col = "hotpink"), 
    inherit.aes = F)+
  labs(
    title = "IL-6r at baseline bout",
    x = "Time During Bout (mins)",
    y = "IL-6r pg/ml")+
  theme_bw()+
  theme(legend.position='none')+
  geom_text(data = models.baseline.df %>%
      dplyr::filter(
        outcome == "il_6_r_calc_conc_mean_pg_m_l"
      )%>%
      dplyr::filter(
        time_within_day != "-5"
      ), 
            inherit.aes = F, 
            aes( x = as.numeric(as.character(time_within_day)), y =0 , label = p_lab),
            size = 3,
            position="jitter")


IL6r_plot

beta_2_mikroglobuline_plot<-
  snake_case_Acute_Bout_Data_baseline %>%
  ggplot(aes(x = time_within_day, y = beta_2_mikroglobuline))+
  geom_point(position = position_jitter(width = 0.2))+
  #geom_point(data=CI_backtransform_il6, aes(x=time_within_day, y = Estimate, col = "hotpink"), inherit.aes = F)+
  geom_crossbar(
    data = models.baseline.df %>%
      dplyr::filter(
        outcome == "beta_2_mikroglobuline"
      ), 
    aes(ymin = lwr, ymax = upr, y = Estimate, x = time_within_day, col = "hotpink"), 
    inherit.aes = F)+
  labs(
    title = "Beta 2 Microglobuline at baseline bout",
    x = "Time During Bout (mins)",
    y = "Beta 2 Microglobuline mg/ml")+
  theme_bw()+
  theme(legend.position='none')+
  geom_text(data = models.baseline.df %>%
      dplyr::filter(
        outcome == "beta_2_mikroglobuline"
      )%>%
      dplyr::filter(
        time_within_day != "-5"
      ), 
            inherit.aes = F, 
            aes( x = time_within_day, y =0 , label = p_lab),
            size = 3,
            position_dodge=0.2)

beta_2_mikroglobuline_plot



```

###Followup \#### Data sets

```{r eval = T}
snake_case_Acute_Bout_Data_followup<-
  snake_case_Acute_Bout_Data%>%
  dplyr::filter(
    grepl("follow", timepoint)
  )

log2_snake_case_Acute_Bout_Data_followup<-
  log2_snake_case_Acute_Bout_Data%>%
    dplyr::filter(
      grepl("follow", timepoint))
```

####Contrasts Vectors Is it really contrasts though? I mean if we want to see the difference I guess it is.

```{r echo = F eval = F}

Cont_vec_followup <- #is it really contrasts though?
  rbind(
    c( #control at t-5
      1, #"(Intercept)"
      0, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #control at t0
      1, #"(Intercept)"
      0, #"treatexercise"
      1, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #control at t10
      1, #"(Intercept)"
      0, #"treatexercise"
      0, #"time_within_day0"
      1, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #control at t14
      1, #"(Intercept)"
      0, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      1, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #control at t35
      1, #"(Intercept)"
      0, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      1, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #control at t45
      1, #"(Intercept)"
      0, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      1, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #control at t60
      1, #"(Intercept)"
      0, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      1, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #control at t90
      1, #"(Intercept)"
      0, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      1, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #control at t105
      1, #"(Intercept)"
      0, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      1, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #exercise at t-5
      1, #"(Intercept)"
      1, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #exercise at t0
      1, #"(Intercept)"
      1, #"treatexercise"
      1, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      1, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #exercise at t10
      1, #"(Intercept)"
      1, #"treatexercise"
      0, #"time_within_day0"
      1, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      1, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #exercise at t14
      1, #"(Intercept)"
      1, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      1, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      1, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #exercise at t35
      1, #"(Intercept)"
      1, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      1, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      1, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #exercise at t45
      1, #"(Intercept)"
      1, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      1, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      1, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #exercise at t60
      1, #"(Intercept)"
      1, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      1, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      1, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #exercise at t90
      1, #"(Intercept)"
      1, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      1, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      1, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #exercise at t105
      1, #"(Intercept)"
      1, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      1, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      1 #"treatexercise:time_within_day105"
    ),
    c( #exercise - control at t-5
      0, #"(Intercept)"
      1, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #exercise - control at t0
      0, #"(Intercept)"
      1, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      1, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #exercise - control at t10
      0, #"(Intercept)"
      1, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      1, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #exercise - control at t14
      0, #"(Intercept)"
      1, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      1, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #exercise - control at t35
      0, #"(Intercept)"
      1, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      1, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #exercise - control at t45
      0, #"(Intercept)"
      1, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      1, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #exercise - control at t60
      0, #"(Intercept)"
      1, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      1, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #exercise - control at t90
      0, #"(Intercept)"
      1, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      1, #"treatexercise:time_within_day90"  
      0 #"treatexercise:time_within_day105"
    ),
    c( #exercise - control at t105
      0, #"(Intercept)"
      1, #"treatexercise"
      0, #"time_within_day0"
      0, #"time_within_day10"
      0, #"time_within_day14"
      0, #"time_within_day35"
      0, #"time_within_day45"
      0, #"time_within_day60"
      0, #"time_within_day90"
      0, #"time_within_day105"
      0, #"treatexercise:time_within_day0"
      0, #"treatexercise:time_within_day10" 
      0, #"treatexercise:time_within_day14"
      0, #"treatexercise:time_within_day35" 
      0, #"treatexercise:time_within_day45" 
      0, #"treatexercise:time_within_day60"  
      0, #"treatexercise:time_within_day90"  
      1 #"treatexercise:time_within_day105"
    )
  )
	
rownames(Cont_vec_followup) <- 
                          c("control -5",
                            "control 0",
                            "control 10",
                            "control 14",
                            "control 35",
                            "control 45",
                            "control 60",
                            "control 90",
                            "control 105",
                            "exercise -5",
                            "exercise 0",
                            "exercise 10",
                            "exercise 14",
                            "exercise 35",
                            "exercise 45",
                            "exercise 60",
                            "exercise 90",
                            "exercise 105",
                            "exercise-control -5",
                            "exercise-control 0",
                            "exercise-control 10",
                            "exercise-control 14",
                            "exercise-control 35",
                            "exercise-control 45",
                            "exercise-control 60",
                            "exercise-control 90",
                            "exercise-control 105")

saveRDS(Cont_vec_followup,
        file = here("Output","Acute Bout", "RDS_models","Cont_vec_followup.RDS"))
```

#### Load Cont_vec from RDS (faster than re-initialising it)

```{r eval = F}
Cont_vec_followup<-
  readRDS(file = here("Output","Acute Bout", "RDS_models","Cont_vec_followup.RDS"))
```

## Other models

```{r eval = F}
plot_IL_6_Acute_bout_main_followup<-
  plot(IL_6_Acute_bout_main_followup,
     obs.alpha = 0.2,
     ci.alpha = 0.01)

IL_6_r_Acute_bout_main_followup<-
  lmm(
  formula = 
    il_6_r_calc_conc_mean_pg_m_l ~ 
    #sex+
    treat+
    time_within_day+
    time_within_day:treat,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = snake_case_Acute_Bout_Data_followup
)

summary(IL_6_r_Acute_bout_main_followup)
anova(IL_6_r_Acute_bout_main_followup)
plot_IL_6_r_Acute_bout_main_followup<-
  plot(IL_6_r_Acute_bout_main_followup,
     obs.alpha = 0.2,
     ci.alpha = 0.01)


IFN_g_Acute_bout_main_followup<-
  lmm(
  formula = 
    ifn_gamma_calc_conc_mean_pg_m_l ~ 
    #sex+
    treat+
    time_within_day+
    time_within_day:treat,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = snake_case_Acute_Bout_Data_followup
)
summary(IFN_g_Acute_bout_main_followup)
plot_IFN_g_Acute_bout_main_followup<-
  plot(IFN_g_Acute_bout_main_followup,
     obs.alpha = 0.2,
     ci.alpha = 0.01)


snake_case_Acute_Bout_Data_followup<-
  snake_case_Acute_Bout_Data_followup|>
  mutate(log2_ifn_g=
           log(ifn_gamma_calc_conc_mean_pg_m_l, base = 2))

log_IFN_g_Acute_bout_main_followup<-
  lmm(
  formula = 
    log2_ifn_g ~ 
    #sex+
    treat+
    time_within_day+
    time_within_day:treat,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = snake_case_Acute_Bout_Data_followup
)

summary(log_IFN_g_Acute_bout_main_followup)
plot_log_IFN_g_Acute_bout_main_followup<-
  plot(log_IFN_g_Acute_bout_main_followup,
     obs.alpha = 0.2,
     ci.alpha = 0.01)

il_10_Acute_bout_main_followup<-
  lmm(
  formula = 
    il_10_calc_conc_mean_pg_m_l ~ 
    #sex+
    treat+
    time_within_day+
    time_within_day:treat,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = snake_case_Acute_Bout_Data_followup
)

time6<-Sys.time()
time6-time5
summary(il_10_Acute_bout_main_followup)
plot_il_10_Acute_bout_main_followup<-
  plot(il_10_Acute_bout_main_followup,
     obs.alpha = 0.2,
     ci.alpha = 0.01)

il_1_a_Acute_bout_main_followup<-
  lmm(
  formula = 
    il_1_a_calc_conc_mean_pg_m_l ~ 
    #sex+
    treat+
    time_within_day+
    time_within_day:treat,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = snake_case_Acute_Bout_Data_followup
)

time7<-Sys.time()
time7-time6
summary(il_1_a_Acute_bout_main_followup)
plot_il_1_a_Acute_bout_main_followup<-
  plot(il_1_a_Acute_bout_main_followup,
     obs.alpha = 0.2,
     ci.alpha = 0.01)

il_1_ra_Acute_bout_main_followup<-
  lmm(
  formula = 
    il_1_ra_calc_conc_mean_pg_m_l ~ 
    #sex+
    treat+
    time_within_day+
    time_within_day:treat,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = snake_case_Acute_Bout_Data_followup
)

summary(il_1_ra_Acute_bout_main_followup)
plot_il_1_ra_Acute_bout_main_followup<-
  plot(il_1_ra_Acute_bout_main_followup,
     obs.alpha = 0.2,
     ci.alpha = 0.01)

il_2_Acute_bout_main_followup<-
  lmm(
  formula = 
    il_2_calc_conc_mean_pg_m_l ~ 
    #sex+
    treat+
    time_within_day+
    time_within_day:treat,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = snake_case_Acute_Bout_Data_followup
)

summary(il_2_Acute_bout_main_followup)
plot_il_2_Acute_bout_main_followup<-
  plot(il_2_Acute_bout_main_followup,
     obs.alpha = 0.2,
     ci.alpha = 0.01)

beta2_microglobulin_Acute_bout_main_followup<-
  lmm(
  formula = 
    beta_2_mikroglobuline ~ 
    #sex+
    treat+
    time_within_day+
    time_within_day:treat,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = snake_case_Acute_Bout_Data_followup
)

summary(beta2_microglobulin_Acute_bout_main_followup)
plot_beta2_microglobulin_Acute_bout_main_followup<-
  plot(beta2_microglobulin_Acute_bout_main_followup,
     obs.alpha = 0.2,
     ci.alpha = 0.01)

tnf_Acute_bout_main_followup<-
  lmm(
  formula = 
    log2(tnf_calc_conc_mean_pg_m_l) ~ 
    #sex+
    treat+
    time_within_day+
    time_within_day:treat,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = snake_case_Acute_Bout_Data_followup
)

summary(tnf_Acute_bout_main_followup)
plot_tnf_Acute_bout_main_followup<-
  plot(tnf_Acute_bout_main_followup,
     obs.alpha = 0.2,
     ci.alpha = 0.01)

snake_case_Acute_Bout_Data_followup<-
  snake_case_Acute_Bout_Data_followup%>%
  mutate(
    log2_tnf = log(tnf_calc_conc_mean_pg_m_l, base = 2)
  )

log2_tnf_Acute_bout_main_followup<-
  lmm(
  formula = 
    log2_tnf~ 
    #sex+
    treat+
    time_within_day+
    time_within_day:treat,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = snake_case_Acute_Bout_Data_followup
)

summary(log2_tnf_Acute_bout_main_followup)
plot_log2_tnf_Acute_bout_main_followup<-
  plot(log2_tnf_Acute_bout_main_followup,
     obs.alpha = 0.2,
     ci.alpha = 0.01)
###
#---- Data only on time points -5, 14, 35 and 105 below
###

snake_case_Acute_Bout_Data_followup_nk_timepoints<-
  snake_case_Acute_Bout_Data_followup%>%
  mutate(time_within_day=
           factor(time_within_day, levels=c("-5","14","35","105")))%>%
  dplyr::filter(
    !is.na(time_within_day)
  )

nk_lymphocytes_Acute_bout_main_followup<-
  lmm(
  formula = 
    nk_lymphocytes ~ 
    #sex+
    treat+
    time_within_day+
    time_within_day:treat,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = snake_case_Acute_Bout_Data_followup_nk_timepoints
)

summary(nk_lymphocytes_Acute_bout_main_followup)
nk_lymphocytes_Acute_bout_main_followup_plot<-
  plot(nk_lymphocytes_Acute_bout_main_followup,
     obs.alpha = 0.2,
     ci.alpha = 0.01)


b_lymphocytes_Acute_bout_main_followup<-
  lmm(
  formula = 
    b_lymphocytes ~ 
    #sex+
    treat+
    time_within_day+
    time_within_day:treat,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = snake_case_Acute_Bout_Data_followup_nk_timepoints
)

summary(b_lymphocytes_Acute_bout_main_followup)
b_lymphocytes_Acute_bout_main_followup_plot<-
  plot(b_lymphocytes_Acute_bout_main_followup,
     obs.alpha = 0.2,
     ci.alpha = 0.01)

t_lymphocytes_Acute_bout_main_followup<-
  lmm(
  formula = 
    t_lymphocytes ~ 
    #sex+
    treat+
    time_within_day+
    time_within_day:treat,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = snake_case_Acute_Bout_Data_followup_nk_timepoints
)

summary(t_lymphocytes_Acute_bout_main_followup)
t_lymphocytes_Acute_bout_main_followup_plot<-
  plot(t_lymphocytes_Acute_bout_main_followup,
     obs.alpha = 0.2,
     ci.alpha = 0.01)


```

## Models on Delta Values

```{r}
#Calculate Difference between baseline & followup
Acute_Bout_Data_Wide<-
  Acute_Bout_Data|>
  pivot_wider(
    id_cols = c("id","time_within_day","sex","treatment", "continous_time_within_day"),
    names_from = timepoint,
    values_from = c(5:110)
  )|>
  mutate(
    il_6_delta = 
      `IL-6 Calc. Conc. Mean (pg/mL)_followup - acute bout`-
      `IL-6 Calc. Conc. Mean (pg/mL)_baseline - acute bout`,
    il_6r_delta = 
      `IL-6R Calc. Conc. Mean (pg/mL)_followup - acute bout`-
      `IL-6R Calc. Conc. Mean (pg/mL)_baseline - acute bout`,
    crp_delta = 
      `CRP Calc. Conc. Mean (pg/mL)_followup - acute bout`-
      `CRP Calc. Conc. Mean (pg/mL)_baseline - acute bout`,
    il_2_delta = 
      `IL-2 Calc. Conc. Mean (pg/mL)_followup - acute bout`-
      `IL-2 Calc. Conc. Mean (pg/mL)_baseline - acute bout`,
    il_1a_delta = 
      `IL-1a Calc. Conc. Mean (pg/mL)_followup - acute bout`-
      `IL-1a Calc. Conc. Mean (pg/mL)_baseline - acute bout`,
    il_10_delta = 
      `IL-10 Calc. Conc. Mean (pg/mL)_followup - acute bout`-
      `IL-10 Calc. Conc. Mean (pg/mL)_baseline - acute bout`,
    tnf_delta = 
      `TNF Calc. Conc. Mean (pg/mL)_followup - acute bout`-
      `TNF Calc. Conc. Mean (pg/mL)_baseline - acute bout`,
    il_1ra_delta = 
      `IL-1RA Calc. Conc. Mean (pg/mL)_followup - acute bout`-
      `IL-1RA Calc. Conc. Mean (pg/mL)_baseline - acute bout`,
    ifn_gamma_delta = 
      `IFN-gamma Calc. Conc. Mean (pg/mL)_followup - acute bout`-
      `IFN-gamma Calc. Conc. Mean (pg/mL)_baseline - acute bout`,
    ifn_alpha_delta = 
      `IFN-a Calc. Conc. Mean (pg/mL)_followup - acute bout`-
      `IFN-a Calc. Conc. Mean (pg/mL)_baseline - acute bout`
  )

IL_6_Acute_bout_delta<-lmm(
  formula = 
    il_6_delta ~
    treatment+
    time_within_day+
    time_within_day:treatment,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = Acute_Bout_Data_Wide
)


summary(IL_6_Acute_bout_delta)
plot.IL_6_Acute_bout_delta<-
  plot(IL_6_Acute_bout_delta,
     type = "fit",
     obs.alpha = 0.25,
     ci = F)

plot.IL_6_Acute_bout_delta$plot|>ggplotly()

IL_6r_Acute_bout_delta<-lmm(
  formula = 
    il_6r_delta ~ 
    treatment+
    time_within_day+
    time_within_day:treatment,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = Acute_Bout_Data_Wide
)


summary(IL_6r_Acute_bout_delta)
plot.IL_6r_Acute_bout_delta<-
  plot(IL_6r_Acute_bout_delta,
     type = "fit",
     obs.alpha = 0.25,
     ci = F)


Acute_Bout_Data_Wide_no_outlier <- 
  Acute_Bout_Data_Wide |>
  mutate(
    il_6r_delta = case_when(
      treatment == "control" & time_within_day == "-5" & id == "lup_052" ~ NA_real_,
      treatment == "control" & time_within_day == "45" & id == "lup_039" ~ NA_real_,
      T~il_6r_delta
    )
  )

IL_6r_Acute_bout_delta_no_outlier<-lmm(
  formula = 
    il_6r_delta ~ 
    treatment+
    time_within_day+
    time_within_day:treatment,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = Acute_Bout_Data_Wide_no_outlier
)

summary(IL_6r_Acute_bout_delta_no_outlier)
plot.IL_6r_Acute_bout_delta_no_outlier<-
  plot(IL_6r_Acute_bout_delta_no_outlier,
     type = "fit",
     obs.alpha = 0.25,
     ci = F)
plot.IL_6r_Acute_bout_delta_no_outlier$plot|>
  ggplotly()

summary(IL_6r_Acute_bout_delta)
plot.IL_6r_Acute_bout_delta<-
  plot(IL_6r_Acute_bout_delta,
     type = "fit",
     obs.alpha = 0.25,
     ci = F)


IL_6r_Acute_bout_delta.plot2<-
  plot(IL_6r_Acute_bout_delta_no_outlier,
     type = "fit",
     obs.alpha = 0.0,
     ci.alpha = 0.25,
     ci = T)

plot.IL_6r_Acute_bout_delta$plot|>
  ggplotly()
```

## Calculate AUC

```{r}
#install.packages("DescTools")
library("DescTools")
Acute_Bout_Data_AUCs<-
  Acute_Bout_Data |>
  group_by(id, timepoint)|>
  dplyr::summarise(
  AUC_il6 = AUC(
    x=continous_time_within_day,
    y=`IL-6 Calc. Conc. Mean (pg/mL)`,
    method = "spline", 
    na.rm=T),
  AUC_il6r = AUC(
    x=continous_time_within_day,
    y=`IL-6R Calc. Conc. Mean (pg/mL)`,
    method = "spline", 
    na.rm=T),
  AUC_tnf = AUC(
    x=continous_time_within_day,
    y=`TNF Calc. Conc. Mean (pg/mL)`,
    method = "spline", 
    na.rm=T),
  AUC_IFNa = AUC(
    x=continous_time_within_day,
    y=`IFN-a Calc. Conc. Mean (pg/mL)`,
    method = "spline", 
    na.rm=T),
  AUC_IFNg = AUC(
    x=continous_time_within_day,
    y=`IFN-gamma Calc. Conc. Mean (pg/mL)`,
    method = "spline", 
    na.rm=T),
  AUC_il2 = AUC(
    x=continous_time_within_day,
    y=`IL-2 Calc. Conc. Mean (pg/mL)`,
    method = "spline", 
    na.rm=T),
  AUC_il1a = AUC(
    x=continous_time_within_day,
    y=`IL-1a Calc. Conc. Mean (pg/mL)`,
    method = "spline", 
    na.rm=T),
  AUC_il1ra = AUC(
    x=continous_time_within_day,
    y=`IL-1RA Calc. Conc. Mean (pg/mL)`,
    method = "spline", 
    na.rm=T),
  AUC_il10 = AUC(
    x=continous_time_within_day,
    y=`IL-10 Calc. Conc. Mean (pg/mL)`,
    method = "spline", 
    na.rm=T),
  AUC_Beta2Mikroglobulin = AUC(
    x=continous_time_within_day,
    y=Beta2Mikroglobuline,
    method = "spline", 
    na.rm=T),
  AUC_ferritin = AUC(
    x=continous_time_within_day,
    y=Ferritin,
    method = "spline", 
    na.rm=T),
  treatment = treatment[1],
  treat = treat[1],
  sex = sex[1],
  ifn_1_netto=ifn_1_netto[1],
  all_ifn_netto_t_test=all_ifn_netto_t_test[1]
  )
  
```

## AUC models

```{r IL6}
##IL-6
AUC_il6_main.lmm<-lmm(
  formula = AUC_il6 ~ 
   timepoint+
    sex+
    timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )
summary(AUC_il6_main.lmm)
plot(AUC_il6_main.lmm, 
     type = "scatterplot")

AUC_il6_interaction.lmm<-lmm(
  formula = AUC_il6 ~ 
   timepoint+
    sex+
    timepoint:treat+
    ifn_1_netto+
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )

plot(AUC_il6_interaction.lmm, 
     type = "qqplot")
plot(AUC_il6_interaction.lmm, 
     type = "scatterplot")
plot(AUC_il6_interaction.lmm, 
     type = "fit", 
     color="treatment",
     ci=F,
     time.var = "timepoint",
     obs.alpha = 0.5, 
     facet = ~ cut_interval(ifn_1_netto, 3))
summary(AUC_il6_interaction.lmm)
```

```{r IL6r}
##AUC Il-6r

AUC_il6r_main.lmm<-lmm(
  formula = AUC_il6r ~ 
   timepoint+
    sex+
    timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )
summary(AUC_il6r_main.lmm)
plot(AUC_il6r_main.lmm, 
     type = "scatterplot")

AUC_il6r_interaction.lmm<-lmm(
  formula = AUC_il6r ~ 
   timepoint+
    sex+
    timepoint:treat+
    ifn_1_netto+
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )

plot(AUC_il6r_interaction.lmm, 
     type = "qqplot")
plot(AUC_il6r_interaction.lmm, 
     type = "scatterplot")
plot(AUC_il6r_interaction.lmm, 
     type = "fit", 
     color="treatment",
     ci=F,
     time.var = "timepoint",
     obs.alpha = 0.5, 
     facet = ~ cut_interval(ifn_1_netto, 3))
summary(AUC_il6r_interaction.lmm)
```

```{r IFNgamma}
##IFN gamma
AUC_IFNg_main.lmm<-lmm(
  formula = AUC_IFNg ~ 
   timepoint+
    sex+
    timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )
summary(AUC_IFNg_main.lmm)

AUC_IFNg_interaction.lmm<-lmm(
  formula = AUC_IFNg ~ 
   timepoint+
    sex+
    timepoint:treat+
    ifn_1_netto+
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )

plot(AUC_IFNg_interaction.lmm, 
     type = "qqplot")
plot(AUC_IFNg_interaction.lmm, 
     type = "scatterplot")
plot(AUC_IFNg_interaction.lmm, 
     type = "fit", 
     color="treatment",
     ci=F,
     time.var = "timepoint",
     obs.alpha = 0.5, 
     facet = ~ cut_interval(ifn_1_netto, 3))
summary(AUC_IFNg_interaction.lmm)
```

```{r Ferritin}
##Ferritin

AUC_ferritin_interaction.lmm<-lmm(
  formula = AUC_ferritin ~ 
   timepoint+
    sex+
    timepoint:treat+
    ifn_1_netto+
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )

summary(AUC_ferritin_interaction.lmm)
```

```{r TNF}
# AUC_tnf
AUC_tnf_interaction.lmm<-lmm(
  formula = AUC_tnf ~ 
   timepoint+
    sex+
    timepoint:treat+
    ifn_1_netto+
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )

summary(AUC_tnf_interaction.lmm)
plot(AUC_tnf_interaction.lmm, type = "scatterplot")
plot(AUC_tnf_interaction.lmm, 
     type = "fit", 
     color="treatment",
     ci=F,
     time.var = "timepoint",
     obs.alpha = 0.5, 
     facet = ~ cut_interval(ifn_1_netto, 3))
  
 # AUC_IFNa,
#AUC_IFNa_interaction.lmm<-lmm(
#  formula = AUC_IFNa ~ 
#   timepoint+
#    sex+
#    timepoint:treat+
#    ifn_1_netto+
#    ifn_1_netto:timepoint+
#    ifn_1_netto:timepoint:treat,
#  repetition = ~timepoint|id,
#  structure = "UN",
#  data = Acute_Bout_Data_AUCs
#  )

#summary(AUC_IFNa_interaction.lmm)
#plot(AUC_IFNa_interaction.lmm, type = "scatterplot")
#plot(AUC_IFNa_interaction.lmm)
  
#AUC_IFNa_main.lmm<-lmm(
#  formula = AUC_IFNa ~ 
#   timepoint+
#    sex+
#    timepoint:treat,
#  repetition = ~timepoint|id,
#  structure = "UN",
#  data = Acute_Bout_Data_AUCs
#  )

#summary(AUC_IFNa_main.lmm)
#plot(AUC_IFNa_main.lmm, type = "scatterplot")
#plot(AUC_IFNa_main.lmm)
```

```{r IL2}
#AUC_il2    
AUC_il2_main.lmm<-lmm(
  formula = AUC_il2 ~ 
   timepoint+
    sex+
    timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )

summary(AUC_il2_main.lmm)
plot(AUC_il2_main.lmm, type = "scatterplot")
plot(AUC_il2_main.lmm, at = data.frame(sex = "F"), color = "treatment")  



AUC_il2_interaction.lmm<-lmm(
  formula = AUC_il2 ~ 
   timepoint+
    sex+
    timepoint:treat+
    ifn_1_netto+
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )

summary(AUC_il2_interaction.lmm)
plot(AUC_il2_interaction.lmm, type = "scatterplot")
plot(AUC_il2_interaction.lmm, 
     type = "fit", 
     color="treatment",
     ci=F,
     time.var = "timepoint",
     obs.alpha = 0.5, 
     facet = ~ cut_interval(ifn_1_netto, 3))
```

```{r IL1a}
#AUC_il1a    
AUC_il1a_main.lmm<-lmm(
  formula = AUC_il1a ~ 
   timepoint+
    sex+
    timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )

summary(AUC_il1a_main.lmm)
plot(AUC_il1a_main.lmm, type = "scatterplot")
plot(AUC_il1a_main.lmm, at = data.frame(sex = "F"), color = "treatment")   


AUC_il1a_interaction.lmm<-lmm(
  formula = AUC_il1a ~ 
   timepoint+
    sex+
    timepoint:treat+
    ifn_1_netto+
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )

summary(AUC_il1a_interaction.lmm)
plot(AUC_il1a_interaction.lmm, type = "scatterplot")
plot(AUC_il1a_interaction.lmm, 
     type = "fit", 
     color="treatment",
     ci=F,
     time.var = "timepoint",
     obs.alpha = 0.5, 
     facet = ~ cut_interval(ifn_1_netto, 3))
```

```{r IL1ra}
#AUC_il1ra    
AUC_il1ra_main.lmm<-lmm(
  formula = AUC_il1ra ~ 
   timepoint+
    sex+
    timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )

summary(AUC_il1ra_main.lmm)
plot(AUC_il1ra_main.lmm, type = "scatterplot")
plot(AUC_il1ra_main.lmm, at = data.frame(sex = "F"), color = "treatment")  


AUC_il1ra_interaction.lmm<-lmm(
  formula = AUC_il1ra ~ 
   timepoint+
    sex+
    timepoint:treat+
    ifn_1_netto+
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )

summary(AUC_il1ra_interaction.lmm)
plot(AUC_il1ra_interaction.lmm, type = "scatterplot")
plot(AUC_il1ra_interaction.lmm, 
     type = "fit", 
     color="treatment",
     ci=F,
     time.var = "timepoint",
     obs.alpha = 0.5, 
     facet = ~ cut_interval(ifn_1_netto, 3))
```

```{r IL10}
#AUC_il10    
AUC_il10_main.lmm<-lmm(
  formula = AUC_il10 ~ 
   timepoint+
    sex+
    timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )

summary(AUC_il10_main.lmm)
plot(AUC_il10_main.lmm, type = "scatterplot")
plot(AUC_il10_main.lmm, at = data.frame(sex = "F"), color = "treatment")  


AUC_il10_interaction.lmm<-lmm(
  formula = AUC_il10 ~ 
   timepoint+
    sex+
    timepoint:treat+
    ifn_1_netto+
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )

summary(AUC_il10_interaction.lmm)
plot(AUC_il10_interaction.lmm, type = "scatterplot")
plot(AUC_il10_interaction.lmm, 
     type = "fit", 
     color="treatment",
     ci=F,
     time.var = "timepoint",
     obs.alpha = 0.5, 
     facet = ~ cut_interval(ifn_1_netto, 3),
     at = data.frame( sex = "F"))
```

```{r beta2micro}
#AUC_Beta2Mikroglobulin
AUC_Beta2Mikroglobulin_main.lmm<-lmm(
  formula = AUC_Beta2Mikroglobulin ~ 
   timepoint+
    sex+
    timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )

summary(AUC_Beta2Mikroglobulin_main.lmm)
plot(AUC_Beta2Mikroglobulin_main.lmm, type = "scatterplot")
plot(AUC_Beta2Mikroglobulin_main.lmm, at = data.frame(sex = "F"), color = "treatment")  


AUC_Beta2Mikroglobulin_interaction.lmm<-lmm(
  formula = AUC_Beta2Mikroglobulin ~ 
   timepoint+
    sex+
    timepoint:treat+
    ifn_1_netto+
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )

summary(AUC_Beta2Mikroglobulin_interaction.lmm)
plot(AUC_Beta2Mikroglobulin_interaction.lmm, type = "scatterplot")
plot(AUC_Beta2Mikroglobulin_interaction.lmm, 
     type = "fit", 
     color="treatment",
     ci=F,
     time.var = "timepoint",
     obs.alpha = 0.5, 
     facet = ~ cut_interval(ifn_1_netto, 3))
```

```{r Ferritin}
#AUC_ferritin
AUC_ferritin_main.lmm<-lmm(
  formula = AUC_ferritin ~ 
   timepoint+
    sex+
    timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )

summary(AUC_ferritin_main.lmm)
plot(AUC_ferritin_main.lmm, type = "scatterplot")
plot(AUC_ferritin_main.lmm, at = data.frame(sex = "F"), color = "treatment")    


AUC_ferritin_interaction.lmm<-lmm(
  formula = AUC_ferritin ~ 
   timepoint+
    sex+
    timepoint:treat+
    ifn_1_netto+
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treat,
  repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUCs
  )

summary(AUC_ferritin_interaction.lmm)
plot(AUC_ferritin_interaction.lmm, type = "scatterplot")
plot(AUC_ferritin_interaction.lmm, 
     type = "fit", 
     color="treatment",
     at = data.frame(sex = "F"),
     ci=F,
     time.var = "timepoint",
     obs.alpha = 0.5, 
     facet = ~ cut_interval(ifn_1_netto, 3))
```

### Aggregate AUC_models

```{r Aggregate AUCs}
options(scipen = 9999)
df.main.models.AUC<-dplyr::bind_rows(
  model.tables(
    AUC_il6_main.lmm
  ) %>% dplyr::mutate(
    outcome = "AUC_IL6",
    model_type = "main"
  ),
  model.tables(
    AUC_il6r_main.lmm
  ) %>% dplyr::mutate(
    outcome = "AUC_IL6r",
    model_type = "main"
  ),
  model.tables(
    AUC_Beta2Mikroglobulin_interaction.lmm
  ) %>% dplyr::mutate(
    outcome = "AUC_Beta2Microglbulin",
    model_type = "main"
  ),
  model.tables(
    AUC_ferritin_main.lmm
  ) %>% dplyr::mutate(
    outcome = "AUC_Ferritin",
    model_type = "main"
  ),
  model.tables(
    AUC_IFNg_main.lmm
  ) %>% dplyr::mutate(
    outcome = "AUC_IFNgamma",
    model_type = "main"
  ),
  model.tables(
    AUC_il10_main.lmm
  ) %>% dplyr::mutate(
    outcome = "AUC_IL10",
    model_type = "main"
  ),
  model.tables(
    AUC_il1a_main.lmm
  ) %>% dplyr::mutate(
    outcome = "AUC_IL1a",
    model_type = "main"
  ),
  model.tables(
    AUC_il1ra_main.lmm
  ) %>% dplyr::mutate(
    outcome = "AUC_IL1ra",
    model_type = "main"
  ),
  model.tables(
    AUC_il2_main.lmm
  ) %>% dplyr::mutate(
    outcome = "AUC_IL2",
    model_type = "main"
  )
)%>%
  dplyr::add_rownames(var = "predictor")%>%
  mutate(in_hypothesis = case_when(grepl("bout:treat",predictor) ~ T,
                                   T ~ F))

df.interaction.models.AUC<-dplyr::bind_rows(
  model.tables(
    AUC_il6_interaction.lmm
  ) %>% dplyr::mutate(
    outcome = "AUC_IL6",
    model_type = "interaction"
  ),
  model.tables(
    AUC_il6r_interaction.lmm
  ) %>% dplyr::mutate(
    outcome = "AUC_IL6r",
    model_type = "interaction"
  ),
  model.tables(
    AUC_Beta2Mikroglobulin_interaction.lmm
  ) %>% dplyr::mutate(
    outcome = "AUC_Beta2Microglbulin",
    model_type = "interaction"
  ),
  model.tables(
    AUC_ferritin_interaction.lmm
  ) %>% dplyr::mutate(
    outcome = "AUC_Ferritin",
    model_type = "interaction"
  ),
  model.tables(
    AUC_IFNg_interaction.lmm
  ) %>% dplyr::mutate(
    outcome = "AUC_IFNgamma",
    model_type = "interaction"
  ),
  model.tables(
    AUC_il10_interaction.lmm
  ) %>% dplyr::mutate(
    outcome = "AUC_IL10",
    model_type = "interaction"
  ),
  model.tables(
    AUC_il1a_interaction.lmm
  ) %>% dplyr::mutate(
    outcome = "AUC_IL1a",
    model_type = "interaction"
  ),
  model.tables(
    AUC_il1ra_interaction.lmm
  ) %>% dplyr::mutate(
    outcome = "AUC_IL1ra",
    model_type = "interaction"
  ),
  model.tables(
    AUC_il2_interaction.lmm
  ) %>% dplyr::mutate(
    outcome = "AUC_IL2",
    model_type = "interaction"
  )
)%>%
  dplyr::add_rownames(var = "predictor")%>%
  mutate(in_hypothesis = case_when(grepl("bout:treatexercise:ifn",predictor) ~ T,
                                   grepl("bout:ifn_1",predictor) ~ F,
                                   grepl("ifn_1",predictor) ~ T,
                                   T ~ F))

df.models.AUC <-
  dplyr::bind_rows(
    df.interaction.models.AUC,
    df.main.models.AUC
  )

```
#TODO LAV AUC PÅ WATT KURVER! - Done
```{r}
watt_aucs<-read_excel(
  path = (here("Data", "Acute Bout", "watt_auc.xlsx")))

Acute_Bout_Data_AUCs<-
  Acute_Bout_Data_AUCs%>%
  mutate(
    timepoint = substr(timepoint, 1,8)
  )

Acute_bout_data_energy<-
  Acute_Bout_Data_AUCs%>%
  left_join(
    watt_aucs
  )

Acute_bout_data_energy%>%ggplot(aes(x = timepoint, y = WATT_AUC, color = treatment))+geom_point()


#TODO BÅDE overfor Præstation () men også som præstation overfor cytokin release. Evt. både som bout og som post_bout 
#TODO Regn energy under vo2max relater til trænerbarhed. #GIVER IKKE MENING JVF EXERCISEFYSIOLOGERNE

lmm_WATT_AUC_interact<-lmm(
    formula =
      WATT_AUC ~
      timepoint+
        sex+
        timepoint:treat+
        ifn_1_netto+
        ifn_1_netto:timepoint+
        ifn_1_netto:timepoint:treat,
     repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_bout_data_energy
  )
plot(lmm_WATT_AUC_interact, at = data.frame(sex = "F"), facet = ~ cut_interval(ifn_1_netto, 3), color = "treatment", ci =F, obs.alpha =0.2)
plot(lmm_WATT_AUC_interact, type = "qqplot")
plot(lmm_WATT_AUC_interact, type = "scatterplot")
summary(lmm_WATT_AUC_interact)

lmm_WATT_AUC_main<-lmm(
    formula =
      WATT_AUC ~
      timepoint+
        sex+
        timepoint:treat,
     repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_bout_data_energy
  )
plot(lmm_WATT_AUC_main, at = data.frame(sex = "F"), color = "treatment", obs.alpha = 0.2)
plot(lmm_WATT_AUC_main, type = "qqplot")
plot(lmm_WATT_AUC_main, type = "scatterplot")
summary(lmm_WATT_AUC_main)
```
## Calculate AUC Minus T -5 value

```{r}

Acute_Bout_Data_change_from_start<-
  Acute_Bout_Data|>
  group_by(id, timepoint)|>
  arrange(time_within_day)|>
  mutate(
    il6_increase =
      `IL-6 Calc. Conc. Mean (pg/mL)`-
      `IL-6 Calc. Conc. Mean (pg/mL)`[1],
    il6r_increase = 
      `IL-6R Calc. Conc. Mean (pg/mL)`-
      `IL-6R Calc. Conc. Mean (pg/mL)`[1],
    crp_increase = 
      `CRP Calc. Conc. Mean (pg/mL)`-
      `CRP Calc. Conc. Mean (pg/mL)`[1],
    il_2_increase = 
      `IL-2 Calc. Conc. Mean (pg/mL)`-
      `IL-2 Calc. Conc. Mean (pg/mL)`[1],
    il_1a_increase = 
      `IL-1a Calc. Conc. Mean (pg/mL)`-
      `IL-1a Calc. Conc. Mean (pg/mL)`[1],
    il_10_increase = 
      `IL-10 Calc. Conc. Mean (pg/mL)`-
      `IL-10 Calc. Conc. Mean (pg/mL)`[1],
    tnf_increase = 
      `TNF Calc. Conc. Mean (pg/mL)`-
      `TNF Calc. Conc. Mean (pg/mL)`[1],
    il_1ra_increase = 
      `IL-1RA Calc. Conc. Mean (pg/mL)`-
      `IL-1RA Calc. Conc. Mean (pg/mL)`[1],
    ifn_gamma_increase = 
      `IFN-gamma Calc. Conc. Mean (pg/mL)`-
      `IFN-gamma Calc. Conc. Mean (pg/mL)`[1],
    ifn_alpha_increase = 
      `IFN-a Calc. Conc. Mean (pg/mL)`-
      `IFN-a Calc. Conc. Mean (pg/mL)`[1],
    ferritin_increase = 
      Ferritin-
      Ferritin[1],
    Lymphocytes_increase = 
      Lymphocytes-
      Lymphocytes[1],
    HS_CRP_increase =
      HS_CRP-
      HS_CRP[1],
    Beta2Mikroglobuline_increase=
      Beta2Mikroglobuline-
      Beta2Mikroglobuline[1]
  )

```

## AUC - minus baseline models



```{r}
Acute_Bout_Data_AUC_change_from_start <-
Acute_Bout_Data_change_from_start |>
  group_by(id, timepoint)|>
  dplyr::summarise(
  AUC_b_il6 = AUC(
    x=continous_time_within_day,
    y=il6_increase,
    method = "spline", 
    na.rm=T),
  AUC_b_il6r = AUC(
    x=continous_time_within_day,
    y=il6r_increase,
    method = "spline", 
    na.rm=T),
  AUC_b_crp = AUC(
    x=continous_time_within_day,
    y=crp_increase,
    method = "spline", 
    na.rm=T),
  AUC_b_tnf = AUC(
    x=continous_time_within_day,
    y=tnf_increase ,
    method = "spline", 
    na.rm=T),
  AUC_b_IFNa = AUC(
    x=continous_time_within_day,
    y=ifn_alpha_increase ,
    method = "spline", 
    na.rm=T),
  AUC_b_IFNg = AUC(
    x=continous_time_within_day,
    y=ifn_gamma_increase,
    method = "spline", 
    na.rm=T),
  AUC_b_il2 = AUC(
    x=continous_time_within_day,
    y=il_2_increase,
    method = "spline", 
    na.rm=T),
  AUC_b_il1a = AUC(
    x=continous_time_within_day,
    y= il_1a_increase,
    method = "spline", 
    na.rm=T),
  AUC_b_il1ra = AUC(
    x=continous_time_within_day,
    y=il_1ra_increase ,
    method = "spline", 
    na.rm=T),
  AUC_b_il10 = AUC(
    x=continous_time_within_day,
    y=il_10_increase,
    method = "spline", 
    na.rm=T),
  AUC_b_Beta2Mikroglobulin = AUC(
    x=continous_time_within_day,
    y=Beta2Mikroglobuline_increase,
    method = "spline", 
    na.rm=T),
  AUC_b_ferritin = AUC(
    x=continous_time_within_day,
    y=ferritin_increase,
    method = "spline", 
    na.rm=T),
  treatment = treatment[1],
  treat = treat[1],
  sex = sex[1],
  ifn_1_netto=ifn_1_netto[1],
  all_ifn_netto_t_test=all_ifn_netto_t_test[1]
  )
```

## AUC Min t-5 models

```{r}
##IL-6

lmm_auc_b_il6<-lmm(
    formula =
      AUC_b_il6 ~
      timepoint+
        #sex+
        timepoint:treat+
        ifn_1_netto+
        ifn_1_netto:timepoint+
        ifn_1_netto:timepoint:treat,
     repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUC_change_from_start
  )

fitplot_lmm_auc_b_il6<-
  plot(lmm_auc_b_il6, 
       type = "fit", 
         obs.alpha = 0.2, 
         ci = T, 
         ci.alpha = 0.05,
         facet = ~ cut_interval(ifn_1_netto, 3),
         color = "treatment")

fitplot_lmm_auc_b_il6$plot|>
  ggplotly()

summary(lmm_auc_b_il6)
plot(lmm_auc_b_il6, type = "qqplot")
##Odd outlier at -352 (?) Lets remove it.
lmm_auc_b_il6_no_outlier<-lmm(
    formula =
      AUC_b_il6 ~
      timepoint+
        #sex+
        timepoint:treat+
        ifn_1_netto+
        ifn_1_netto:timepoint+
        ifn_1_netto:timepoint:treat,
     repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUC_change_from_start|>dplyr::filter(
    id != "lup_052"
  )
  )
summary(lmm_auc_b_il6_no_outlier)
plot(lmm_auc_b_il6_no_outlier, type = "qqplot")
plot(lmm_auc_b_il6_no_outlier, type = "scatterplot")

fitplot_lmm_auc_b_il6_no_outlier<-
  plot(lmm_auc_b_il6_no_outlier, 
       type = "fit", 
         obs.alpha = 0.2, 
         ci = T, 
         ci.alpha = 0.05,
         facet = ~ cut_interval(ifn_1_netto, 3),
         color = "treatment")

fitplot_lmm_auc_b_il6_no_outlier$plot|>
  ggplotly()
```

```{r}
## AUC_b_il6r
lmm_auc_b_il6r<-lmm(
    formula =
      AUC_b_il6r ~
      timepoint+
        #sex+
        timepoint:treat+
        ifn_1_netto+
        ifn_1_netto:timepoint+
        ifn_1_netto:timepoint:treat,
     repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUC_change_from_start
  )

fitplot_lmm_auc_b_il6r<-
  plot(lmm_auc_b_il6r, 
       type = "fit", 
         obs.alpha = 0.2, 
         ci = T, 
         ci.alpha = 0.05,
         facet = ~ cut_interval(ifn_1_netto, 3),
         color = "treatment")

fitplot_lmm_auc_b_il6r$plot|>
  ggplotly()

summary(lmm_auc_b_il6r)
plot(lmm_auc_b_il6r, type = "qqplot")
```

```{r}
##AUC_b_tnf
lmm_auc_b_tnf<-lmm(
    formula =
      AUC_b_tnf ~
      timepoint+
        #sex+
        timepoint:treat+
        ifn_1_netto+
        ifn_1_netto:timepoint+
        ifn_1_netto:timepoint:treat,
     repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUC_change_from_start
  )

fitplot_lmm_auc_b_tnf<-
  plot(lmm_auc_b_tnf, 
       type = "fit", 
         obs.alpha = 0.2, 
         ci = T, 
         ci.alpha = 0.05,
         facet = ~ cut_interval(ifn_1_netto, 3),
         color = "treatment")

fitplot_lmm_auc_b_tnf$plot|>
  ggplotly()

summary(lmm_auc_b_tnf)
plot(lmm_auc_b_tnf, type = "qqplot")
```

```{r}
##AUC_b_il2
lmm_auc_b_il2<-lmm(
    formula =
      AUC_b_il2 ~
      timepoint+
        #sex+
        timepoint:treat+
        ifn_1_netto+
        ifn_1_netto:timepoint+
        ifn_1_netto:timepoint:treat,
     repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUC_change_from_start
  )

fitplot_lmm_auc_b_il2<-
  plot(lmm_auc_b_il2, 
       type = "fit", 
         obs.alpha = 0.2, 
         ci = T, 
         ci.alpha = 0.05,
         facet = ~ cut_interval(ifn_1_netto, 3),
         color = "treatment")

fitplot_lmm_auc_b_il2$plot|>
  ggplotly()

summary(lmm_auc_b_il2)
plot(lmm_auc_b_il2, type = "qqplot")

##AUC_b_il1a
lmm_auc_b_il1a<-lmm(
    formula =
      AUC_b_il1a ~
      timepoint+
        #sex+
        timepoint:treat+
        ifn_1_netto+
        ifn_1_netto:timepoint+
        ifn_1_netto:timepoint:treat,
     repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUC_change_from_start
  )

fitplot_lmm_auc_b_il1a<-
  plot(lmm_auc_b_il1a, 
       type = "fit", 
         obs.alpha = 0.2, 
         ci = T, 
         ci.alpha = 0.05,
         facet = ~ cut_interval(ifn_1_netto, 3),
         color = "treatment")

fitplot_lmm_auc_b_il1a$plot|>
  ggplotly()

summary(lmm_auc_b_il1a)
plot(lmm_auc_b_il1a, type = "qqplot")


  


##AUC_b_il1a
lmm_auc_b_il1ra<-lmm(
    formula =
      AUC_b_il1ra ~
      timepoint+
        #sex+
        timepoint:treat+
        ifn_1_netto+
        ifn_1_netto:timepoint+
        ifn_1_netto:timepoint:treat,
     repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUC_change_from_start
  )

fitplot_lmm_auc_b_il1ra<-
  plot(lmm_auc_b_il1ra, 
       type = "fit", 
         obs.alpha = 0.2, 
         ci = T, 
         ci.alpha = 0.05,
         facet = ~ cut_interval(ifn_1_netto, 3),
         color = "treatment")

fitplot_lmm_auc_b_il1ra$plot|>
  ggplotly()

summary(lmm_auc_b_il1ra)
plot(lmm_auc_b_il1ra, type = "qqplot")

## AUC_b_il10

lmm_AUC_b_il10<-lmm(
    formula =
      AUC_b_il10 ~
      timepoint+
        #sex+
        timepoint:treat+
        ifn_1_netto+
        ifn_1_netto:timepoint+
        ifn_1_netto:timepoint:treat,
     repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUC_change_from_start
  )

fitplot_lmm_AUC_b_il10<-
  plot(lmm_AUC_b_il10, 
       type = "fit", 
         obs.alpha = 0.2, 
         ci = T, 
         ci.alpha = 0.05,
         facet = ~ cut_interval(ifn_1_netto, 3),
         color = "treatment")

fitplot_lmm_AUC_b_il10$plot|>
  ggplotly()

summary(lmm_AUC_b_il10)
plot(lmm_AUC_b_il10, type = "qqplot")

## AUC_b_Beta2Mikroglobulin 

lmm_AUC_b_Beta2Mikroglobulin<-lmm(
    formula =
      AUC_b_Beta2Mikroglobulin ~
      timepoint+
        #sex+
        timepoint:treat+
        ifn_1_netto+
        ifn_1_netto:timepoint+
        ifn_1_netto:timepoint:treat,
     repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUC_change_from_start
  )

fitplot_lmm_AUC_b_Beta2Mikroglobulin<-
  plot(lmm_AUC_b_Beta2Mikroglobulin, 
       type = "fit", 
         obs.alpha = 0.2, 
         ci = T, 
         ci.alpha = 0.05,
         facet = ~ cut_interval(ifn_1_netto, 3),
         color = "treatment")

fitplot_lmm_AUC_b_Beta2Mikroglobulin$plot|>
  ggplotly()

summary(lmm_AUC_b_Beta2Mikroglobulin)
plot(lmm_AUC_b_Beta2Mikroglobulin, type = "qqplot")
## AUC_b_ferritin

lmm_auc_b_ferritin<-lmm(
    formula =
      AUC_b_ferritin ~
      timepoint+
        #sex+
        timepoint:treat+
        ifn_1_netto+
        ifn_1_netto:timepoint+
        ifn_1_netto:timepoint:treat,
     repetition = ~timepoint|id,
  structure = "UN",
  data = Acute_Bout_Data_AUC_change_from_start
  )

fitplot_lmm_auc_b_ferritin<-
  plot(lmm_auc_b_ferritin, 
       type = "fit", 
         obs.alpha = 0.2, 
         ci = T, 
         ci.alpha = 0.05,
         facet = ~ cut_interval(ifn_1_netto, 3),
         color = "treatment")

fitplot_lmm_auc_b_ferritin$plot|>
  ggplotly()

summary(lmm_auc_b_ferritin)
plot(lmm_auc_b_ferritin, type = "qqplot")

```

#Refund Package to make MFPCA.sc

```{r eval = T}
#install.packages("refund")
library(refund)

df_dimensions_to_reduce_crp <-
  snake_case_Acute_Bout_Data%>%
  group_by(id, timepoint)%>%
  dplyr::filter(!all(is.na(crp_mg_ml)))%>%
  dplyr::select(id, timepoint, time_within_day, continous_time_within_day, 
                crp_mg_ml, il_1_ra_calc_conc_mean_pg_m_l, il_6_calc_conc_mean_pg_m_l, 
                il_6_r_calc_conc_mean_pg_m_l, il_10_calc_conc_mean_pg_m_l, 
                ifn_gamma_calc_conc_mean_pg_m_l,leukocytes)%>%
  mutate(across(crp_mg_ml:leukocytes, .fn=as.numeric))|>
  mutate(across(crp_mg_ml:leukocytes, .fn=log2))|>
  tidyr::pivot_wider(
    id_cols = c(id, timepoint),
    names_from = time_within_day,
    values_from = c(crp_mg_ml, 
                    il_1_ra_calc_conc_mean_pg_m_l, 
                    il_6_calc_conc_mean_pg_m_l, 
                    il_6_r_calc_conc_mean_pg_m_l, 
                    il_10_calc_conc_mean_pg_m_l, 
                    ifn_gamma_calc_conc_mean_pg_m_l,
                    leukocytes))

###-----
      #CRP
###-----

df_dimensions_to_reduce_crp_complete_case<-
  snake_case_Acute_Bout_Data%>%
  group_by(id, timepoint)%>%
  dplyr::filter(!any(is.na(crp_mg_ml)))%>%
  dplyr::select(id, timepoint, time_within_day, continous_time_within_day, 
                crp_mg_ml, il_1_ra_calc_conc_mean_pg_m_l, il_6_calc_conc_mean_pg_m_l, 
                il_6_r_calc_conc_mean_pg_m_l, il_10_calc_conc_mean_pg_m_l, 
                ifn_gamma_calc_conc_mean_pg_m_l,leukocytes)%>%
  mutate(across(crp_mg_ml:leukocytes, .fn=as.numeric))|>
  mutate(across(crp_mg_ml:leukocytes, .fn=log2))|>
  tidyr::pivot_wider(
    id_cols = c(id, timepoint),
    names_from = time_within_day,
    values_from = c(crp_mg_ml, 
                    il_1_ra_calc_conc_mean_pg_m_l, 
                    il_6_calc_conc_mean_pg_m_l, 
                    il_6_r_calc_conc_mean_pg_m_l, 
                    il_10_calc_conc_mean_pg_m_l, 
                    ifn_gamma_calc_conc_mean_pg_m_l,
                    leukocytes))

mat_dim<-
  df_dimensions_to_reduce_crp_complete_case|>
  ungroup()|>
    dplyr::select(-id, -timepoint)|>
  as.matrix()

crp = mat_dim[,c(1:9)]



crp_mfpca_sc<-
  refund::mfpca.sc( 
    Y = crp,
    id = df_dimensions_to_reduce_crp_complete_case$id, 
    visit = df_dimensions_to_reduce_crp_complete_case$timepoint,
    nbasis = 3)

df_mfpca_crp <-
  data.frame(
    id = df_dimensions_to_reduce_crp_complete_case$id,
    timepoint = df_dimensions_to_reduce_crp_complete_case$timepoint,
    crp_mfpca_score = crp_mfpca_sc$scores$level2
  )


###-----
      #IL-6
###-----
df_dimensions_to_reduce_il6_complete_case<-
  snake_case_Acute_Bout_Data%>%
  group_by(id, timepoint)%>%
  dplyr::filter(!any(is.na(il_6_calc_conc_mean_pg_m_l)))%>%
  dplyr::select(id, timepoint, time_within_day, continous_time_within_day, 
                crp_mg_ml, il_1_ra_calc_conc_mean_pg_m_l, il_6_calc_conc_mean_pg_m_l, 
                il_6_r_calc_conc_mean_pg_m_l, il_10_calc_conc_mean_pg_m_l, 
                ifn_gamma_calc_conc_mean_pg_m_l,leukocytes)%>%
  mutate(across(crp_mg_ml:leukocytes, .fn=as.numeric))|>
  mutate(across(crp_mg_ml:leukocytes, .fn=log2))|>
  tidyr::pivot_wider(
    id_cols = c(id, timepoint),
    names_from = time_within_day,
    values_from = c(crp_mg_ml, 
                    il_1_ra_calc_conc_mean_pg_m_l, 
                    il_6_calc_conc_mean_pg_m_l, 
                    il_6_r_calc_conc_mean_pg_m_l, 
                    il_10_calc_conc_mean_pg_m_l, 
                    ifn_gamma_calc_conc_mean_pg_m_l,
                    leukocytes))

mat_dim<-
  df_dimensions_to_reduce_il6_complete_case|>
  ungroup()|>
    dplyr::select(-id, -timepoint)|>
  as.matrix()

il6 = mat_dim[,c(19:27)]

il6_mfpca_sc<-
  refund::mfpca.sc( 
    Y = il6,
    id = df_dimensions_to_reduce_il6_complete_case$id, 
    visit = df_dimensions_to_reduce_il6_complete_case$timepoint,
    nbasis = 3)

df_mfpca_il6 <-
  data.frame(
    id = df_dimensions_to_reduce_il6_complete_case$id,
    timepoint = df_dimensions_to_reduce_il6_complete_case$timepoint,
    il_6_mfpca_score =il6_mfpca_sc$scores$level2
    )

###-----
      #IL-6r
###-----
df_dimensions_to_reduce_il6r_complete_case<-
  snake_case_Acute_Bout_Data%>%
  group_by(id, timepoint)%>%
  dplyr::filter(!any(is.na(il_6_r_calc_conc_mean_pg_m_l)))%>%
  dplyr::select(id, timepoint, time_within_day, continous_time_within_day, 
                crp_mg_ml, il_1_ra_calc_conc_mean_pg_m_l, il_6_calc_conc_mean_pg_m_l, 
                il_6_r_calc_conc_mean_pg_m_l, il_10_calc_conc_mean_pg_m_l, 
                ifn_gamma_calc_conc_mean_pg_m_l,leukocytes)%>%
  mutate(across(crp_mg_ml:leukocytes, .fn=as.numeric))|>
  mutate(across(crp_mg_ml:leukocytes, .fn=log2))|>
  tidyr::pivot_wider(
    id_cols = c(id, timepoint),
    names_from = time_within_day,
    values_from = c(crp_mg_ml, 
                    il_1_ra_calc_conc_mean_pg_m_l, 
                    il_6_calc_conc_mean_pg_m_l, 
                    il_6_r_calc_conc_mean_pg_m_l, 
                    il_10_calc_conc_mean_pg_m_l, 
                    ifn_gamma_calc_conc_mean_pg_m_l,
                    leukocytes))

mat_dim<-
  df_dimensions_to_reduce_il6r_complete_case|>
  ungroup()|>
    dplyr::select(-id, -timepoint)|>
  as.matrix()

il6r = mat_dim[,c(28:36)]

il6r_mfpca_sc<-
  refund::mfpca.sc( 
    Y = il6r,
    id = df_dimensions_to_reduce_il6r_complete_case$id, 
    visit = df_dimensions_to_reduce_il6r_complete_case$timepoint,
    nbasis = 3)
summary(il6r_mfpca_sc)
  

df_mfpca_il6r <-
  data.frame(
    id = df_dimensions_to_reduce_il6r_complete_case$id,
    timepoint = df_dimensions_to_reduce_il6r_complete_case$timepoint,
    il_6r_mfpca_score =il6r_mfpca_sc$scores$level2
    )

###-----
      #IL-10
###-----
df_dimensions_to_reduce_il10_complete_case<-
  snake_case_Acute_Bout_Data%>%
  group_by(id, timepoint)%>%
  dplyr::filter(!any(is.na(il_10_calc_conc_mean_pg_m_l)))%>%
  dplyr::select(id, timepoint, time_within_day, continous_time_within_day, 
                crp_mg_ml, il_1_ra_calc_conc_mean_pg_m_l, il_6_calc_conc_mean_pg_m_l, 
                il_6_r_calc_conc_mean_pg_m_l, il_10_calc_conc_mean_pg_m_l, 
                ifn_gamma_calc_conc_mean_pg_m_l,leukocytes)%>%
  mutate(across(crp_mg_ml:leukocytes, .fn=as.numeric))|>
  mutate(across(crp_mg_ml:leukocytes, .fn=log2))|>
  tidyr::pivot_wider(
    id_cols = c(id, timepoint),
    names_from = time_within_day,
    values_from = c(crp_mg_ml, 
                    il_1_ra_calc_conc_mean_pg_m_l, 
                    il_6_calc_conc_mean_pg_m_l, 
                    il_6_r_calc_conc_mean_pg_m_l, 
                    il_10_calc_conc_mean_pg_m_l, 
                    ifn_gamma_calc_conc_mean_pg_m_l,
                    leukocytes))

mat_dim<-
  df_dimensions_to_reduce_il10_complete_case|>
  ungroup()|>
    dplyr::select(-id, -timepoint)|>
  as.matrix()

il10 = mat_dim[,c(37:45)]

il10_mfpca_sc<-
  refund::mfpca.sc( 
    Y = il10,
    id = df_dimensions_to_reduce_il10_complete_case$id, 
    visit = df_dimensions_to_reduce_il10_complete_case$timepoint,
    nbasis = 3)
  

df_mfpca_il10 <-
  data.frame(
    id = df_dimensions_to_reduce_il10_complete_case$id,
    timepoint = df_dimensions_to_reduce_il10_complete_case$timepoint,
    il_10_mfpca_score =il10_mfpca_sc$scores$level2
    )


#crp_mfpca_face<-
 # refund::mfpca.face( 
#    Y = crp,
#    id = df_mfpca$id, 
#    visit = df_mfpca$timepoint,
#    knots = 3)


##TODO Tag level 2 scores ud og lav statistik på dem
treat_time<-
  snake_case_Acute_Bout_Data%>%
  group_by(id, timepoint)%>%
  slice(1)%>%
  dplyr::select(
  id, timepoint, treat, treatment
)

df_mfpca<-
  treat_time%>%
  left_join(
    df_mfpca_crp)%>%
  left_join(
    df_mfpca_il6)%>%
  left_join(
    df_mfpca_il6r)%>%
  left_join(
    df_mfpca_il10)

##CRP
crp_mfpca_score_lmm<-
  lmm(
    crp_mfpca_score ~ timepoint + treat + timepoint:treat,
    repetition = ~ timepoint|id,
    structure = "UN",
    data = df_mfpca
  )

summary(crp_mfpca_score_lmm)
##IL10
il10_mfpca_score_lmm<-
  lmm(
    il_10_mfpca_score ~ timepoint + treat + timepoint:treat,
    repetition = ~ timepoint|id,
    structure = "UN",
    data = df_mfpca
  )

plot(il10_mfpca_score_lmm, type = "qqplot")
plot(il10_mfpca_score_lmm, col = "treatment", obs.alpha = 0.02)
summary(il10_mfpca_score_lmm)

#IL6
IL6_score1_mfpca_score_lmm<-
  lmm(
    il_6_mfpca_score.1 ~ timepoint + treat + timepoint:treat,
    repetition = ~ timepoint|id,
    structure = "UN",
    data = df_mfpca
  )

plot(IL6_score1_mfpca_score_lmm, type = "qqplot")
plot(IL6_score1_mfpca_score_lmm, col = "treatment", obs.alpha = 0.02)
summary(IL6_score1_mfpca_score_lmm)

IL6_score2_mfpca_score_lmm<-
  lmm(
    il_6_mfpca_score.2 ~ timepoint + treat + timepoint:treat,
    repetition = ~ timepoint|id,
    structure = "UN",
    data = df_mfpca
  )

plot(IL6_score2_mfpca_score_lmm, type = "qqplot")
plot(IL6_score2_mfpca_score_lmm, col = "treatment", obs.alpha = 0.02)
summary(IL6_score2_mfpca_score_lmm)

#IL6r 
IL6r_score1_mfpca_score_lmm<-
  lmm(
    il_6r_mfpca_score.1 ~ timepoint + treat + timepoint:treat,
    repetition = ~ timepoint|id,
    structure = "UN",
    data = df_mfpca
  )

summary(IL6r_score1_mfpca_score_lmm)

IL6r_score2_mfpca_score_lmm<-
  lmm(
    il_6r_mfpca_score.2 ~ timepoint + treat + timepoint:treat,
    repetition = ~ timepoint|id,
    structure = "UN",
    data = df_mfpca
  )

summary(IL6r_score2_mfpca_score_lmm)



```

##Fit with Cubic Splines Using Pracma

```{r eval = F}

#install.packages("pracma")
library(pracma)

#out_vec<-vector(1:nrow(snake_case_Acute_Bout_Data))

df_cub_spline<-
  snake_case_Acute_Bout_Data%>%
  group_by(id, timepoint)%>%
  dplyr::summarize(
    crp_cubi = cubicspline(
      x=continous_time_within_day,
      y=crp_mg_ml,
      xi = -5:105
      #xi = min(continous_time_within_day):max(continous_time_within_day)
    )
  )

df_cub_spline%>%
  dplyr::filter(
    id == "lup_008",
    timepoint == "baseline - acute bout" 
  )%>%
  ggplot(aes(x=-5:105, y = crp_cubi))+
  geom_line()+
  geom_point(
    inherit.aes=F,
    data = snake_case_Acute_Bout_Data|>
      dplyr::filter(
    id == "lup_008",
    timepoint == "baseline - acute bout" 
  ),
  aes( x= continous_time_within_day, y = crp_mg_ml, col = "hotpink")
  )
```

#### Using Gam

Outcomes to test:

crp_mg_ml, il_1_ra_calc_conc_mean_pg_m_l, il_6_calc_conc_mean_pg_m_l, il_6_r_calc_conc_mean_pg_m_l, il_10_calc_conc_mean_pg_m_l, ifn_gamma_calc_conc_mean_pg_m_l,

```{r}

library(mgcv)

snake_case_Acute_Bout_Data<-
  snake_case_Acute_Bout_Data%>%
  mutate(
    id_fix = factor( id)
  )

#IL_6
gam_il6_main <- 
  gam(
  il_6_calc_conc_mean_pg_m_l ~ 
    timepoint + 
    treat:timepoint +
    sex +
    s(continous_time_within_day, bs = "cs", k = 6)+
    s(id_fix, bs = "re"),
  data = snake_case_Acute_Bout_Data
)
summary(gam_il6_main)
plot(gam_il6_main)

gam_il6_interaction <- 
  gam(
  il_6_calc_conc_mean_pg_m_l ~ 
    timepoint + 
    treat:timepoint +
    ifn_1_netto + 
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treat+
    sex +
    s(continous_time_within_day, bs = "cs", k = 6)+
    s(id_fix, bs = "re"),
  data = snake_case_Acute_Bout_Data
)
summary(gam_il6_interaction)
plot(gam_il6_interaction)
plot(gam_il6_interaction, residuals = T)

gam_il6_interaction$model%>%
  ggplot(
    aes( y = il_6_calc_conc_mean_pg_m_l, 
         x = continous_time_within_day,
         shape  =timepoint,
         color = treat, 
         group = id_fix)
  )+
  geom_point()


gam_il6_interaction_different_model <- 
   gam(
  il_6_calc_conc_mean_pg_m_l ~ 
    timepoint + 
    treat:timepoint +
    ifn_1_netto + 
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treat+
    sex +
    s(continous_time_within_day, bs = "cs", k = 6)+
    s(id_fix,continous_time_within_day, bs = "re"),
  data = snake_case_Acute_Bout_Data
)
summary(gam_il6_interaction_different_model)
plot(gam_il6_interaction_different_model)
plot(gam_il6_interaction_different_model, residuals = T)

#GAMM il_6

gamm_il6_main <- 
  gamm(
  il_6_calc_conc_mean_pg_m_l ~ 
    timepoint + 
    treatment:timepoint +
    sex +
    s(continous_time_within_day, bs = "cs", k = 6),
  random = list(id_fix = ~1  ),
  data = snake_case_Acute_Bout_Data
)
summary(gamm_il6_main$lme)
summary(gamm_il6_main$gam)
plot(gamm_il6_main$gam)
plot(gamm_il6_main$lme)

gamm_il6_interaction <- 
  gamm(
  il_6_calc_conc_mean_pg_m_l ~ 
    timepoint + 
    treatment:timepoint +
    ifn_1_netto + 
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treatment+
    sex +
    s(continous_time_within_day, bs = "cs", k = 6),
  random = list(id_fix = ~1  ),
  data = snake_case_Acute_Bout_Data
)
summary(gamm_il6_interaction$lme)
summary(gamm_il6_interaction$gam)
plot(gamm_il6_interaction$gam)
plot(gamm_il6_interaction$lme)

#IL_6_R
gam_il6_r_main <- 
  gam(
  il_6_r_calc_conc_mean_pg_m_l ~ 
    timepoint + 
    treat:timepoint +
    sex +
    s(continous_time_within_day, bs = "cs", k = 6)+
    s(id_fix, bs = "re"),
  data = snake_case_Acute_Bout_Data
)
summary(gam_il6_r_main)
plot(gam_il6_r_main)

gam_il6_r_interaction <- 
  gam(
  il_6_r_calc_conc_mean_pg_m_l ~ 
    timepoint + 
    treat:timepoint +
    ifn_1_netto + 
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treat+
    sex +
    s(continous_time_within_day, bs = "cs", k = 9)+
    s(id_fix, bs = "re"),
  data = snake_case_Acute_Bout_Data
)
summary(gam_il6_r_interaction)
plot(gam_il6_r_interaction)
gam.check(gam_il6_r_interaction)

#GAMM il_6_r

gamm_il6_r_main <- 
  gamm(
  il_6_r_calc_conc_mean_pg_m_l ~ 
    timepoint + 
    treatment:timepoint +
    sex +
    s(continous_time_within_day, bs = "cs", k = 9),
  random = list(id_fix = ~1  ),
  data = snake_case_Acute_Bout_Data
)
summary(gamm_il6_r_main$lme)
summary(gamm_il6_r_main$gam)
plot(gamm_il6_r_main$gam)
plot(gamm_il6_r_main$lme)

gamm_il6_r_interaction <- 
  gamm(
  il_6_r_calc_conc_mean_pg_m_l ~ 
    timepoint + 
    treatment:timepoint +
    ifn_1_netto + 
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treatment+
    sex +
    s(continous_time_within_day, bs = "cs", k = 6),
  random = list(id_fix = ~1  ),
  data = snake_case_Acute_Bout_Data
)
summary(gamm_il6_r_interaction$lme)
summary(gamm_il6_r_interaction$gam)
plot(gamm_il6_r_interaction$gam)
plot(gamm_il6_r_interaction$lme)


#IL_1_ra
gam_il1_ra_main <- 
  gam(
  il_1_ra_calc_conc_mean_pg_m_l ~ 
    timepoint + 
    treat:timepoint +
    sex +
    s(continous_time_within_day, bs = "cs", k = 3)+
    s(id_fix, bs = "re"),
  data = snake_case_Acute_Bout_Data
)
summary(gam_il1_ra_main)
plot(gam_il1_ra_main)
vis.gam(gam_il1_ra_main)
gam.check(gam_il1_ra_main)

gam_il1_ra_interaction <- 
  gam(
  il_1_ra_calc_conc_mean_pg_m_l ~ 
    timepoint + 
    treat:timepoint +
    ifn_1_netto + 
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treat+
    sex +
    s(continous_time_within_day, bs = "cs", k = 6)+
    s(id_fix, bs = "re"),
  data = snake_case_Acute_Bout_Data
)
summary(gam_il1_ra_interaction)
plot(gam_il1_ra_interaction)
vis.gam(gam_il1_ra_interaction)
gam.check(gam_il1_ra_interaction)
##Gam CRP
gam_crp_main <- 
  gam(
  crp_mg_ml ~ 
    timepoint + 
    treat:timepoint +
    sex +
    s(continous_time_within_day, bs = "cs", k = 4)+
    s(id_fix, bs = "re"),
  data = snake_case_Acute_Bout_Data
)
summary(gam_crp_main)
plot(gam_crp_main)
vis.gam(gam_crp_main)
gam.check(gam_crp_main)

gam_crp_interaction <- 
  gam(
  crp_mg_ml ~ 
    timepoint + 
    treat:timepoint +
    ifn_1_netto + 
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treat+
    sex +
    s(continous_time_within_day, bs = "cs", k = 4)+
    s(id_fix, bs = "re"),
  data = snake_case_Acute_Bout_Data
)
summary(gam_crp_interaction)
plot(gam_crp_interaction)
vis.gam(gam_crp_interaction)
gam.check(gam_crp_interaction)

##il_10_calc_conc_mean_pg_m_l, 
gam_il10_main <- 
  gam(
  il_10_calc_conc_mean_pg_m_l ~ 
    timepoint + 
    treat:timepoint +
    sex +
    s(continous_time_within_day, bs = "cs", k = 6)+
    s(id_fix, bs = "re"),
  data = snake_case_Acute_Bout_Data
)
summary(gam_il10_main)
plot(gam_il10_main)
vis.gam(gam_il10_main)
gam.check(gam_il10_main)

gam_il10_interaction <- 
  gam(
  il_10_calc_conc_mean_pg_m_l ~ 
    timepoint + 
    treat:timepoint +
    ifn_1_netto + 
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treat+
    sex +
    s(continous_time_within_day, bs = "cs", k = 6)+
    s(id_fix, bs = "re"),
  data = snake_case_Acute_Bout_Data
)
summary(gam_il10_interaction)
plot(gam_il10_interaction)
vis.gam(gam_il10_interaction)
gam.check(gam_il10_interaction)
##gam ifn_gamma_calc_conc_mean_pg_m_l,

gam_ifnG_main <- 
  gam(
  ifn_gamma_calc_conc_mean_pg_m_l ~ 
    timepoint + 
    treat:timepoint +
    sex +
    s(continous_time_within_day, bs = "cs", k = 6)+
    s(id_fix, bs = "re"),
  data = snake_case_Acute_Bout_Data
)
summary(gam_ifnG_main)
plot(gam_ifnG_main)
vis.gam(gam_ifnG_main)
gam.check(gam_ifnG_main)

gam_ifnG_interaction <- 
  gam(
  ifn_gamma_calc_conc_mean_pg_m_l ~ 
    timepoint + 
    treat:timepoint +
    ifn_1_netto + 
    ifn_1_netto:timepoint+
    ifn_1_netto:timepoint:treat+
    sex +
    s(continous_time_within_day, bs = "cs", k = 6)+
    s(id_fix, bs = "re"),
  data = snake_case_Acute_Bout_Data
)
summary(gam_ifnG_interaction)
plot(gam_ifnG_interaction)
vis.gam(gam_ifnG_interaction)
gam.check(gam_ifnG_interaction)
```

#The End

```{r}
Print("This is the end of AcuteExerciseBoutOutcomes")
#install.packages("beepr")
beepr::beep(sound = "complete")
```

## Deprecated Code

##Graphics On summary Statistics

```{r eval = F}
##For Loop
for(variable in variables_to_summarize){
  graph <- 
  sum_stat_loop|>
  dplyr::filter(
    outcome == variable
  )|>
  ggplot(
  aes(
    x = time_within_day,
    y = mean,
    group = treat,
    color = treat
    )
  )+
    ylab(variable)+
  geom_point(position = position_dodge(0.05))+
  geom_line(position = position_dodge(0.05))+
  geom_errorbar(aes(ymin=mean-1.96*sd/sqrt(observed), ymax=mean+1.96*sd/sqrt(observed)), width=.2,
                 position=position_dodge(0.05))+
  facet_wrap(
    ~timepoint
  )
  assign(
    x= paste0("sum_stat_plot_",variable),
    value = graph)
  
}
sum_stat_plot_nk_lymphocytes<-
  sum_stat_loop|>
  dplyr::filter(
    outcome == "nk_lymphocytes"
  )|>
  dplyr::filter(
    time_within_day %in% c("-5","14","35","105")
  )|>
  ggplot(
  aes(
    x = time_within_day,
    y = mean,
    group = treat,
    color = treat
    )
  )+
    ylab("nk_lymphocytes")+
  geom_point(position = position_dodge(0.05))+
  geom_line(position = position_dodge(0.05))+
  geom_errorbar(aes(ymin=mean-1.96*sd/sqrt(observed), ymax=mean+1.96*sd/sqrt(observed)), width=.2,
                 position=position_dodge(0.05))+
  facet_wrap(
    ~timepoint
  )
sum_stat_plot_nk_lymphocytes

sum_stat_plot_il_6_calc_conc_mean_pg_m_l
sum_stat_plot_il_6_r_calc_conc_mean_pg_m_l
sum_stat_plot_ferritin
sum_stat_plot_beta_2_mikroglobuline


sum_stat_loop$cont_time_within_day <- as.numeric(as.character(sum_stat_loop$time_within_day))

sum_stat_loop%>%
  dplyr::filter(
    outcome == "il_6_calc_conc_mean_pg_m_l"
  )|>
  ggplot(
  aes(
    x = cont_time_within_day,
    y = mean,
    group = treat,
    color = treat
    )
  )+
    ylab("il_6_calc_conc_mean_pg_m_l")+
  geom_point(position = position_dodge(0.05))+
  geom_line(position = position_dodge(0.05))+
  geom_errorbar(aes(ymin=mean-1.96*sd/sqrt(observed), ymax=mean+1.96*sd/sqrt(observed)), width=.2,
                 position=position_dodge(0.05))+
  facet_wrap(
    ~timepoint
  )
```

```{r eval = F}
#Log transformed data


log2_sum_stat_loop_init <-
  LMMstar::summarize(  formula=
                                    reformulate(termlabels = "timepoint + treat + time_within_day", 
                                                response = paste0(variables_to_summarize[1],"+",variables_to_summarize[2]),
                                                intercept = TRUE, env = parent.frame()),
                                   data = log2_snake_case_Acute_Bout_Data, na.rm=T)

log2_sum_stat_loop<-
  log2_sum_stat_loop_init

for(variable in variables_to_summarize[-c(1:2)]  ){
  sum_sub <- LMMstar::summarize(  formula=
                                    reformulate(termlabels = "timepoint + treat + time_within_day", 
                                                response = variable, intercept = TRUE, env = parent.frame()),
                                   data = log2_snake_case_Acute_Bout_Data, na.rm=T)
  
  log2_sum_stat_loop<-
    rbind(log2_sum_stat_loop,
        sum_sub)
}

back_convert_log2_sum_stat_loop<-
  log2_sum_stat_loop|>
  rowwise()|>
  mutate(
    mean_minus_sd = mean - sd,
    mean_plus_sd = mean + sd,
    LCI_95 = mean-1.96*sd/sqrt(observed),
    UCI_95 = mean+1.96*sd/sqrt(observed),
    across( c(mean, min:UCI_95), ~ 2^.x))

back_convert_log2_sum_stat_loop|>
  dplyr::filter(
    outcome == "crp_mg_ml"
  )|>
  ggplot(
  aes(
    x = time_within_day,
    y = mean,
    group = treat,
    color = treat,
    shape = outcome
    )
  )+
    ylab("")+
  geom_point(position = position_dodge(0.05))+
  geom_line(position = position_dodge(0.05))+
  geom_errorbar(aes(ymin=LCI_95, ymax=UCI_95, width=.2),
                 position=position_dodge(0.05))+
  facet_wrap(
    outcome~timepoint
  )
```

## GAM models in loop wont work because I dont know how to specify bs in this case

```{r eval = F}

outcomes_to_test <- c("crp_mg_ml", "il_1_ra_calc_conc_mean_pg_m_l", "il_6_calc_conc_mean_pg_m_l", "il_6_r_calc_conc_mean_pg_m_l", "il_10_calc_conc_mean_pg_m_l", "ifn_gamma_calc_conc_mean_pg_m_l")

for(outcome in outcomes_to_test){
  gam_main <- 
  gam(
    formula = reformulate(
      termlabels = "timepoint + 
    treat:timepoint +
    sex +
    s(continous_time_within_day, bs = `cs`, k = 6)+
    s(id_fix, bs = `re`)",
      reponse = outcome
    )
  il_6_r_calc_conc_mean_pg_m_l ~ 
    timepoint + 
    treat:timepoint +
    sex +
    s(continous_time_within_day, bs = "cs", k = 6)+
    s(id_fix, bs = "re"),
  data = snake_case_Acute_Bout_Data
)
summary(gam_main)
plot(gam_main)
  
  
}
```

```{r eval = F}


this.is.new<-data.frame(
  continous_time_within_day = -5:105
)

  dat <-
      snake_case_Acute_Bout_Data%>%
      dplyr::filter(
    id == "lup_040",
    timepoint == "baseline - acute bout" 
  )
  func<-mgcv::gam(crp_mg_ml ~ s(as.numeric(continous_time_within_day), 
                                bs = "cr", k = 3), data = dat)
plot(func)
#points(y = dat$crp_mg_ml, x = dat$continous_time_within_day, pch = 19, col = "hotpink")

this.is.new$test<-
  predict(func, newdata = this.is.new)

snake_case_Acute_Bout_Data%>%
      dplyr::filter(
    id == "lup_040",
    timepoint == "baseline - acute bout" 
  )%>%
ggplot(aes(x = continous_time_within_day, y = crp_mg_ml))+
  geom_point()+
  geom_line(inherit.aes = F, aes( x = continous_time_within_day, y = test), 
            data =this.is.new )

this.is.new<-data.frame(
  continous_time_within_day = -5:105
)

out_data<-
  data.frame(
  id = snake_case_Acute_Bout_Data$id,
  timepoint = snake_case_Acute_Bout_Data$timepoint,
  crp = t(this.is.new$test)
)%>%
  group_by(
    id, timepoint
  )%>%
  slice(1)

for(i in out_data$id){
  for(time in out_data$timepoint){
    
   dat <-
      snake_case_Acute_Bout_Data%>%
      dplyr::filter(
    id == i,
    timepoint == time
  )
  func<-mgcv::gam(crp_mg_ml ~ s(as.numeric(continous_time_within_day), 
                                bs = "cr", k = 3), data = dat)
  
  
  predictedvalues<- predict(
    func, newdata = this.is.new
  )
  
  out_data<-
    out_data%>%
    mutate(
      crp = case_when(id == i & timepoint == time ~ t(predictedvalues),
                      T~crp)
    )
 
  
  }
  
  
}
  
#mgcv::gam
 
#gam(y ~ s(x, bs = "cr", fx = TRUE))
 
#gam$fitted.values
 
```

### Test Followup model

```{r eval = F}

log2_IL_6_Acute_bout_main_followup<-
  lmm(
  formula = 
    il_6_calc_conc_mean_pg_m_l ~ 
    #sex+
    treat+
    time_within_day+
    time_within_day:treat,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_followup
)


summary(log2_IL_6_Acute_bout_main_followup)
plot(log2_IL_6_Acute_bout_main_followup, type = "qqplot")
plot(log2_IL_6_Acute_bout_main_followup, type = "scatterplot")
plot(log2_IL_6_Acute_bout_main_followup, type = "scatterplot2")
mt_log2_il_6_FU<-model.tables(log2_IL_6_Acute_bout_main_followup)
mt_log2_il_6_FU$time_within_day<-
                  factor(c("-5",
                            "0",
                            "10",
                            "14",
                            "35",
                            "45",
                            "60",
                            "90",
                            "105"),
                         levels = 
                           c("-5",
                            "0",
                            "10",
                            "14",
                            "35",
                            "45",
                            "60",
                            "90",
                            "105"))

generalized_lin_log2_IL_6_followup<-
  glht(log2_IL_6_Acute_bout_main_followup, linfct=Cont_vec_followup)
sum<-summary(generalized_lin_log2_IL_6_followup, test=adjusted("none"))



glht_lin_log_2_table<-
  multcomp2table(log2_IL_6_Acute_bout_main_followup,
               transform = back2,
               method = "glht",
               method.multcomp="none",
               link=c("(Intercept)=0",
                      "time_within_day0=0",
                      "time_within_day10=0",
                      "time_within_day14=0",
                      "time_within_day35=0",
                      "time_within_day45=0",
                      "time_within_day60=0",
                      "time_within_day90=0",
                      "time_within_day105=0",
                      "treatexercise=0",
                      "treatexercise+treatexercise:time_within_day0=0",
                      "treatexercise+treatexercise:time_within_day10=0",
                      "treatexercise+treatexercise:time_within_day14=0",
                      "treatexercise+treatexercise:time_within_day35=0",
                      "treatexercise+treatexercise:time_within_day45=0",
                      "treatexercise+treatexercise:time_within_day60=0",
                      "treatexercise+treatexercise:time_within_day90=0",
                      "treatexercise+treatexercise:time_within_day105=0"
                      )
               )%>%
  mutate(
    time_within_day =  rep(factor(c("-5",
                            "0",
                            "10",
                            "14",
                            "35",
                            "45",
                            "60",
                            "90",
                            "105"),
                         levels = 
                           c("-5",
                            "0",
                            "10",
                            "14",
                            "35",
                            "45",
                            "60",
                            "90",
                            "105")
      
  ),2),
  continous_time_within_day = as.numeric(as.character(time_within_day)))

estimated_glht_lin_log_2_table<-
  multcomp2table(log2_IL_6_Acute_bout_main_followup,
               transform = back2,
               method = "glht",
               method.multcomp="none",
               link=c("(Intercept)=0",
                      "(Intercept)+time_within_day0=0",
                      "(Intercept)+time_within_day10=0",
                      "(Intercept)+time_within_day14=0",
                      "(Intercept)+time_within_day35=0",
                      "(Intercept)+time_within_day45=0",
                      "(Intercept)+time_within_day60=0",
                      "(Intercept)+time_within_day90=0",
                      "(Intercept)+time_within_day105=0",
                      "(Intercept)+treatexercise=0",
                      "(Intercept)+time_within_day0+treatexercise+treatexercise:time_within_day0=0",
                      "(Intercept)+time_within_day10+treatexercise+treatexercise:time_within_day10=0",
                      "(Intercept)+time_within_day14+treatexercise+treatexercise:time_within_day14=0",
                      "(Intercept)+time_within_day35+treatexercise+treatexercise:time_within_day35=0",
                      "(Intercept)+time_within_day45+treatexercise+treatexercise:time_within_day45=0",
                      "(Intercept)+time_within_day60+treatexercise+treatexercise:time_within_day60=0",
                      "(Intercept)+time_within_day90+treatexercise+treatexercise:time_within_day90=0",
                      "(Intercept)+time_within_day105+treatexercise+treatexercise:time_within_day105=0"
                      )
               )%>%
  mutate(
    time_within_day =  rep(factor(c("-5",
                            "0",
                            "10",
                            "14",
                            "35",
                            "45",
                            "60",
                            "90",
                            "105"),
                         levels = 
                           c("-5",
                            "0",
                            "10",
                            "14",
                            "35",
                            "45",
                            "60",
                            "90",
                            "105")
      
  ),2),
  continous_time_within_day = as.numeric(as.character(time_within_day)),
  treat = c(rep("control",9),rep("exercise",9)))

il6_plot_followup_with_data_points<-
  estimated_glht_lin_log_2_table%>%
  ggplot(
    aes ( x=continous_time_within_day, y =Estimate, ymin = Lower, ymax = Upper, group = treat)
  )+
  geom_line(aes(col = treat))+
  geom_errorbar(aes(col = treat), position = position_dodge(1))+
  geom_point(inherit.aes = F, data = snake_case_Acute_Bout_Data, 
             aes(x = continous_time_within_day, y = il_6_calc_conc_mean_pg_m_l, group = id, colour = treat), position = position_jitter(2), alpha = 0.2)+
  labs(
    x = "Time after bout inititaion",
    y = "Il-6 pg/ml"
  )

il6_plot_followup_with_data_points%>%
  ggplotly(
    
  )

```

### For Loop followup Models

```{r eval =F }
outcomes <- c("il_6_calc_conc_mean_pg_m_l","il_6_r_calc_conc_mean_pg_m_l", 
              "crp_mg_ml","beta_2_mikroglobuline",
              "hemoglobin", "leukocytes", 
              "thrombocytes", "ifn_gamma_calc_conc_mean_pg_m_l",
              #"il_1_a_calc_conc_mean_pg_m_l",
              "il_1_ra_calc_conc_mean_pg_m_l","il_10_calc_conc_mean_pg_m_l",
              "il_2_calc_conc_mean_pg_m_l","tnf_calc_conc_mean_pg_m_l"             )



for(outcome in outcomes){
  
  model<-
lmm(
  formula = reformulate(
    termlabels = 
    "treat+
    time_within_day+
    time_within_day:treat",
    response = outcome
  ),
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = log2_snake_case_Acute_Bout_Data_followup
)
  
  generalized<-
  glht(model, 
       linfct=Cont_vec_followup)
  
    CI_glht <-
  confint(generalized, 
          #test=adjusted("none"), 
          level = 0.95) 

  CI_backtransform<-
  round(2^as_tibble(CI_glht$confint),2)
  
  CI_backtransform$time_within_day<-
                  factor(
                    c(  "-5",
                         "0",
                        "10",
                        "14",
                        "35",
                        "45",
                        "60",
                        "90",
                        "105"),
                         levels = 
                        c("-5",
                           "0",
                          "10",
                          "14",
                          "35",
                          "45",
                          "60",
                          "90",
                          "105"))
  CI_backtransform$contrast <-
  c(rep("control",9 ),
    rep("exercise",9),
    rep("exericse / control ratio", 9))

  
  mt <- model.tables(model)
  mt$time_within_day<-
                  factor(c("-5",
                            "0",
                            "10",
                            "14",
                            "35",
                            "45",
                            "60",
                            "90",
                            "105"),
                         levels = 
                           c("-5",
                            "0",
                            "10",
                            "14",
                            "35",
                            "45",
                            "60",
                            "90",
                            "105"))
  
mt_p_values <- 
  mt|>
   mutate(
     p_lab = case_when(p.value >0.9999 ~ "p > 0.9999",
                      p.value <0.0001 ~ "p < 0.0001*",
                     T~ paste0("p = ",round(p.value, 3), 
                              ifelse(p.value<0.05, "*",""))
                 ))|>
dplyr::select(
 time_within_day,
  p.value,
  p_lab
)
  
  out_model<-
    CI_backtransform%>%
      left_join(mt_p_values, by=join_by(time_within_day))|>
        mutate(
          outcome = outcome
              )|>
    relocate(
      outcome, time_within_day
    )
  
  assign(
    x = paste0("lmm_log",outcome,"table_for_plot"),
    value = out_model
  )
  
  models.baseline.df<-
    models.baseline.df|>
    rbind(out_model)
}

saveRDS(models.baseline.df,
        file = here(
          "Output",
          "Acute Bout",
          "RDS_Models",
          "models_baseline_df.rds"
        ))
beepr::beep(sound=5)
```

```{r eval =F}
IL_6_r_Acute_bout_main_baseline<-
lmm(
  formula = 
    il_6_calc_conc_mean_pg_m_l ~ 
    #sex+
    #treat+
    time_within_day,
    #timepoint_time_within_day+
    #timepoint_time_within_day:treat,
  repetition = ~ time_within_day|id,
  structure = "UN",
   method.fit="REML",
  data = snake_case_Acute_Bout_Data_baseline
)
summary(IL_6_r_Acute_bout_main_baseline)
plot(IL_6_r_Acute_bout_main_baseline)

saveRDS(
  list_baseline_acute_bout_large_lmm <-
    list(
      IL_6_Acute_bout_main_baseline,
      IL_6_r_Acute_bout_main_baseline
    )
)
```

```{r eval = F}
#CRP_Acute_bout_main<-lmm(
#  formula = 
#    crp_mg_ml ~ 
#    sex+
#    timepoint+
#    timepoint:treat+
#    time_within_day+
#    timepoint_time_within_day+
#    timepoint_time_within_day:treat,
#  repetition = ~ timepoint_time_within_day|id,
#  structure = "UN",
#   method.fit="REML",
#  data = Acute_Bout_Data
#)

#summary(CRP_Acute_bout_main)

#CRP_Acute_bout_main<-lmm(
#  formula = 
#    crp_mg_ml ~ 
#    sex+
#    timepoint_time_within_day+
#    timepoint_time_within_day:treat,
#  repetition = ~ timepoint_time_within_day|id,
#  structure = "UN",
#   method.fit="REML",
#  data = Acute_Bout_Data
#)

#summary(CRP_Acute_bout_main)

#LMMStar doesn't really converge



time2 <- Sys.time()
lmer_vers<-
  lmer(
  crp_mg_ml ~ 
    sex+
    treat+
    time_within_day+
    time_within_day:treat+
    (1|id),
  data = Acute_Bout_Data_followup
)
plot(lmer_vers)
Anova(lmer_vers)
summary(lmer_vers)

time3 <- Sys.time()
time3-time2

lmer_vers_no_outlier<-lmer(
  crp_mg_ml ~ 
    sex+
    timepoint+
    timepoint:treat+
    time_within_day+
    timepoint:time_within_day+
    timepoint:time_within_day:treat+
    (timepoint|id)+
    (time_within_day|timepoint),
  data = Acute_Bout_Data|>
    dplyr::filter(
    id !="lup_031"
  )
)
plot(lmer_vers_no_outlier)
Anova(lmer_vers_no_outlier)
summary(lmer_vers_no_outlier)

lmer_vers_IL6<-lmer(
  `IL-6 Calc. Conc. Mean (pg/mL)` ~ 
    sex+
    timepoint+
    timepoint:treat+
    time_within_day+
    timepoint:time_within_day+
    timepoint:time_within_day:treat+
    (timepoint|id)+
    (time_within_day|timepoint),
  data = Acute_Bout_Data
)
plot(lmer_vers_IL6)
Anova(lmer_vers_IL6)
summary(lmer_vers_IL6)

lmer_vers_sIL6r<-lmer(
  `IL-6R Calc. Conc. Mean (pg/mL)` ~ 
    sex+
    timepoint+
    timepoint:treat+
    time_within_day+
    timepoint:time_within_day+
    timepoint:time_within_day:treat+
    (timepoint|id)+
    (time_within_day|timepoint),
  data = Acute_Bout_Data)
plot(lmer_vers_sIL6r)
Anova(lmer_vers_sIL6r)
summary(lmer_vers_sIL6r)


lmer_vers_sIL6r<-lmer(
  `IL-6R Calc. Conc. Mean (pg/mL)` ~ 
    sex+
    timepoint+
    timepoint:treat+
    time_within_day+
    timepoint:time_within_day+
    timepoint:time_within_day:treat+
    (timepoint|id)+
    (time_within_day|timepoint),
  data = Acute_Bout_Data)
plot(lmer_vers_sIL6r)
Anova(lmer_vers_sIL6r)
summary(lmer_vers_sIL6r)

```
